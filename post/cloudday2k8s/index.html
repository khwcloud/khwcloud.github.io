<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>cloud,day2,k8s - blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="khw" /><meta name="description" content="Kubernetes 是一个开源的，用于管理云平台中多个主机上的容器化的应用。
" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.100.1 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/cloudday2k8s/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.8c3cbcb0324c2bb4875ceccba4007cbad4b4ac8377f33af9953c3e7684534a50.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="cloud,day2,k8s" />
<meta property="og:description" content="Kubernetes 是一个开源的，用于管理云平台中多个主机上的容器化的应用。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/cloudday2k8s/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-05-15T11:06:25+08:00" />
<meta property="article:modified_time" content="2022-05-15T11:06:25+08:00" />

<meta itemprop="name" content="cloud,day2,k8s">
<meta itemprop="description" content="Kubernetes 是一个开源的，用于管理云平台中多个主机上的容器化的应用。"><meta itemprop="datePublished" content="2022-05-15T11:06:25+08:00" />
<meta itemprop="dateModified" content="2022-05-15T11:06:25+08:00" />
<meta itemprop="wordCount" content="29826">
<meta itemprop="keywords" content="k8s," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="cloud,day2,k8s"/>
<meta name="twitter:description" content="Kubernetes 是一个开源的，用于管理云平台中多个主机上的容器化的应用。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">类别</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">类别</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">cloud,day2,k8s</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-05-15 </span>
        <div class="post-category">
            <a href="/categories/%E4%BA%91/"> 云 </a>
            </div>
          <span class="more-meta"> 29826 words </span>
          <span class="more-meta"> 60 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-kubernetes基础概念">1 kubernetes基础概念</a></li>
        <li><a href="#2-k8s安装">2 k8s安装</a></li>
        <li><a href="#3-运行第一个pod">3 运行第一个pod</a>
          <ul>
            <li><a href="#31-实验一">3.1 实验一</a></li>
            <li><a href="#32-实验二">3.2 实验二</a></li>
          </ul>
        </li>
        <li><a href="#4-pod资源清单">4 pod资源清单</a>
          <ul>
            <li><a href="#41-pod资源定义入门">4.1 pod资源定义入门</a></li>
            <li><a href="#42-pod资源定义进阶">4.2 pod资源定义进阶</a></li>
            <li><a href="#43-pod生命周期">4.3 pod生命周期</a></li>
            <li><a href="#44-pod标签操作">4.4 pod标签操作</a></li>
          </ul>
        </li>
        <li><a href="#5-pod控制器">5 pod控制器</a>
          <ul>
            <li><a href="#51-replicaset">5.1 ReplicaSet</a></li>
            <li><a href="#52-deployment">5.2 Deployment</a></li>
            <li><a href="#53-daemonset">5.3 DaemonSet</a></li>
          </ul>
        </li>
        <li><a href="#6-service资源">6 Service资源</a>
          <ul>
            <li><a href="#61-service代理方式三种">6.1 service代理方式(三种)</a></li>
            <li><a href="#62-创建service资源">6.2 创建service资源</a></li>
          </ul>
        </li>
        <li><a href="#7-ingress和ingress-controller">7 ingress和ingress Controller</a>
          <ul>
            <li><a href="#71-安装-ingress-controller">7.1 安装 ingress Controller</a></li>
            <li><a href="#72--给ingresscontroller创建一个service接入外部流量">7.2  给ingressController创建一个service接入外部流量</a></li>
            <li><a href="#73-案例一nginx">7.3 案例一：nginx</a></li>
            <li><a href="#74-案例二tomcat">7.4 案例二：tomcat</a></li>
          </ul>
        </li>
        <li><a href="#8-存储卷">8 存储卷</a>
          <ul>
            <li><a href="#81-emptydir案例">8.1 emptyDir案例</a></li>
            <li><a href="#82-hostpath案例">8.2 hostPath案例</a></li>
            <li><a href="#83-pvc案例">8.3 pvc案例</a></li>
            <li><a href="#84-configmap">8.4 configmap</a></li>
            <li><a href="#85-secret">8.5 secret</a></li>
          </ul>
        </li>
        <li><a href="#9-statefulset">9 statefulset</a>
          <ul>
            <li><a href="#91-statefulset使用">9.1 statefulset使用</a></li>
          </ul>
        </li>
        <li><a href="#10-k8s认证授权准入控制">10 k8s认证,授权,准入控制</a>
          <ul>
            <li><a href="#101-认证">10.1 认证</a></li>
            <li><a href="#102-rbac-授权">10.2 RBAC 授权</a></li>
            <li><a href="#103-dashboard认证及分级授权">10.3 dashboard认证及分级授权</a></li>
          </ul>
        </li>
        <li><a href="#11-k8s网络">11 k8s网络</a>
          <ul>
            <li><a href="#111-k8s网络通信">11.1 k8s网络通信</a></li>
            <li><a href="#112-flannel">11.2 flannel</a></li>
            <li><a href="#113-canel网络策略">11.3 canel网络策略</a></li>
          </ul>
        </li>
        <li><a href="#12-k8s调度">12 k8s调度</a>
          <ul>
            <li><a href="#121-k8s高级调度">12.1 k8s高级调度</a></li>
          </ul>
        </li>
        <li><a href="#13-k8s资源限制">13 k8s资源限制</a>
          <ul>
            <li><a href="#131-资源限制">13.1 资源限制</a></li>
            <li><a href="#132-资源qos">13.2 资源QOS</a></li>
          </ul>
        </li>
        <li><a href="#14-资源指标api自定义指标api">14 资源指标API，自定义指标API</a>
          <ul>
            <li><a href="#141-metrics-server">14.1 metrics-server</a></li>
            <li><a href="#142-prometheus">14.2 prometheus</a></li>
          </ul>
        </li>
        <li><a href="#15-hpa控制器">15 HPA控制器</a></li>
        <li><a href="#16-helm">16 helm</a>
          <ul>
            <li><a href="#161-helm部署">16.1 helm部署</a></li>
            <li><a href="#162-常用操作">16.2 常用操作</a></li>
            <li><a href="#163-自定义chart">16.3 自定义chart</a></li>
          </ul>
        </li>
        <li><a href="#17-部署efk日志系统">17 部署efk日志系统</a></li>
        <li><a href="#18-常见问题">18 常见问题</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Kubernetes 是一个开源的，用于管理云平台中多个主机上的容器化的应用。</p>
<h2 id="1-kubernetes基础概念">1 kubernetes基础概念</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 1、master
</span></span><span class="line"><span class="cl">    1) API Server: k8s的中心，各个组件信息交互都要通过它，也是k8s管理集群的入口
</span></span><span class="line"><span class="cl">    2) Scheduler: k8s集群的调度器，选择工作 pod 节点，预选 &gt; 优选。
</span></span><span class="line"><span class="cl">    3) Controller-Manager: 集群的状态管理器，保证Pod或其他资源达到期望值，也是需要和APIServer进行通信，在需要的时候创建、更新或删除它所管理的资源。
</span></span><span class="line"><span class="cl">    4) etcd: 负责存储集群中各种资源对象的信息，k/v方式存储，所有的 k8s 集群数据存放在此
</span></span><span class="line"><span class="cl">    5) Kuberctl: 命令行配置工具
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"># 2、node 
</span></span><span class="line"><span class="cl">    1) kubelet: 与 apiserver 交互的核心组件。
</span></span><span class="line"><span class="cl">    2) Kube-Proxy: 负责提供集群内部的服务发现和负载均衡
</span></span><span class="line"><span class="cl">    3) docker: 容器引擎，负责对容器的管理。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 3、pod
</span></span><span class="line"><span class="cl">	- 里面运行着一些容器
</span></span><span class="line"><span class="cl">	1) label：标签，是pod的唯一标识符，key，value格式
</span></span><span class="line"><span class="cl">	2) label-select：表现筛选器
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 4、pod控制器
</span></span><span class="line"><span class="cl">	Kubernetes中内建了很多controller（控制器），这些相当于一个状态机，用来控制Pod的具体状态和行为
</span></span><span class="line"><span class="cl">    1、Deployment：适合无状态的服务部署
</span></span><span class="line"><span class="cl">    2、StatefullSet：适合有状态的服务部署
</span></span><span class="line"><span class="cl">    3、DaemonSet：一次部署，所有的node节点都会部署，例如一些典型的应用场景：
</span></span><span class="line"><span class="cl">    运行集群存储 daemon，例如在每个Node上运行 glusterd、ceph
</span></span><span class="line"><span class="cl">    在每个Node上运行日志收集 daemon，例如 fluentd、 logstash
</span></span><span class="line"><span class="cl">    在每个Node上运行监控 daemon，例如 Prometheus Node Exporter
</span></span><span class="line"><span class="cl">    4、Job：一次性的执行任务
</span></span><span class="line"><span class="cl">    5、Cronjob：周期性的执行任务
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 5、Service
</span></span><span class="line"><span class="cl">	- pod对外服务的统一入口，下面可以维护者同一类的多个pod
</span></span><span class="line"><span class="cl">	- 通过 labels 为应用提供负载均衡和服务发现
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 6、k8s网络
</span></span><span class="line"><span class="cl">	- 三个网络，请求来了由节点网络收到，转发给集群网络，然后再转发到对应的pod里
</span></span><span class="line"><span class="cl">	1) 节点网络
</span></span><span class="line"><span class="cl">	2) service 网络(集群网络)，service只是主机上的iptables中的拒绝规则,由kub-proxy进行管控和生成
</span></span><span class="line"><span class="cl">	3) pod 网络
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 7、pod的通信
</span></span><span class="line"><span class="cl">	- 各个pod之间的地址不能相同
</span></span><span class="line"><span class="cl">	1) 同一个pod内的多个容器间通信：共享了网络空间，直接本地通信
</span></span><span class="line"><span class="cl">	2) 同主机pod之间的通信：二层通信，通过docker0转发
</span></span><span class="line"><span class="cl">	3) 不同主机各pod之间的通信：容器的数据包通过docker0(SNAT)转发到主机网卡，主机网卡再转发到对应的主机上，对应主机收到数据包后再通过DNAT转发给docker0，然后转发给对应的pod
</span></span><span class="line"><span class="cl">	4) pod与service之间的通信：直接将容器的地址指向docker0，docker0转发会先查iptables规则然后转发
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 8、namespace
</span></span><span class="line"><span class="cl">	- 名称空间，将各种pod进行分类管理
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 9、k8s证书
</span></span><span class="line"><span class="cl">	- 先从Etcd算起：
</span></span><span class="line"><span class="cl">    	1) Etcd对外提供服务，要有一套etcd server证书
</span></span><span class="line"><span class="cl">    	2) Etcd各节点之间进行通信，要有一套etcd peer证书
</span></span><span class="line"><span class="cl">    	3) Kube-APIserver访问Etcd，要有一套etcd client证书
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	- 再算kubernetes：
</span></span><span class="line"><span class="cl">    	4) Kube-APIserver对外提供服务，要有一套kube-apiserver server证书
</span></span><span class="line"><span class="cl">		5) kube-scheduler、kube-controller-manager、kube-proxy、kubelet和其他可能用到的组件，需要访问kube-APIserver，要有一套kube-APIserver client证书
</span></span><span class="line"><span class="cl">        6) kube-controller-manager要生成服务的service account，要有一对用来签署service account的证书(CA证书)
</span></span><span class="line"><span class="cl">        7) kubelet对外提供服务，要有一套kubelet server证书
</span></span><span class="line"><span class="cl">        8) kube-APIserver需要访问kubelet，要有一套kubelet client证书
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 10、k8s安装方式
</span></span><span class="line"><span class="cl">	1) 一个个组件的安装
</span></span><span class="line"><span class="cl">	2) kubeadm (把所有组件能运行为容器的全运行为容器，只有kubelet需要单独装在主机上)快速部署
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 10、额外插件add-ons
</span></span><span class="line"><span class="cl">	- 网络插件
</span></span><span class="line"><span class="cl">		1) flannel：网络配置		(使用简单)
</span></span><span class="line"><span class="cl">		2) calico：网络配置，支持网络策略	(使用复杂)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 11、常用资源类型 
</span></span><span class="line"><span class="cl">	workload: Pod,ReplicaSet,Deployment,job,deamonset..
</span></span><span class="line"><span class="cl">	服务发现及均衡：Service, Ingress
</span></span><span class="line"><span class="cl">	配置与存储：Volume，CSI
</span></span><span class="line"><span class="cl">	集群级资源：Namespace，Node，Role，ClusterRole，RoleBinding，ClusterRoleBinding
</span></span><span class="line"><span class="cl">	元数据型资源：HPA,podTemplate，LimitRange
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-k8s安装">2 k8s安装</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">集群规划：
</span></span><span class="line"><span class="cl">	1、网络：
</span></span><span class="line"><span class="cl">        节点网络：172.20.0.0/16
</span></span><span class="line"><span class="cl">        servuce网络：10.96.0.0/12
</span></span><span class="line"><span class="cl">        pod网络：10.244.0.0/16	(该网络也是flannel的默认网络)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    2、集群：
</span></span><span class="line"><span class="cl">    	1) 三节点部署，一个master节点，两个node节点
</span></span><span class="line"><span class="cl">    	2) 三个节点上都部署kubelet，docker
</span></span><span class="line"><span class="cl">		3) master节点上部署API Server，Scheduler，Controller-Manage，etcd 
</span></span><span class="line"><span class="cl">		4) node节点上部署Kube-Proxy 
</span></span><span class="line"><span class="cl">    	5) 各个节点上还要部署flannel插件
</span></span><span class="line"><span class="cl">    	
</span></span><span class="line"><span class="cl">    	
</span></span><span class="line"><span class="cl">    	
</span></span><span class="line"><span class="cl">kubernetes cluster：
</span></span><span class="line"><span class="cl">	环境：
</span></span><span class="line"><span class="cl">		master，etcd：192.168.101.67
</span></span><span class="line"><span class="cl">		node1：192.168.101.68
</span></span><span class="line"><span class="cl">		node2：192.168.101.69
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	前提：
</span></span><span class="line"><span class="cl">		1、基于主机名通信：/etc/hosts
</span></span><span class="line"><span class="cl">		2、时间同步
</span></span><span class="line"><span class="cl">		3、关闭firewalld和iptables.service
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		OS: Centos 7.9.2009
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 详细参考
</span></span><span class="line"><span class="cl">https://blog.csdn.net/Doudou_Mylove/article/details/103901732
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 集群添加节点
</span></span><span class="line"><span class="cl">kubeadm join 192.168.101.67:6443 --token ilp8xc.gqzkv9goeua1cekr \
</span></span><span class="line"><span class="cl">    --discovery-token-ca-cert-hash sha256:30b1b615806e1f9dbb6aaf96f334ec637cb9fd093a501ea35f72ad8c76b97e92
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-运行第一个pod">3 运行第一个pod</h2>
<h3 id="31-实验一">3.1 实验一</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 1、运行第一个pod
</span></span><span class="line"><span class="cl">kubectl run nginx-deploy --image=nginx:1.14-alpine --port=暴露端口 --replicas=创建几个pod --dry-run=是否只创建
</span></span><span class="line"><span class="cl">kubectl run nginx-deploy --image=nginx:1.14-alpine --port=80 --replicas=1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2、查看当前系统上被创建的deployment
</span></span><span class="line"><span class="cl">kubectl get deployment  -w
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3、查看当前系统上pod的详细信息
</span></span><span class="line"><span class="cl">kubectl get pod -o wide
</span></span><span class="line"><span class="cl">kubectl get pods  --show-labels
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 4、删除pod，该pod会被重建，ip地址也会变，所以需要关联service
</span></span><span class="line"><span class="cl">kubectl delete pods nginx-deploy-7689897d8d-k57g4
</span></span><span class="line"><span class="cl">kubectl delete deployment xxx	// 删除deployment这样系统会自动删除pod，并且不拉起
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 5、创建service，service既有ip又有端口，pod也是一样既有ip又有端口
</span></span><span class="line"><span class="cl">kubectl expose deployment pod名称 --name=service名称  --port=pod端口 --target-port=svc端口 --protocol=TCP
</span></span><span class="line"><span class="cl">kubectl expose deployment nginx-deploy --name=nginx  --port=80 --target-port=80 --protocol=TCP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 6、查看service，以及service的详细信息
</span></span><span class="line"><span class="cl">kubectl get svc 
</span></span><span class="line"><span class="cl">kubectl describe svc nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 7、修改service的信息
</span></span><span class="line"><span class="cl">kubectl edit svc nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 8、查看kube-system
</span></span><span class="line"><span class="cl">kubectl get pods -n kube-system -o wide
</span></span><span class="line"><span class="cl">	- 查看svc的dns地址
</span></span><span class="line"><span class="cl">	kubectl get svc -n kube-system
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 9、配置dns解析
</span></span><span class="line"><span class="cl">yum install -y bind-utils
</span></span><span class="line"><span class="cl">dig -t A nginx @10.96.0.10
</span></span><span class="line"><span class="cl">dig -t A nginx.default.svc.cluster.local @10.96.0.10
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 10、创建一个pod客户端
</span></span><span class="line"><span class="cl">kubectl run client --image=busybox --replicas=1 -it --restart=Never
</span></span><span class="line"><span class="cl">	- 查看host文件
</span></span><span class="line"><span class="cl">	cat /etc/resolv.conf
</span></span><span class="line"><span class="cl">	- 测试
</span></span><span class="line"><span class="cl">	wget -O - -q http://nginx:80/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 11、删除pod再测试
</span></span><span class="line"><span class="cl"> kubectl delete pods nginx-deploy-7689897d8d-6p8vp
</span></span><span class="line"><span class="cl"> 	- 到客户端中执行
</span></span><span class="line"><span class="cl"> 	wget -O - -q http://nginx:80/
</span></span><span class="line"><span class="cl">	- 这样一来，pod地址无论如何变，都可以通过nginx来访问服务
</span></span><span class="line"><span class="cl">	
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="32-实验二">3.2 实验二</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 1、创建pod
</span></span><span class="line"><span class="cl">kubectl run myapp --image=ikubernetes/myapp:v1 --replicas=1
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2、给创建的myapp关联svc
</span></span><span class="line"><span class="cl">kubectl expose deployment myapp --name=myapp --port=80 
</span></span><span class="line"><span class="cl">kubectl get svc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3、查看kube-system
</span></span><span class="line"><span class="cl">kubectl get pods -n kube-system -o wide
</span></span><span class="line"><span class="cl">	- 查看svc的dns地址
</span></span><span class="line"><span class="cl">	kubectl get svc -n kube-system
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 4、配置dns解析
</span></span><span class="line"><span class="cl">yum install -y bind-utils
</span></span><span class="line"><span class="cl">dig -t A nginx @10.96.0.10
</span></span><span class="line"><span class="cl">dig -t A nginx.default.svc.cluster.local @10.96.0.10
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 5、创建一个pod客户端
</span></span><span class="line"><span class="cl">kubectl run client --image=busybox --replicas=1 -it --restart=Never
</span></span><span class="line"><span class="cl">	- 查看host文件
</span></span><span class="line"><span class="cl">	cat /etc/resolv.conf
</span></span><span class="line"><span class="cl">	- 测试
</span></span><span class="line"><span class="cl">	while true; do wget -O - -q myapp/hostname.html; sleep 1 ; done
</span></span><span class="line"><span class="cl">	while true; do wget -O - -q myapp; sleep 1 ; done
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 6、动态扩展pod个数
</span></span><span class="line"><span class="cl">kubectl scale --replicas=5 deployment myapp 
</span></span><span class="line"><span class="cl">kubectl get deployment  -w
</span></span><span class="line"><span class="cl">kubectl get pods 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 7、动态缩减pod个数
</span></span><span class="line"><span class="cl">kubectl scale --replicas=3 deployment myapp 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 8、动态升级(灰度升级)
</span></span><span class="line"><span class="cl">kubectl get pods 
</span></span><span class="line"><span class="cl">kubectl describe pods myapp-84cd4b7f95-bqql5
</span></span><span class="line"><span class="cl">- kubectl set image deployment 控制器下的myapp 容器名=镜像
</span></span><span class="line"><span class="cl">	kubectl set image deployment myapp myapp=ikubernetes/myapp:v2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 9、动态回滚
</span></span><span class="line"><span class="cl">kubectl rollout undo deployment myapp 	// 不指定默认回滚上一个版本
</span></span><span class="line"><span class="cl">kubectl get pods 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 10、修改sev type类型
</span></span><span class="line"><span class="cl">kubectl get svc
</span></span><span class="line"><span class="cl">kubectl edit svc myapp
</span></span><span class="line"><span class="cl">	- 将ClusterIP改为NodePort
</span></span><span class="line"><span class="cl">kubectl get svc
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get svc
</span></span><span class="line"><span class="cl">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
</span></span><span class="line"><span class="cl">myapp        NodePort    10.106.49.105   &lt;none&gt;        80:30810/TCP   27m
</span></span><span class="line"><span class="cl">- 宿主机浏览器访问主节点(所有节点都可以，但一台挂了需要手动切换，所以还可以价格负载均衡)
</span></span><span class="line"><span class="cl"> \ ip+端口即可在集群外部访问  
</span></span><span class="line"><span class="cl"> \ 192.168.101.67:30810
</span></span><span class="line"><span class="cl"> 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="4-pod资源清单">4 pod资源清单</h2>
<h3 id="41-pod资源定义入门">4.1 pod资源定义入门</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 1、将pod的信息以yaml输出
</span></span><span class="line"><span class="cl">kubectl get pods nginx-deploy-7689897d8d-n789v -o yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2、创建资源的方法
</span></span><span class="line"><span class="cl">	apiserver仅接收JSON格式的资源定义
</span></span><span class="line"><span class="cl">	yaml格式提供配置清单，apiserver可自动将其转为json格式，然后再提交；
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 3、大部分资源配置清单字段：
</span></span><span class="line"><span class="cl">	apiVersion(group/version)
</span></span><span class="line"><span class="cl">	kind：资源类别
</span></span><span class="line"><span class="cl">	metadata：元数据
</span></span><span class="line"><span class="cl">		name
</span></span><span class="line"><span class="cl">		namespace
</span></span><span class="line"><span class="cl">		labels
</span></span><span class="line"><span class="cl">		annotations
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		每个资源应用PATH
</span></span><span class="line"><span class="cl">/api/GROUP/VERSION/namespaces/NAMESPACE/TYPE/NAME
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	spec：期望状态，distred state，让当前状态无限往期望状态靠近
</span></span><span class="line"><span class="cl">	status：当前状态
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"># 4、定义资源
</span></span><span class="line"><span class="cl"> 	- 查看如何定义，可以一级一级看，只需要.后面更上想看的资源即可
</span></span><span class="line"><span class="cl">	kubectl explain pods.metadata
</span></span><span class="line"><span class="cl">	- 定义资源
</span></span><span class="line"><span class="cl">	vim pod-demo.yaml
</span></span><span class="line"><span class="cl">		apiVersion: v1
</span></span><span class="line"><span class="cl">        kind: Pod
</span></span><span class="line"><span class="cl">        metadata:
</span></span><span class="line"><span class="cl">          name: pod-damo
</span></span><span class="line"><span class="cl">          namespace: default
</span></span><span class="line"><span class="cl">          labels:
</span></span><span class="line"><span class="cl">            app: myapp
</span></span><span class="line"><span class="cl">            tier: frontend
</span></span><span class="line"><span class="cl">        spec:
</span></span><span class="line"><span class="cl">          containers:
</span></span><span class="line"><span class="cl">          - name: myapp
</span></span><span class="line"><span class="cl">            image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">          - name: busybox
</span></span><span class="line"><span class="cl">            image: busybox:latest
</span></span><span class="line"><span class="cl">            command:   
</span></span><span class="line"><span class="cl">            # {&#34;/bin/sh&#34;,&#34;-c&#34;,&#34;sleep 3600&#34;}
</span></span><span class="line"><span class="cl">            - &#34;/bin/sh&#34;
</span></span><span class="line"><span class="cl">            - &#34;-c&#34;
</span></span><span class="line"><span class="cl">            - &#34;sleep 3600&#34;
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl"># 5、基于定义的yaml创建pod
</span></span><span class="line"><span class="cl">kubectl create -f pod-demo.yaml
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">kubectl describe pods pod-damo
</span></span><span class="line"><span class="cl">kubectl logs pod-demo busybox
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 6、删除yaml创建的pod
</span></span><span class="line"><span class="cl">kubectl delete -f pod-demo.yaml 
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="42-pod资源定义进阶">4.2 pod资源定义进阶</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 1、pod资源：
</span></span><span class="line"><span class="cl">	apiVersion(group/version)
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	# 资源类别
</span></span><span class="line"><span class="cl">	kind：Pod			
</span></span><span class="line"><span class="cl">	metadata：			
</span></span><span class="line"><span class="cl">		name: pod-demo		
</span></span><span class="line"><span class="cl">		namespace: default	
</span></span><span class="line"><span class="cl">		labels  # 定义标签，标签要尽量见名知意
</span></span><span class="line"><span class="cl">		  app: myapp
</span></span><span class="line"><span class="cl">		  version: myapp_v2
</span></span><span class="line"><span class="cl">        annontations: # 与label不同的地方，它不能用于挑选资源对象，仅用于为对象提供&#34;元数据&#34;
</span></span><span class="line"><span class="cl">	spec:  # 期望状态
</span></span><span class="line"><span class="cl">	  nodeSelector:	# 节点标签选择器
</span></span><span class="line"><span class="cl">	    disktype: ssd   # 这里直接写节点的标签，key:value,写了之后，该pod会创建在有这个标签的节点上
</span></span><span class="line"><span class="cl">      nodeName:node1    # 指定节点名，表示该pod创建在该node1上
</span></span><span class="line"><span class="cl">      restartPolicy:Always  # 重启策略(Always 总是重启，Onfailure 失败重启，Never 挂了就挂了不重启，默认是always)
</span></span><span class="line"><span class="cl">	  containers:
</span></span><span class="line"><span class="cl">		- name
</span></span><span class="line"><span class="cl">			image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">			ports:  # 表示暴露的端口，即使不写也会自动暴露，但是写了更好管理	
</span></span><span class="line"><span class="cl">			- name: http
</span></span><span class="line"><span class="cl">			  containerPort: 80
</span></span><span class="line"><span class="cl">			- name: https
</span></span><span class="line"><span class="cl">			  containerPort: 443
</span></span><span class="line"><span class="cl">			ImagePullPolicy: (Always,Never,IfNotPresent)  # 镜像拉去策略,Always,本地无论有没有总是去仓库下载; Never,本地有就用，没有就等待;IfNotPresent,本地有就用，没有就下载
</span></span><span class="line"><span class="cl">           command   # 和docker镜像中的Entrypoint对标，如果镜像里面有command，这里也有，会执行这里的
</span></span><span class="line"><span class="cl">           - &#34;/bin/sh&#34;
</span></span><span class="line"><span class="cl">           - &#34;-c&#34;
</span></span><span class="line"><span class="cl">           - &#34;sleep 3600&#34;
</span></span><span class="line"><span class="cl">           args  # 和docker镜像中的cmd对标，将参数传给上面的command，如果上面没定义，则传给镜像里的entrypoint，相当于顶替掉镜像里的cmd
</span></span><span class="line"><span class="cl">           
</span></span><span class="line"><span class="cl">           livenessProbe:  # 设置探针
</span></span><span class="line"><span class="cl">             exec:
</span></span><span class="line"><span class="cl">               command: [&#34;test&#34;,&#34;-e&#34;,&#34;/tmp/healthy&#34;]
</span></span><span class="line"><span class="cl">               initalDelaySeconds: 2     # 两秒之后再探测
</span></span><span class="line"><span class="cl">               periodSeconds: 3     # 每个3秒探测一次
</span></span><span class="line"><span class="cl">	  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 探针类型有三种
</span></span><span class="line"><span class="cl">	ExecAction、TCPSocketAction、HTTPGetAction
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="43-pod生命周期">4.3 pod生命周期</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># pod生命周期
</span></span><span class="line"><span class="cl">	1) 状态： Pending(调度尚未完成)，Running(运行状态)，Failend(失败)，Succeeded(成功)，Unknown(未知，kubelet监控不到该pod)
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	2) 创建pod：用户创建pod时，将pod提交给apiservice，apiservice将创建请求的目标保存在etcd中，然后apiservice请求schdule调度，如果调度成功了，把调度结果保存在etcd中(运行到那个节点了)，然后被调度的目标节点的kubelet通过apiservice中的状态变化知道有新任务了，会向apiservice拿到配置清单，更具清单去当前节点创建pod，创建成功后或者失败后会将该状态再次发给apiservice，apiservice将这些状态存到etcd中
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">	3) pod生命周期中的重要行为：
</span></span><span class="line"><span class="cl">		初始化容器
</span></span><span class="line"><span class="cl">		容器探测：
</span></span><span class="line"><span class="cl">			liveness： 主要是探测应用是否还活着。如果检测到应用没有存活就杀掉当前pod并重启。
</span></span><span class="line"><span class="cl">			readiness：探测容器中的程序是否能够提供服务
</span></span><span class="line"><span class="cl">		容器生命周期钩子：lifecycle
</span></span><span class="line"><span class="cl">			启动后钩子 
</span></span><span class="line"><span class="cl">			终止前钩子
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="431-例1存活性探测exec探针">4.3.1 例1：存活性探测,exec探针</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## exec探针
</span></span><span class="line"><span class="cl">## liveness-exec.yaml
</span></span><span class="line"><span class="cl">apiVersion:v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: liveness-exec-pod
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: liveness-exec-container
</span></span><span class="line"><span class="cl">    image: busybox:latest
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">    command: [&#34;/bin/sh&#34;,&#34;-c&#34;,&#34;touch /tmp/healthy; sleep30; rm -rf /tmp/healthy; sleep 3600&#34;]
</span></span><span class="line"><span class="cl">    livenessProbe:
</span></span><span class="line"><span class="cl">      exec:
</span></span><span class="line"><span class="cl">        command: [&#34;test&#34;,&#34;-e&#34;,&#34;/tmp/healthy&#34;]
</span></span><span class="line"><span class="cl">      initalDelaySeconds: 2     # 两秒之后再探测
</span></span><span class="line"><span class="cl">      periodSeconds: 3     # 每个3秒探测一次
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">  restartPolicy: Always    # 默认是Always
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl create -f liveness-exec.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pod详细信息
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">kubectl describe pods  xxxx
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="432-例2存活性探测httpget探针">4.3.2 例2：存活性探测,httpget探针</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## httpget探针
</span></span><span class="line"><span class="cl">## liveness-http.yaml
</span></span><span class="line"><span class="cl">apiVersion:v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: liveness-httpget-pod
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: liveness-httpget-container
</span></span><span class="line"><span class="cl">    image: ibubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - name: http
</span></span><span class="line"><span class="cl">      containerPort:80
</span></span><span class="line"><span class="cl">    livenessProbe:
</span></span><span class="line"><span class="cl">      httpGet:
</span></span><span class="line"><span class="cl">        port: http
</span></span><span class="line"><span class="cl">        path: /index.html
</span></span><span class="line"><span class="cl">      initalDelaySeconds: 2     # 两秒之后再探测
</span></span><span class="line"><span class="cl">      periodSeconds: 3     # 每个3秒探测一次
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">  restartPolicy: Always    # 默认是Always
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl create -f liveness-http.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pod详细信息
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">kubectl describe pods  xxxx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 进入pod里的容器
</span></span><span class="line"><span class="cl">kubectl exec -it liveness-httpget-pod -- /bin/sh
</span></span><span class="line"><span class="cl">rm -f /usr/share/nginx/html/index.html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">###这个时候nginx首页没了，会被探测到，然后容器会重启
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看字段帮助
</span></span><span class="line"><span class="cl">kubectl explain pods.spec.containers.livenessProbe.httpGet
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="433-例3就绪性探测案例">4.3.3 例3：就绪性探测案例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 当使用kubectl get pods 查看pods是可以看到ready字段左边的容器就绪，只要容器已启动就显示就绪，但容器刚启动里面的服务可能还没有起来，所以这样客户通过service访问的时候访问不到资源，这样显然是不行的，所以需要进行服务就绪探测，当容器起来服务也起来的时候就可以就绪。
</span></span><span class="line"><span class="cl">## readiness的探测方式和liveness很像，直接仿照着写就行
</span></span><span class="line"><span class="cl">## 如果不做就绪性探测，哪怕nginx服务的主页被删了，只要服务还是起来的，使用kubectl get pods查看该pod还会显示就绪，所以需要进行就绪性探测
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## liveness-httpget.yaml
</span></span><span class="line"><span class="cl">apiVersion:v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: readiness-httpget-pod
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: liveness-httpget-container
</span></span><span class="line"><span class="cl">    image: ibubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - name: http
</span></span><span class="line"><span class="cl">      containerPort:80
</span></span><span class="line"><span class="cl">    readinessProbe:
</span></span><span class="line"><span class="cl">      httpGet:
</span></span><span class="line"><span class="cl">        port: http
</span></span><span class="line"><span class="cl">        path: /index.html
</span></span><span class="line"><span class="cl">      initalDelaySeconds: 2     # 两秒之后再探测
</span></span><span class="line"><span class="cl">      periodSeconds: 3     # 每个3秒探测一次
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  restartPolicy: Always    # 默认是Always
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl create -f liveness-httpget.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pod详细信息
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">kubectl describe pods  xxxx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 进入pod里的容器
</span></span><span class="line"><span class="cl">kubectl exec -it readiness-httpget-pod -- /bin/sh
</span></span><span class="line"><span class="cl">rm -f /usr/share/nginx/html/index.html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">###这个时候nginx首页没了，会被探测到，然后容器会重启
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看字段帮助
</span></span><span class="line"><span class="cl">kubectl explain pods.spec.containers.ReadinessProbe.httpGet
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="434-例4启动后终止前钩子案例">4.3.4 例4：启动后，终止前钩子案例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 查看字段帮助 kubectl explain pods.spec.containers.lifecycle.preStop 终止前
</span></span><span class="line"><span class="cl">## 启动后 kubectl explain pods.spec.containers.lifecycle.preStart
</span></span><span class="line"><span class="cl">## 配置启动后的案例，终止前的操作类似
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## lifecycle-exec.yaml
</span></span><span class="line"><span class="cl">apiVersion:v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: postart-pod
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: busybox-httpd
</span></span><span class="line"><span class="cl">    image: busybox:lates
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">    lifecycle:
</span></span><span class="line"><span class="cl">      postStart:
</span></span><span class="line"><span class="cl">        exec:
</span></span><span class="line"><span class="cl">          command: [&#39;/bin/sh&#39;,&#39;-c&#39;,&#39;echo Home_Page &gt;&gt; /tmp/index.html&#39;]
</span></span><span class="line"><span class="cl">      command: [&#34;/bin/httpd&#34;]
</span></span><span class="line"><span class="cl">      args: [&#34;-f&#34;,&#34;-h /tmp&#34;]
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl create -f lifecycle-exec.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pod详细信息
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">kubectl describe pods  xxxx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">可以看到容器结束前会执行该钩子
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="44-pod标签操作">4.4 pod标签操作</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 查看pods，并只查看含有app这个key的value值
</span></span><span class="line"><span class="cl">kubectl get pods -L app
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看key是app标签的pod
</span></span><span class="line"><span class="cl">kubectl get pods -l app	 --show-labels		
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 给资源对象打标签
</span></span><span class="line"><span class="cl">kubectl label pods	pod名称	key=value
</span></span><span class="line"><span class="cl">kubectl get pods -l key --show-labels
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 修改标签值
</span></span><span class="line"><span class="cl">kubectl label pods pod名称	key=新value  --overwrite
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 给node节点打标签，当节点有标签后，在添加资源的时候可以指定对应的节点
</span></span><span class="line"><span class="cl">kubectl get nodes
</span></span><span class="line"><span class="cl">kubectl label nodes nodeName  disktype=ssd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"># 标签选择器：
</span></span><span class="line"><span class="cl">	- 等值关系： =，==，!=
</span></span><span class="line"><span class="cl">		kubectl get pods -l key=value,key2=value2		# 如果后面加多个值，他们的关系是与
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	- 集合关系：
</span></span><span class="line"><span class="cl">		key in (value1,value2...)
</span></span><span class="line"><span class="cl">		key notin (value1,value2...)
</span></span><span class="line"><span class="cl">		key		# 表示存在这个建就行
</span></span><span class="line"><span class="cl">		!key	# 表示不存在此建的资源
</span></span><span class="line"><span class="cl">		例：kubectl get pods -l &#34;key in (value1,value2,value3...)&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	- 许多资源支持内嵌字段来定义标签选择器
</span></span><span class="line"><span class="cl">        matchlabels: 直接给定键值
</span></span><span class="line"><span class="cl">        matchExpressions: 基于给定的表达式来定义使用标签选择器，{key:&#34;key&#34;,operator:&#34;操作符&#34;,values:[value1,value2...]}
</span></span><span class="line"><span class="cl">        	操作符：
</span></span><span class="line"><span class="cl">        		In，NotIn：values字段的值必须为非空列表
</span></span><span class="line"><span class="cl">        		Exists，NotExists：values字段的值必须为非空字段
</span></span><span class="line"><span class="cl">        		
</span></span><span class="line"><span class="cl"># 节点标签选择器
</span></span><span class="line"><span class="cl">	nodeSelector: 
</span></span><span class="line"><span class="cl">	  key:value		# 节点标签的kv
</span></span><span class="line"><span class="cl">	
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5-pod控制器">5 pod控制器</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## pod控制器
</span></span><span class="line"><span class="cl">    1、ReplicationController：比较原始的pod控制器，已经被废弃，由ReplicaSet替代
</span></span><span class="line"><span class="cl">    2、ReplicaSet：保证副本数量一直维持在期望值，并支持pod数量扩缩容，镜像版本升级
</span></span><span class="line"><span class="cl">    3、Deployment：通过控制ReplicaSet来控制Pod，并支持滚动升级、回退版本
</span></span><span class="line"><span class="cl">    4、Horizontal Pod Autoscaler：可以根据集群负载自动水平调整Pod的数量，实现削峰填谷
</span></span><span class="line"><span class="cl">    5、DaemonSet：在集群中的指定Node上运行且仅运行一个副本，一般用于守护进程类的任务
</span></span><span class="line"><span class="cl">    6、Job：它创建出来的pod只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务
</span></span><span class="line"><span class="cl">    7、Cronjob：它创建的Pod负责周期性任务控制，不需要持续后台运行
</span></span><span class="line"><span class="cl">    8、StatefulSet：管理有状态应用
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="51-replicaset">5.1 ReplicaSet</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 保证副本数量一直维持在期望值，并支持pod数量扩缩容，镜像版本升级
</span></span><span class="line"><span class="cl">## 可以简写为rs，查看字段帮助，kubectl explain rs.spec
</span></span><span class="line"><span class="cl">## 其实Deployment的更新回滚等操作是更具ReplicaSet来的
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## rs-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: ReplicaSet
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">    name: myapp
</span></span><span class="line"><span class="cl">    namespace: default
</span></span><span class="line"><span class="cl">spec:    # 控制器的spec
</span></span><span class="line"><span class="cl">    replicas: 2
</span></span><span class="line"><span class="cl">    selector:     # 使用什么样的标签选择器，可以通过查看字段命令查看
</span></span><span class="line"><span class="cl">        matchLabels:
</span></span><span class="line"><span class="cl">            app: myapp
</span></span><span class="line"><span class="cl">            release: canary
</span></span><span class="line"><span class="cl">    template:
</span></span><span class="line"><span class="cl">        metadata:
</span></span><span class="line"><span class="cl">            name: myapp-pod
</span></span><span class="line"><span class="cl">            labels:    # 这里定义的标签一定要符合上面的标签选择器的标签
</span></span><span class="line"><span class="cl">                app: myapp
</span></span><span class="line"><span class="cl">                release: canary
</span></span><span class="line"><span class="cl">                environment: qa
</span></span><span class="line"><span class="cl">        spec:     # pod的spec
</span></span><span class="line"><span class="cl">            containers:
</span></span><span class="line"><span class="cl">            - name: myapp-container
</span></span><span class="line"><span class="cl">              image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">              ports:
</span></span><span class="line"><span class="cl">              - name: http
</span></span><span class="line"><span class="cl">                containerPort: 80
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 1、创建容器
</span></span><span class="line"><span class="cl">kubectl create -f rs-demo.yaml
</span></span><span class="line"><span class="cl">kubectl get rs		# 查看ReplicaSet控制器
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">kubectl describe pods myapp-4qasc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2、测试
</span></span><span class="line"><span class="cl">curl x.x.x.x
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3、删除增加测试
</span></span><span class="line"><span class="cl">	- 清单文件定义了replicas: 2，要保持两副本，如果删掉一个他会自动创建，如果多了一个会自动删除
</span></span><span class="line"><span class="cl">	- 它检测副本数是通过标签选择器来检测的，如果随意将一个pod的标签设置为符合该标签选择器的标签，则他会显示多一个副本，然后会随机删除一个pod,该匹配只对自助式pod有效
</span></span><span class="line"><span class="cl">	kubectl delete pods myapp-4qasc
</span></span><span class="line"><span class="cl">	kubectl label pods pod-demo release=canary
</span></span><span class="line"><span class="cl">	kubectl get pods --show-labels
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 4、动态修改扩容,缩容，升级等，该修改不会影响模板
</span></span><span class="line"><span class="cl">kubectl edit rs myapp
</span></span><span class="line"><span class="cl">kubectl get rs -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps: ReplicaSet控制器对模板进行重建时，是更具模板来进行重建的，比如我修改了模板版本，然后删除一个模板它重建会更具我们修改的那个模板来进行重构
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="52-deployment">5.2 Deployment</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## Deployment：通过控制ReplicaSet来控制Pod，并支持滚动升级、回退版本
</span></span><span class="line"><span class="cl">## 查看字段帮助 kubectl explain deploy
</span></span><span class="line"><span class="cl">## 两个更新字段 maxSurge，maxUnavailable，前者表示更新过程中能超出所指定的副本数几个，后者表示最多有几个不可用(比如我最多有一个不可用，那我最少有四个可用)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## deploy-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: myapp-deploy
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 1
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: myapp
</span></span><span class="line"><span class="cl">      release: canary
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: myapp
</span></span><span class="line"><span class="cl">        release: canary
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: myapp
</span></span><span class="line"><span class="cl">        image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - name: http
</span></span><span class="line"><span class="cl">          containerPort: 80
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 1、创建pod
</span></span><span class="line"><span class="cl">kubectl create -f deploy-demo.yaml
</span></span><span class="line"><span class="cl">或者 kubectl apply -f deploy-demo.yaml  # 该命令可以执行多次，不像create创建一次就不能创建了
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get deploy
</span></span><span class="line"><span class="cl">kubectl get rs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2、在线扩容减容
</span></span><span class="line"><span class="cl">	- 方式一修改配置文件
</span></span><span class="line"><span class="cl">    vim deploy-demo.yaml
</span></span><span class="line"><span class="cl">    kubectl apply -f deploy-demo.yaml	
</span></span><span class="line"><span class="cl">    kubectl describe deploy myapp-deploy
</span></span><span class="line"><span class="cl">    # 每一次apply，它改变的信息都会保存在Annotations中
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"># 3、升级版本，通过编辑配置文件
</span></span><span class="line"><span class="cl">vim deploy-demo.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f deploy-demo.yaml
</span></span><span class="line"><span class="cl">kubectl get rs -o wide		# 升级后可以看到之前的版本模板还在，该模板用来回滚
</span></span><span class="line"><span class="cl">kubectl rollout history deployment myapp-deploy	  # 查看滚动历史
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 4、打补丁式升级
</span></span><span class="line"><span class="cl">	- 该升级可以不修改模板
</span></span><span class="line"><span class="cl">	kubectl patch deployment myapp-deploy -p &#39;{&#34;spec&#34;:{&#34;replicas&#34;:2}}&#39;
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	- 给更新策略打补丁
</span></span><span class="line"><span class="cl">	kubectl patch deployment myapp-deploy -p &#39;{&#34;spec&#34;:{&#34;strategy&#34;:{&#34;rollingUpdate&#34;:{&#34;maxSurge&#34;:1,&#34;maxUnavailable&#34;:0}}}}&#39;  
</span></span><span class="line"><span class="cl">	kubectl describe deployment myapp-deploy
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 5、通过set image给容器镜像升级
</span></span><span class="line"><span class="cl">	- 金丝雀式升级，后半段命令是将升级暂停，只升级一个
</span></span><span class="line"><span class="cl">kubectl set image deployment myapp-deploy myapp=ikubernetes/myapp:v3 &amp;&amp; kubectl rollout pause deployment
</span></span><span class="line"><span class="cl">	# 监控更新进度
</span></span><span class="line"><span class="cl">	kubectl rollout status deployment myapp-deploy
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	- 如果升级没有问题，则继续后续操作
</span></span><span class="line"><span class="cl">	kubectl rollout resume deployment myapp-deploy
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 6、升级回滚
</span></span><span class="line"><span class="cl">kubectl rollout history deployment myapp-deploy	  # 查看滚动历史
</span></span><span class="line"><span class="cl">kubectl rollout undo deployment myapp-deploy --to-revision=1
</span></span><span class="line"><span class="cl">kubectl get rs -o wide
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="53-daemonset">5.3 DaemonSet</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## DaemonSet：在集群中的指定Node上运行且仅运行一个副本，一般用于守护进程类的任务
</span></span><span class="line"><span class="cl">## 查看字段配置 kubectl explain ds
</span></span><span class="line"><span class="cl">## 1个更新字段 maxUnavailable，表示最多有几个不可用(比如我最多有一个不可用，那我最少有四个可用)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## ds-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: redis
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 1
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: redis
</span></span><span class="line"><span class="cl">      role: logstor
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: redis
</span></span><span class="line"><span class="cl">        role: logstor
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      cotainers:
</span></span><span class="line"><span class="cl">      - name: redis
</span></span><span class="line"><span class="cl">        image: redis:4.0-alpine
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - name: redis
</span></span><span class="line"><span class="cl">          containerPort: 6379
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: DaemonSet
</span></span><span class="line"><span class="cl">metadata: 
</span></span><span class="line"><span class="cl">  name: myapp-ds
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: filebeat
</span></span><span class="line"><span class="cl">      release: stable
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: filebeat
</span></span><span class="line"><span class="cl">        release: stable
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: filebeat
</span></span><span class="line"><span class="cl">        image: ikubernetes/filebeat:5.6.5-alpine
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - name: http
</span></span><span class="line"><span class="cl">          containerPort: 80
</span></span><span class="line"><span class="cl">        env:
</span></span><span class="line"><span class="cl">        - name: REDIS_HOST
</span></span><span class="line"><span class="cl">          value: redis.default.svc.cluster.local
</span></span><span class="line"><span class="cl">        - name: REDIS_LOG_LEVEL
</span></span><span class="line"><span class="cl">          value: info
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl apply -f ds-demo.yaml
</span></span><span class="line"><span class="cl">kubectl logs pod mtapp-ds-asdqw
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pod会发现有两份，分别再两个node节点上
</span></span><span class="line"><span class="cl">	- 为什么master节点上没有？应为master节点上有污点
</span></span><span class="line"><span class="cl">	kubectl get pods
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建service给redis做关联
</span></span><span class="line"><span class="cl">kubectl expose deployment redis --port=6379
</span></span><span class="line"><span class="cl">kubectl get svc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 进入redis容器测试
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">kubectl exec -it redis-56q23zx1c-4xnxx  -- /bin/sh
</span></span><span class="line"><span class="cl">	nslookup redis.default.svc.cluster.local
</span></span><span class="line"><span class="cl">	redis-cli -h redis.default.svc.cluster.local
</span></span><span class="line"><span class="cl">		keys *
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 更新策略
</span></span><span class="line"><span class="cl">	- 这种控制器的更新策略只有 maxUnavailable，应为这里的数量是更具节点来的，所以没有maxSurge
</span></span><span class="line"><span class="cl">	kubectl describe ds filebeat
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-service资源">6 Service资源</h2>
<h3 id="61-service代理方式三种">6.1 service代理方式(三种)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 1、service的名称解析强依赖于dns插件(CoreDNS,kube-dns)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 2、在每个节点上工作着kube-proxy，该组件始终监视apiservice中有关service资源的变动信息
</span></span><span class="line"><span class="cl">一旦有service资源的内容发生变动，kube-proxy都要其转化为对应的规则(iptables,ipvs)，取决于service的实现方式
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 3、工作模式
</span></span><span class="line"><span class="cl">		userspace 1.1-
</span></span><span class="line"><span class="cl">		iptables 1.10-
</span></span><span class="line"><span class="cl">		ipvs 1.11+，如果没有装这个会被自动降级为iptables
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="611-userspace模型">6.1.1 userspace模型</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 方式一： 由kube-porxy调度，效率低
</span></span><span class="line"><span class="cl">node节点内的客户端pod发一个请求 ==》先发给serviceIP(iptables) ==》 再由serviceIP(iptables)发给kube-proxy处理 ==》 kube-proxy处理完后再转给serviceIP(iptables),再由serviceIP(iptables)分发到对应的kube-proxy，然后kube-proxy分发到对应的pod上
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="612-iptables模型">6.1.2 iptables模型</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 方式二：由serviceIP(iptables)调度，效率高
</span></span><span class="line"><span class="cl">客户端ip直接请求serviceIP，该请求直接被serviceIP(iptables)截取然后直接调度给相关pod
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="613-ipvs模型">6.1.3 ipvs模型</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 方式三：由ipvs调度
</span></span><span class="line"><span class="cl">客户端请求到达内核空间后直接由serviceIP(ipvs)来调度，直接调度给pod网络地址范围内的相关pod资源
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">该方式如果多了一个pod，该信息会立刻反应给kube-apiserver，然后kube-proxy会监视apiserver的变化，将该变化立即转为 iptables，或者ipvs规则
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="62-创建service资源">6.2 创建service资源</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 查看帮助 kubectl explain svc.spec
</span></span><span class="line"><span class="cl">## service类型：ClusterIP(默认，仅用于集群内通信),NodePort(接入集群外流量)，Load Balance(负载均衡),ExternalName(节点上的客户端访问集群外的服务，在集群上建一个service，service关联到外部服务，然后pod客户端通过service访问到外部服务)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## redis-svc.yaml	类型是ClusterIP
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: redis
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: redis
</span></span><span class="line"><span class="cl">    role: logstor
</span></span><span class="line"><span class="cl">  clusterIP: 10.97.97.97 # 可以自己配一个(容易冲突)，不配则自动分配
</span></span><span class="line"><span class="cl">  type: ClusterIP
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - port: 6379  # serviceIP上的端口
</span></span><span class="line"><span class="cl">    targetPort: 6379  # podIP上的端口
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## myapp-svc.yaml	类型是NodePort
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: myapp
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    release: canary
</span></span><span class="line"><span class="cl">  clusterIP: 10.99.99.99 
</span></span><span class="line"><span class="cl">  type: NodePort
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - port: 80  
</span></span><span class="line"><span class="cl">    targetPort: 80
</span></span><span class="line"><span class="cl">    nodePort: 30080  # 不指也可以，他会自动分配
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 无头svc，表示无svc地址，请求直达pod
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: myapp1
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    release: canary
</span></span><span class="line"><span class="cl">  clusterIP: &#34;None&#34;
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - port: 80  
</span></span><span class="line"><span class="cl">    targetPort: 80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"># 创建svc
</span></span><span class="line"><span class="cl">kubectl apply -f redis-svc.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看详情
</span></span><span class="line"><span class="cl">kubectl describe svc redis
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 集群外测试
</span></span><span class="line"><span class="cl">while true;do curl http://192.168.101.67:30080/hostname.html; sleep 1; done
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 打补丁,来自同一个客户端的请求始终发往同一个pod
</span></span><span class="line"><span class="cl">kubectl patch svc myapp -p &#39;{&#34;spec&#34;:{&#34;sessionAffinity&#34;:&#34;ClientIP&#34;}}&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 再改回none则默认会自动调度
</span></span><span class="line"><span class="cl">kubectl patch svc myapp -p &#39;{&#34;spec&#34;:{&#34;sessionAffinity&#34;:&#34;None&#34;}}&#39;
</span></span><span class="line"><span class="cl">kubectl describe svc  myapp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 测试无头svc
</span></span><span class="line"><span class="cl">	kubectl get svc -n kube-system
</span></span><span class="line"><span class="cl">	- 查看有头的发现会由service进行代理
</span></span><span class="line"><span class="cl">		dig -t A myapp-svc.default.svc.cluster.local. @10.96.0.10  
</span></span><span class="line"><span class="cl">	- 查看无头的发现直接解析到对应pod的地址
</span></span><span class="line"><span class="cl">		dig -t A myapp1.efault.svc.cluster.local. @10.96.0.10
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps: Endpoints(service是先到Endpoints资源，然后再由Endpoints关联至后端pod)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="7-ingress和ingress-controller">7 ingress和ingress Controller</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">相当于service的service，一个ingress后面可以跟多个service，请求来了通过ingress转发给对应的service
</span></span><span class="line"><span class="cl">ingress-controller是具体的转发组件，而ingress对象是用来告诉ingress-controller该如何转发请求
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## k8s中常用的负载均衡器 Nginx Traefik Envoy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## ingress也是标准的k8s资源
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">Ingress 是 K8S Service 暴露内部服务的一种方式，比起 ClusterIP，NodePort，LoadBalancer等方式，Ingress 具有较多的优势。ClusterIP 仅限集群内部访问，NodePort 需要额外开放较多端口资源，LoadBalancer 需要云服务商提供支持，Ingress 无需云服务商支持，也无需开放太多端口，是比较好的解决方案。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Ingress 需要配合 Ingress Controller 运行，Ingress Controller 作为集群服务的统一入口点，实时监测 Ingress 资源的变化，并及时更新内部配置以生效
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="71-安装-ingress-controller">7.1 安装 ingress Controller</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">一：下载ingress包
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">链接：https://pan.baidu.com/s/1HbcJdCALntA9xDFJQF3Tkg
</span></span><span class="line"><span class="cl">提取码：htu8 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[root@master ~]# tar xf ingress-nginx-nginx-0.15.0.tar.gz
</span></span><span class="line"><span class="cl">[root@master ~]# cd ingress-nginx-nginx-0.15.0
</span></span><span class="line"><span class="cl">[root@master ingress-nginx-nginx-0.15.0]# cd deploy/ 
</span></span><span class="line"><span class="cl">[root@master deploy]# ls
</span></span><span class="line"><span class="cl">configmap.yaml namespace.yaml publish-service-patch.yaml README.md udp-services-configmap.yaml with-rbac.yaml default-backend.yaml provider rbac.yaml tcp-services-configmap.yaml without-rbac.yaml 
</span></span><span class="line"><span class="cl">[root@hd01 deploy]#
</span></span><span class="line"><span class="cl">[root@master deploy]# kubectl apply -f ./
</span></span><span class="line"><span class="cl">[root@master deploy]# kubectl apply -f provider/baremetal/service-nodeport.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 查看发现有两个pod镜像拉不下来
</span></span><span class="line"><span class="cl">kubectl describe pod default-http-backend-6cdd6c64f8-vfmtq -n ingress-nginx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl describe pod ingress-nginx-controller-6b768f84db-j22bp -n ingress-nginx
</span></span><span class="line"><span class="cl">kubectl patch svc myapp -p &#39;{&#34;spec&#34;:{&#34;sessionAffinity&#34;:&#34;ClientIP&#34;}}&#39;
</span></span><span class="line"><span class="cl">打补丁
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">##当镜像下载完启动完毕后，会看到这样的结果
</span></span><span class="line"><span class="cl">[root@master deploy]# kubectl get svc -n ingress-nginx
</span></span><span class="line"><span class="cl">NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
</span></span><span class="line"><span class="cl">default-http-backend   ClusterIP   10.98.147.56     &lt;none&gt;        80/TCP                       20h
</span></span><span class="line"><span class="cl">ingress-nginx          NodePort    10.101.121.183   &lt;none&gt;        80:31502/TCP,443:31061/TCP   135m
</span></span><span class="line"><span class="cl">[root@master deploy]# kubectl get pod -n ingress-nginx
</span></span><span class="line"><span class="cl">NAME                                        READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">default-http-backend-5d4f569658-zhhn4       1/1     Running   0          20h
</span></span><span class="line"><span class="cl">nginx-ingress-controller-54b8f8d8cd-5bj65   1/1     Running   0          20h
</span></span><span class="line"><span class="cl">[root@master deploy]# 
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="72--给ingresscontroller创建一个service接入外部流量">7.2  给ingressController创建一个service接入外部流量</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 给ingressController创建一个service接入外部流量，如果不创建他是没办法接入外部流量的
</span></span><span class="line"><span class="cl">## service-nodeport.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: ingress-nginx
</span></span><span class="line"><span class="cl">  namespace: ingress-nginx
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  type: NodePort
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - name: http
</span></span><span class="line"><span class="cl">    port: 80
</span></span><span class="line"><span class="cl">    targetPort: 80
</span></span><span class="line"><span class="cl">    protocol: TCP
</span></span><span class="line"><span class="cl">    nodePort: 30080
</span></span><span class="line"><span class="cl">  -name: https
</span></span><span class="line"><span class="cl">    port: 443
</span></span><span class="line"><span class="cl">    targetPort: 443
</span></span><span class="line"><span class="cl">    protocol: TCP
</span></span><span class="line"><span class="cl">    nodePort: 30443
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: ingress-nginx
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="73-案例一nginx">7.3 案例一：nginx</h3>
<h4 id="731-创建应用-myapp">7.3.1 创建应用 myapp</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 查看字段kubectl explain ingress.spec
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## myapp.yaml
</span></span><span class="line"><span class="cl"># 这是myapp的server
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: myapp
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    release: canary
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - name: http
</span></span><span class="line"><span class="cl">    targetPort:80
</span></span><span class="line"><span class="cl">    port: 80
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: myapp-depoly
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 3
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: myapp
</span></span><span class="line"><span class="cl">      release: canary
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: myapp
</span></span><span class="line"><span class="cl">        release: canary
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: myapp
</span></span><span class="line"><span class="cl">        image: ikubernetes/myapp:v2
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - name: http
</span></span><span class="line"><span class="cl">          containerPort: 80
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl"># 创建 
</span></span><span class="line"><span class="cl">kubectl apply -f  myapp.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="732-通过ingress发布myapp代码">7.3.2 通过ingress发布myapp代码</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## ingress-myapp.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: extensions/v1beta1
</span></span><span class="line"><span class="cl">kind: Ingress
</span></span><span class="line"><span class="cl">metdata:
</span></span><span class="line"><span class="cl">  name: ingress-myapp
</span></span><span class="line"><span class="cl">  namespace: default  # 要和发布的server处于同一名称空间中
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    kubernetes.io/ingress.class:&#34;nginx&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  rules:
</span></span><span class="line"><span class="cl">  - host: myapp.mageedu.com		# ingressController service所在主机的地址
</span></span><span class="line"><span class="cl">  http:
</span></span><span class="line"><span class="cl">    paths:
</span></span><span class="line"><span class="cl">    - path:
</span></span><span class="line"><span class="cl">      backend:  # 定义后端路径
</span></span><span class="line"><span class="cl">        serviceName: myapp
</span></span><span class="line"><span class="cl">        servicePort: 80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建服务    
</span></span><span class="line"><span class="cl">kubectl apply -f ingress-myapp.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看验证
</span></span><span class="line"><span class="cl">kubectl get ingress
</span></span><span class="line"><span class="cl">kubectl describe ingress ingress-myapp
</span></span><span class="line"><span class="cl">kubectl get pods -n ingress-nginx
</span></span><span class="line"><span class="cl">kubectl exec -n ingress-nginx -it nginx-ingress-controller-d656456cd-t55m8 -- /bin/sh
</span></span><span class="line"><span class="cl">- 查看配置文件
</span></span><span class="line"><span class="cl">cat nginx.conf
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="74-案例二tomcat">7.4 案例二：tomcat</h3>
<h4 id="741-创建应用tomcat">7.4.1 创建应用tomcat</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 创建一个 server 关联三个 tomcat
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: tomcat
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: tomcat
</span></span><span class="line"><span class="cl">    release: canary
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - name: http
</span></span><span class="line"><span class="cl">    targetPort: 80
</span></span><span class="line"><span class="cl">    port: 80
</span></span><span class="line"><span class="cl">  - name: ajp
</span></span><span class="line"><span class="cl">    targePort: 8009
</span></span><span class="line"><span class="cl">    port: 8009
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: tomcat-deploy
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 3
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: tomcat
</span></span><span class="line"><span class="cl">      release: canary
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: tomcat
</span></span><span class="line"><span class="cl">        release: canary
</span></span><span class="line"><span class="cl">    template:
</span></span><span class="line"><span class="cl">      metadata:
</span></span><span class="line"><span class="cl">        labels:
</span></span><span class="line"><span class="cl">          app: tomcat
</span></span><span class="line"><span class="cl">          release: canary
</span></span><span class="line"><span class="cl">      spec:
</span></span><span class="line"><span class="cl">        containers:
</span></span><span class="line"><span class="cl">        - nameL myapp 
</span></span><span class="line"><span class="cl">          image: tomcat tomcat:8.5.32-jre8-alpine
</span></span><span class="line"><span class="cl">          ports:
</span></span><span class="line"><span class="cl">          - name: http
</span></span><span class="line"><span class="cl">            containerPort: 8080
</span></span><span class="line"><span class="cl">          - name: ajp
</span></span><span class="line"><span class="cl">            containerPort: 8009
</span></span><span class="line"><span class="cl">  
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="742-定义tomcat的ingress">7.4.2 定义tomcat的ingress</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## ingress-tomcat.yaml
</span></span><span class="line"><span class="cl">## 通过访问nginx的80，将其请求转发到tomcat的8080
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">apiVersion: extensions/v1beta1
</span></span><span class="line"><span class="cl">kind: Ingress
</span></span><span class="line"><span class="cl">metdata:
</span></span><span class="line"><span class="cl">  name: ingress-myapp
</span></span><span class="line"><span class="cl">  namespace: default  # 要和发布的server处于同一名称空间中
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    kubernetes.io/ingress.class:&#34;nginx&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  rules:
</span></span><span class="line"><span class="cl">  - host: tomcat.mageedu.com		# ingressController service所在主机的地址
</span></span><span class="line"><span class="cl">  http:
</span></span><span class="line"><span class="cl">    paths:
</span></span><span class="line"><span class="cl">    - path:
</span></span><span class="line"><span class="cl">      backend:  # 定义后端路径
</span></span><span class="line"><span class="cl">        serviceName: tomcat
</span></span><span class="line"><span class="cl">        servicePort: 8080
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建服务    
</span></span><span class="line"><span class="cl">kubectl apply -f ingress-tomcat.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看验证
</span></span><span class="line"><span class="cl">kubectl get ingress
</span></span><span class="line"><span class="cl">kubectl describe ingress ingress-tomcat
</span></span><span class="line"><span class="cl">kubectl get pods -n ingress-nginx
</span></span><span class="line"><span class="cl">kubectl exec -n ingress-nginx -it nginx-ingress-controller-d656456cd-t55m8 -- /bin/sh
</span></span><span class="line"><span class="cl">- 查看配置文件
</span></span><span class="line"><span class="cl">cat nginx.conf
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="743-配置tomcat证书服务">7.4.3 配置tomcat证书服务</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 做自签证书
</span></span><span class="line"><span class="cl">openssl genrsa -out tls.key 2048
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">openssl req -new -x509 -key tls.key -out tls.crt -subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=tomcat.mageedu.com
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl create secret tls tomcat-ingress-secret --sert=tls.crt --key=tls.key
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看
</span></span><span class="line"><span class="cl">kubectl get secret
</span></span><span class="line"><span class="cl">kubectl describe secret tomcat-ingress-tomcat
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 配置证书
</span></span><span class="line"><span class="cl">kubectl explain ingress.spec.tls
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># vim ingress-tomcat-tls.yaml
</span></span><span class="line"><span class="cl">apiVersion: extensions/v1beta1
</span></span><span class="line"><span class="cl">kind: Ingress
</span></span><span class="line"><span class="cl">metdata:
</span></span><span class="line"><span class="cl">  name: ingress-myapp-tls
</span></span><span class="line"><span class="cl">  namespace: default  # 要和发布的server处于同一名称空间中
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    kubernetes.io/ingress.class:&#34;nginx&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  tls:
</span></span><span class="line"><span class="cl">  - hosts:
</span></span><span class="line"><span class="cl">    - tomcat.magede.com
</span></span><span class="line"><span class="cl">    secretName: tomcat-ingress-secret
</span></span><span class="line"><span class="cl">  rules:
</span></span><span class="line"><span class="cl">  - host: tomcat.magedu.com		# ingressController service所在主机的地址
</span></span><span class="line"><span class="cl">  http:
</span></span><span class="line"><span class="cl">    paths:
</span></span><span class="line"><span class="cl">    - path:
</span></span><span class="line"><span class="cl">      backend:  # 定义后端路径
</span></span><span class="line"><span class="cl">        serviceName: tomcat
</span></span><span class="line"><span class="cl">        servicePort: 8080
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl apply -f ingress-tomcat-tls.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看验证
</span></span><span class="line"><span class="cl">kubectl get ingress
</span></span><span class="line"><span class="cl">kubectl describe ingress ingress-tomcat
</span></span><span class="line"><span class="cl">kubectl get pods -n ingress-nginx
</span></span><span class="line"><span class="cl">kubectl exec -n ingress-nginx -it nginx-ingress-controller-d656456cd-t55m8 -- /bin/sh
</span></span><span class="line"><span class="cl">- 查看配置文件
</span></span><span class="line"><span class="cl">cat nginx.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 最后访问页面
</span></span><span class="line"><span class="cl">https://tomcat.magedu.com:30443
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps: 这里访问30443是应为在ingressController service里定义了，访问pod443端口的流量可以通过主机的30443访问
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="8-存储卷">8 存储卷</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 如果在pod上使用存储卷，只是使用宿主机的目录映射，他会随着宿主机的终结而终，因此宿主机要想实现持久化存储，则该目录应该是宿主机挂载的存储设备上的存储卷。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 在k8s上有那些存储卷可以用？
</span></span><span class="line"><span class="cl">	1) emptyDir：只在节点本地使用，一旦pod删除，该存储卷也会随之删除，生命周期短
</span></span><span class="line"><span class="cl">	2) hostPath：使用主机上的一个路径来作为存储卷
</span></span><span class="line"><span class="cl">	3) SAN(iscsi),NAS(nfs,cifs)
</span></span><span class="line"><span class="cl">	4) 分布式存储：glusterfs  rbd  cephfs
</span></span><span class="line"><span class="cl">	5) 云存储：EBS ..
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">## 查看支持那些存储 kubectl explain pods.spec.volumes
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="81-emptydir案例">8.1 emptyDir案例</h3>
<h4 id="811-例一">8.1.1 例一</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 在第二个容器里写数据，在第一个容器里验证查看  
</span></span><span class="line"><span class="cl">## 查看提示 kubectl explain pods.spec.volumes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## pod-vol-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-damo
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - name: http
</span></span><span class="line"><span class="cl">      containerPort: 80
</span></span><span class="line"><span class="cl">    volumeMounts: 
</span></span><span class="line"><span class="cl">    - name: html   # 在容器中挂载，挂载配置的存储卷的名称
</span></span><span class="line"><span class="cl">      mountPath: /data/web/html/   # 配置挂载路径，这里是容器里面的路径
</span></span><span class="line"><span class="cl">  - name: busybox
</span></span><span class="line"><span class="cl">    image: busybox:latest
</span></span><span class="line"><span class="cl">    volumeMounts: 
</span></span><span class="line"><span class="cl">    - name: html   # 在容器中挂载，挂载配置的存储卷的名称
</span></span><span class="line"><span class="cl">      mountPath: /data/   # 配置挂载路径
</span></span><span class="line"><span class="cl">    command:   
</span></span><span class="line"><span class="cl">    - &#34;/bin/sh&#34;
</span></span><span class="line"><span class="cl">    - &#34;-c&#34;
</span></span><span class="line"><span class="cl">    - &#34;sleep 7200&#34;
</span></span><span class="line"><span class="cl">  volumes:    # 配置存储卷
</span></span><span class="line"><span class="cl">  - name: html   
</span></span><span class="line"><span class="cl">    emptyDir: {}
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl apply -f pod-vol-demo.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看详情
</span></span><span class="line"><span class="cl">kubectl describe pods pod-damo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 进入第二个容器，并写数据
</span></span><span class="line"><span class="cl">kubectl  exec -it pod-damo -c busybox -- /bin/sh
</span></span><span class="line"><span class="cl">echo $(date) &gt;&gt; /data/index.html
</span></span><span class="line"><span class="cl">cat /data/index.html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 进入第一个容器验证
</span></span><span class="line"><span class="cl">kubectl  exec -it pod-damo -c myapp -- /bin/sh
</span></span><span class="line"><span class="cl">cat /data/web/html/index.html
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 删除pod
</span></span><span class="line"><span class="cl">kubectl delete -f pod-vol-demo.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="812-例二">8.1.2 例二</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 第一个容器提供nginx展示网页，第二个容器提供网页数据
</span></span><span class="line"><span class="cl">## pod-vol-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-damo
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - name: http
</span></span><span class="line"><span class="cl">      containerPort: 80
</span></span><span class="line"><span class="cl">    volumeMounts: 
</span></span><span class="line"><span class="cl">    - name: html   # 在容器中挂载，挂载配置的存储卷的名称
</span></span><span class="line"><span class="cl">      mountPath: /usr/share/nginx/html   # 配置挂载路径，这里是容器里面的路径
</span></span><span class="line"><span class="cl">  - name: busybox
</span></span><span class="line"><span class="cl">    image: busybox:latest
</span></span><span class="line"><span class="cl">    volumeMounts: 
</span></span><span class="line"><span class="cl">    - name: html   # 在容器中挂载，挂载配置的存储卷的名称
</span></span><span class="line"><span class="cl">      mountPath: /data/   # 配置挂载路径
</span></span><span class="line"><span class="cl">    command:   
</span></span><span class="line"><span class="cl">    - &#34;/bin/sh&#34;
</span></span><span class="line"><span class="cl">    - &#34;-c&#34;
</span></span><span class="line"><span class="cl">    - &#34;while true; do echo $(date) &gt;&gt; /data/index.html; sleep 2; done&#34;
</span></span><span class="line"><span class="cl">  volumes:    # 配置存储卷
</span></span><span class="line"><span class="cl">  - name: html   
</span></span><span class="line"><span class="cl">    emptyDir: {}
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl apply -f pod-vol-demo.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pod
</span></span><span class="line"><span class="cl">kubectl get pod -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看详情
</span></span><span class="line"><span class="cl">kubectl describe pods pod-damo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 测试
</span></span><span class="line"><span class="cl">curl 10.244.1.44
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="82-hostpath案例">8.2 hostPath案例</h3>
<h4 id="821-例一">8.2.1 例一</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 使用本地存储，生命周期只在该主机上，如果调度到其他节点，则对应的数据也会丢失改变
</span></span><span class="line"><span class="cl">## 查看字段帮助 kuebctl explain pods.spec.volumes.hostPath
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## vim pod-hostpath-vol.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-vol-hostpath
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    volumeMounts:  
</span></span><span class="line"><span class="cl">    - name: html # 挂载卷，这里填下面的卷名称
</span></span><span class="line"><span class="cl">      mountPath: /usr/share/nginx/html/
</span></span><span class="line"><span class="cl">  volumes: 
</span></span><span class="line"><span class="cl">  - name: html
</span></span><span class="line"><span class="cl">    hostPath:
</span></span><span class="line"><span class="cl">      path: /data/pod/volume1
</span></span><span class="line"><span class="cl">      type: DirectoryOrCreate   # 路径的类型
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 由于创建该pod会随机调度到任何一个节点上
</span></span><span class="line"><span class="cl"># 为了演示出效果，分别在每个节点上的创建好相同的目录和不同的主页文件
</span></span><span class="line"><span class="cl">    # node1
</span></span><span class="line"><span class="cl">        mkdir /data/pod/volume1  -p
</span></span><span class="line"><span class="cl">        cat /data/pod/volume1/index.html
</span></span><span class="line"><span class="cl">        node1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # node2
</span></span><span class="line"><span class="cl">        mkdir /data/pod/volume1  -p
</span></span><span class="line"><span class="cl">        cat /data/pod/volume1/index.html
</span></span><span class="line"><span class="cl">        node2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl apply -f pod-hostpath-vol.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pod测试
</span></span><span class="line"><span class="cl">kubectl get pods -o wide
</span></span><span class="line"><span class="cl">curl 10.244.1.45
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 删除测试(会调度到其他节点)
</span></span><span class="line"><span class="cl">kubectl get pods -o wide
</span></span><span class="line"><span class="cl">curl 10.244.1.46
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="822-例二">8.2.2 例二</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 使用第三方存储(nfs存储)，实现持久化存储
</span></span><span class="line"><span class="cl">## 查看帮助 kuebctl explain pods.spec.volumes.nfs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 第三方存储节点
</span></span><span class="line"><span class="cl">[root@storage ~]# yum -y install nfs-utils
</span></span><span class="line"><span class="cl">[root@storage ~]# mkdir /data/volumes -pv
</span></span><span class="line"><span class="cl">[root@storage ~]# cat /etc/exports
</span></span><span class="line"><span class="cl">/data/volumes  k8s节点的网段x.x.x.x/x(rw,no_root_squash)
</span></span><span class="line"><span class="cl">[root@storage ~]# cat /etc/exports
</span></span><span class="line"><span class="cl">[root@storage ~]# systemctl start nfs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## k8s的两个节点要使用nfs
</span></span><span class="line"><span class="cl">[root@node1 ~]# yum install nfs-utils -y 
</span></span><span class="line"><span class="cl">[root@node1 ~]# mount -t nfs storage:/data/volumes /mnt
</span></span><span class="line"><span class="cl">[root@node1 ~]# mount 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[root@node2 ~]# yum install nfs-utils -y 
</span></span><span class="line"><span class="cl">[root@node2 ~]# mount -t nfs storage:/data/volumes /mnt
</span></span><span class="line"><span class="cl">[root@node2 ~]# mount 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## pod-vol-nfs.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-vol-nfs
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    volumeMounts:  
</span></span><span class="line"><span class="cl">    - name: html # 挂载卷，这里填下面的卷名称
</span></span><span class="line"><span class="cl">      mountPath: /usr/share/nginx/html/
</span></span><span class="line"><span class="cl">  volumes: 
</span></span><span class="line"><span class="cl">  - name: html
</span></span><span class="line"><span class="cl">    nfs: /data/volumes
</span></span><span class="line"><span class="cl">    server: nfs存储服务器的地址
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl apply -f pod-vol-nfs.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pod并测试 
</span></span><span class="line"><span class="cl">kubectl get pods -o wide
</span></span><span class="line"><span class="cl">curl 10.244.2.59
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 删除创建测试，会发现无论创建到那个节点，数据都是不变的
</span></span><span class="line"><span class="cl">kubectl delete -f pod-vol-nfs.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f pod-vol-nfs.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="83-pvc案例">8.3 pvc案例</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## pvc是什么？
</span></span><span class="line"><span class="cl">	在pod中只需要定义一个需求大小的存储卷(pvc存储卷)，而pvc存储卷必须与当前名称空间的pv进行绑定关系，而pv应该是某个存储设备上的pv(nfs,iscsi,cephRBD,Glusterfs)
</span></span><span class="line"><span class="cl">	这样一来，比如我定义一个5g大小的pvc，系统则会调度该pvc与能容纳5g的pv建立关系
</span></span><span class="line"><span class="cl">	一个pvc和一个pv是一一对应的，但一个pvc可以支持多个pod访问
</span></span><span class="line"><span class="cl">	还能定义pvc其访问模型：
</span></span><span class="line"><span class="cl">		# kubectl explain pvc.spec.accessModes
</span></span><span class="line"><span class="cl">		# ReadWriteMany多路读写，ReadWriteOnce单路读写。。。
</span></span><span class="line"><span class="cl">	定义回收策略：
</span></span><span class="line"><span class="cl">		retain，表示绑定不存在之后pv数据保留
</span></span><span class="line"><span class="cl">		recycle，回收，将数据全删掉
</span></span><span class="line"><span class="cl">		delete，表示绑定不存在之后将pv删除
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">## 查看字段帮助 kubectl explain pvc.spec
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 第三方存储节点
</span></span><span class="line"><span class="cl">[root@storage ~]# mkdir v{1,2,3,4,5}
</span></span><span class="line"><span class="cl">[root@storage ~]# mkdir v{1,2,3,4,5}
</span></span><span class="line"><span class="cl">[root@storage ~]# cat /etc/exports
</span></span><span class="line"><span class="cl">/data/volumes/v1  k8s节点的网段x.x.x.x/x(rw,no_root_squash)
</span></span><span class="line"><span class="cl">/data/volumes/v2  k8s节点的网段x.x.x.x/x(rw,no_root_squash)
</span></span><span class="line"><span class="cl">/data/volumes/v3  k8s节点的网段x.x.x.x/x(rw,no_root_squash)
</span></span><span class="line"><span class="cl">/data/volumes/v4  k8s节点的网段x.x.x.x/x(rw,no_root_squash)
</span></span><span class="line"><span class="cl">/data/volumes/v5  k8s节点的网段x.x.x.x/x(rw,no_root_squash)
</span></span><span class="line"><span class="cl">[root@storage ~]#
</span></span><span class="line"><span class="cl">[root@storage ~]# exportfs -arv
</span></span><span class="line"><span class="cl">[root@storage ~]# showmount -e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 在k8s节点上定义pv
</span></span><span class="line"><span class="cl">## 查看帮助  kubectl explain pv
</span></span><span class="line"><span class="cl">ps: 定义pv的时候不能给其定义给某个名称空间，pv是集群级别的，所有名称空间都可以使用，但是pvc属于名称空间的
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[root@master ~]# vim pv-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolume
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pv001
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    name: pv001
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  nfs:
</span></span><span class="line"><span class="cl">    path: /data/volumes/v1
</span></span><span class="line"><span class="cl">    server: nfs存储节点地址
</span></span><span class="line"><span class="cl">  accessModes: [&#34;ReadWriteMany&#34;,&#34;ReadWriteOnce&#34;]
</span></span><span class="line"><span class="cl">  # ReadWriteMany多路读写，ReadWriteOnce单路读写。。。
</span></span><span class="line"><span class="cl">  capacity:
</span></span><span class="line"><span class="cl">    storage: 2Gi
</span></span><span class="line"><span class="cl">----
</span></span><span class="line"><span class="cl">apiVersion: v2
</span></span><span class="line"><span class="cl">kind: PersistentVolume
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pv002
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    name: pv002
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  nfs:
</span></span><span class="line"><span class="cl">    path: /data/volumes/v2
</span></span><span class="line"><span class="cl">    server: nfs存储节点地址
</span></span><span class="line"><span class="cl">  accessModes: [&#34;ReadWriteOnce&#34;] # 单路读写
</span></span><span class="line"><span class="cl">    capacity:
</span></span><span class="line"><span class="cl">    storage: 5Gi
</span></span><span class="line"><span class="cl">----
</span></span><span class="line"><span class="cl">apiVersion: v3
</span></span><span class="line"><span class="cl">kind: PersistentVolume
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pv003
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    name: pv003
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  nfs:
</span></span><span class="line"><span class="cl">    path: /data/volumes/v3
</span></span><span class="line"><span class="cl">    server: nfs存储节点地址
</span></span><span class="line"><span class="cl">  accessModes: [&#34;ReadWriteMany&#34;,&#34;ReadWriteOnce&#34;]
</span></span><span class="line"><span class="cl">    capacity:
</span></span><span class="line"><span class="cl">    storage: 10Gi
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 在k8s节点上定义pvc
</span></span><span class="line"><span class="cl">[root@master ~]# vim pod-vol-pvc.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: PersistentVolumeClaim
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mypvc
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  accessModes: [&#34;ReadWriteMany&#34;]  # 访问模型
</span></span><span class="line"><span class="cl">  resources:   # 要求多大空间，大于等于
</span></span><span class="line"><span class="cl">    requests:
</span></span><span class="line"><span class="cl">      storage: 6G
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-vol-pvc
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    volumeMounts:  
</span></span><span class="line"><span class="cl">    - name: html # 挂载卷，这里填下面的卷名称
</span></span><span class="line"><span class="cl">      mountPath: /usr/share/nginx/html/
</span></span><span class="line"><span class="cl">  volumes: 
</span></span><span class="line"><span class="cl">  - name: html
</span></span><span class="line"><span class="cl">    persistentVolumeClaim:
</span></span><span class="line"><span class="cl">      claimName: mypvc   # 这里填写上面定义的pvc的name
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pv
</span></span><span class="line"><span class="cl">kuebctl apply -f pv-demo.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pv
</span></span><span class="line"><span class="cl">kubectl get pv -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod和pvc
</span></span><span class="line"><span class="cl">kubectl apply -f pod-vol-pvc.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pvc
</span></span><span class="line"><span class="cl">kubectl get pvc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看pod
</span></span><span class="line"><span class="cl">kubectl describe pods pod-vol-pvc
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="84-configmap">8.4 configmap</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## configmap扮演了k8s里配置中心的角色,可以让配置信息和镜像信息进行解耦
</span></span><span class="line"><span class="cl">## configmap 可以用来存放一些配置信息，数据是明文的
</span></span><span class="line"><span class="cl">## 配置信息注入：
</span></span><span class="line"><span class="cl">	- 方式1：(配置注入)启动一个pod，可以将configmap关联到pod上去，从configmap读一个数据传递给pod内容器的一个变量
</span></span><span class="line"><span class="cl">	- 方式2：将每一个configmap当一个存储卷，直接将其挂载到pod里容器的目录里
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">## 配置容器化应用的方式：
</span></span><span class="line"><span class="cl">	1、自定义命令行参数
</span></span><span class="line"><span class="cl">		command
</span></span><span class="line"><span class="cl">		args
</span></span><span class="line"><span class="cl">	2、把配置文件直接打入镜像
</span></span><span class="line"><span class="cl">	3、环境变量
</span></span><span class="line"><span class="cl">		- cloud Native的应用程序一般可直接通过环境变量加载配置
</span></span><span class="line"><span class="cl">		- 通过entrypoint脚本来预处理变量为配置文件中的配置信息
</span></span><span class="line"><span class="cl">	4、存储卷
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="841-创建configmap">8.4.1 创建configmap</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 查看帮助 kubectl explain pods.spec.containers.env.valueFrom
</span></span><span class="line"><span class="cl">	帮助简写kubectl explain cm(configmap)
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 创建configmap(直接给定kv)
</span></span><span class="line"><span class="cl">kubectl create configmap nginx-config --from-literal=nginx_port=80 --from-literal=server_name=myapp.magede.com
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看结果
</span></span><span class="line"><span class="cl">kubectl get cm 
</span></span><span class="line"><span class="cl">kubectl describe cm nginx-config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建configmap(k自定义v是文件的内容)
</span></span><span class="line"><span class="cl">kubectl create configmap nginx-www --from-file=www=./www.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看结果
</span></span><span class="line"><span class="cl">kubectl get cm 
</span></span><span class="line"><span class="cl">kubectl get cm nginx-www -o yaml
</span></span><span class="line"><span class="cl">kubectl describe cm nginx-www
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="842-configamp注入">8.4.2 configamp注入</h4>
<h5 id="8421-通过环境变量注入">8.4.2.1 通过环境变量注入</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 查看帮助 kubectl explain pods.spec.containers.env.valueFrom.configMapRef
</span></span><span class="line"><span class="cl">	帮助简写kubectl explain cm(configmap)
</span></span><span class="line"><span class="cl">## 将configmap里的kv注入到pod
</span></span><span class="line"><span class="cl">		1、环境变量方式传递
</span></span><span class="line"><span class="cl">			- cloud Native的应用程序一般可直接通过环境变量加载配置
</span></span><span class="line"><span class="cl">			- 通过entrypoint脚本来预处理变量为配置文件中的配置信息
</span></span><span class="line"><span class="cl">		2、挂载卷方式
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">## pod-configmap.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-cm-1
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    magede.com/created-by: &#34;cluster admin&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - name: http
</span></span><span class="line"><span class="cl">      containerPort: 80
</span></span><span class="line"><span class="cl">    env:   # 容器的属性
</span></span><span class="line"><span class="cl">    - name: NGINX_SERVER_PORT   # 将值传递给这个变量
</span></span><span class="line"><span class="cl">      vlaueFrom:    # 通过那种方式获取数据
</span></span><span class="line"><span class="cl">        configMapKeyRef:
</span></span><span class="line"><span class="cl">          name: nginx-config  # configmap的名字
</span></span><span class="line"><span class="cl">          key: nginx_port   # configmap里面对应的key,将其传递给NGINX_SERVER_PORT
</span></span><span class="line"><span class="cl">    - name:NGINX_SERVER_NAME
</span></span><span class="line"><span class="cl">      valueFrom:
</span></span><span class="line"><span class="cl">        configMapKeyRef:
</span></span><span class="line"><span class="cl">          name: nginx-config
</span></span><span class="line"><span class="cl">          key: server_name
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl apply -f pod-configmap.yaml
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl"># 查看结果
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">kubectl exec -it pod-cm-1 --/bin/sh
</span></span><span class="line"><span class="cl">print
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 修改configmap数据(如果是通过环境变量注入时，只在pod创建时获取，所以后期改了也没用)
</span></span><span class="line"><span class="cl">kubectl edit cm nginx-config
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="8422-通过挂载卷注入">8.4.2.2 通过挂载卷注入</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 查看帮助 kubectl explain pods.spec.containers.env.valueFrom.configMapRef
</span></span><span class="line"><span class="cl">	帮助简写kubectl explain cm(configmap)
</span></span><span class="line"><span class="cl">## 以挂载卷的方式注入则可以看见对应configmap卷里面的所有kv，当然也可以设置只显示部分kv
</span></span><span class="line"><span class="cl">	kubectl explain pods.epec.volumes.configMap.items
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">## pod-configmap-2.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-cm-2
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    magede.com/created-by: &#34;cluster admin&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - name: http
</span></span><span class="line"><span class="cl">      containerPort: 80
</span></span><span class="line"><span class="cl">    volumeMounts:    # 在容器中挂载
</span></span><span class="line"><span class="cl">    - name: nginxconf    # 挂载的卷名，与下面对应
</span></span><span class="line"><span class="cl">      mountPath: /etc/nginx/config.d/     # 挂载到哪里去
</span></span><span class="line"><span class="cl">      readOnly: true   # 不容容器修改其内容
</span></span><span class="line"><span class="cl">  volumes:
</span></span><span class="line"><span class="cl">  - name: nginxconf   # 存储卷名称
</span></span><span class="line"><span class="cl">    configMap:     # 存储卷类型
</span></span><span class="line"><span class="cl">      name: nginx-config    # configmap名称
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl apply -f pod-configmap.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看结果
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">kubectl exec -it pod-cm-2 --/bin/sh
</span></span><span class="line"><span class="cl">	cd/etc/nginx/config.d
</span></span><span class="line"><span class="cl">    ls
</span></span><span class="line"><span class="cl">    cat nginx_port
</span></span><span class="line"><span class="cl">    cat server_name
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"># 修改下cm
</span></span><span class="line"><span class="cl">kubectl get cm
</span></span><span class="line"><span class="cl">kubectl edit cm nginx-config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看结果会发现对应的变量值会发生变化，需要等个随机时间然后就会生效
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps: 如果端口改变，对应服务需要重启一下才可以生效
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="85-secret">8.5 secret</h3>
<h4 id="851-secret创建">8.5.1 secret创建</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 功能和configmap一样，不同的是secret数据是密文(base64加密)存放的
</span></span><span class="line"><span class="cl">## 常用于私钥和证书，密码之类的，需要加密的值
</span></span><span class="line"><span class="cl">## 查看帮助 kubectl create secret generic --htlp
</span></span><span class="line"><span class="cl">		docker-registry		创建一个连接docker私有仓库做认证的使用这种
</span></span><span class="line"><span class="cl">		generic		除其他两种之外都是这种
</span></span><span class="line"><span class="cl">		tls		往secret放证书和私钥的就这种
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建scret
</span></span><span class="line"><span class="cl">kubectl create secret generic mysql-root-password --from-literal=password=123
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看
</span></span><span class="line"><span class="cl">kubectl get secret
</span></span><span class="line"><span class="cl">kubectl describe secret mysql-root-password
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps: 一般搞这种密码，可以通过挂在卷挂载给pod，然后再设置权限
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="852-secret注入">8.5.2 secret注入</h4>
<h5 id="8521-环境变量注入">8.5.2.1 环境变量注入</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 查看帮助 kubectl create secret generic --htlp
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">##  pod-secret-1.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-secret-1
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    magede.com/created-by: &#34;cluster admin&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - name: http
</span></span><span class="line"><span class="cl">      containerPort: 80
</span></span><span class="line"><span class="cl">    env:   # 容器的属性
</span></span><span class="line"><span class="cl">    - name: MYSQL_ROOT_PASSWORD   # 将值传递给这个变量
</span></span><span class="line"><span class="cl">      vlaueFrom:    # 通过那种方式获取数据
</span></span><span class="line"><span class="cl">        secretKeyRef:
</span></span><span class="line"><span class="cl">          name: mysql-root-password  # secret的名字
</span></span><span class="line"><span class="cl">          key: password  # secret里面对应的key,将其传递给NGINX_SERVER_PORT
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl apply -f pod-secret-1.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">kuebctl exec pod-secret-1 -- printenv
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="9-statefulset">9 statefulset</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 有状态应用副本级
</span></span><span class="line"><span class="cl">1、稳定且唯一的网络标识符
</span></span><span class="line"><span class="cl">2、稳定且持久的存储
</span></span><span class="line"><span class="cl">3、有序、平滑的部署和扩展
</span></span><span class="line"><span class="cl">4、有序、平滑的删除和终止
</span></span><span class="line"><span class="cl">5、有序的滚动更新
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 三个组件：
</span></span><span class="line"><span class="cl">	headless service
</span></span><span class="line"><span class="cl">	StatefulSet
</span></span><span class="line"><span class="cl">	VolumeClaimTemplate 	卷申请模板
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">## VolumeClaimTemplate： 可以为每一个pod定义volume，在pod所在的名称空间中自动创建pvc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps： 无论如何创建他都会绑定固定的pvc应为它的创建和删除顺序都是固定的，创建从0-n删除从n-0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="91-statefulset使用">9.1 statefulset使用</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 查看帮助 kubectl explain sts.spec
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 实验：首先创建一个pod，pod里的volume是pvc类型的，这个pvc类型的volume应该关联到统一名词空间的pvc，而这个pvc关联到集群级别的pv
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## stateful-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: myapp
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - port: 80
</span></span><span class="line"><span class="cl">    name: web
</span></span><span class="line"><span class="cl">  clusterIP: None
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: myapp-pod
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: StatefulSet
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: myapp
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  serviceName: &#34;myapp&#34;
</span></span><span class="line"><span class="cl">  replicas: 3
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: myapp-pod
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: myapp-pod
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: myapp
</span></span><span class="line"><span class="cl">        image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - containerPort: 80
</span></span><span class="line"><span class="cl">          name: web
</span></span><span class="line"><span class="cl">        volumeMounts:
</span></span><span class="line"><span class="cl">        - name: myappdata
</span></span><span class="line"><span class="cl">          mountPath: /usr/share/nginx/html
</span></span><span class="line"><span class="cl">  volumeClaimTemplates:
</span></span><span class="line"><span class="cl">  - metadata:
</span></span><span class="line"><span class="cl">      name: myappdata
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      accessModes: [ &#34;ReadWriteOnce&#34; ]
</span></span><span class="line"><span class="cl">      resources:
</span></span><span class="line"><span class="cl">        requests:
</span></span><span class="line"><span class="cl">          storage: 1Gi
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 创建
</span></span><span class="line"><span class="cl">kubectl apply -f stateful-demo.yaml
</span></span><span class="line"><span class="cl">kubectl get sts
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 扩容
</span></span><span class="line"><span class="cl">kubectl get sts
</span></span><span class="line"><span class="cl">kubectl scale sts myapp --replicas=5
</span></span><span class="line"><span class="cl">lubectl get pods -w
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 升级
</span></span><span class="line"><span class="cl">    查看帮助：kubectl explain sts.spec.updateStrategy.rollingUpdate
</span></span><span class="line"><span class="cl">    partition：N，则大于等于N的更新,例如有四个pod可以设置N=3则只更新第四个，就是实现了金丝雀更新
</span></span><span class="line"><span class="cl">    kubectl describe sts myapp
</span></span><span class="line"><span class="cl"># 设置更新规则
</span></span><span class="line"><span class="cl">    kubectl patch sts myapp -p &#39;{&#34;spec&#34;:{&#34;updateStrategy&#34;:{&#34;rollingUpdate&#34;:{&#34;partition&#34;:4}}}}&#39;
</span></span><span class="line"><span class="cl"># 更新
</span></span><span class="line"><span class="cl">    kubectl set image sts/myapp myapp=ikubernetes/myapp:v2
</span></span><span class="line"><span class="cl">    kubectl get sts -o wide
</span></span><span class="line"><span class="cl"># 如果没问题则将更新规则partition改为0，然后再次更新就全部更新了
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## dns解析
</span></span><span class="line"><span class="cl">方法：pod_name.service_name.ns_name.svc.cluster.local
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl exec -it myapp- --/bin/sh
</span></span><span class="line"><span class="cl">nslookup myapp-0.myapp.default.svc.cluster.local
</span></span><span class="line"><span class="cl">nslookup myapp-1.myapp.default.svc.cluster.local
</span></span><span class="line"><span class="cl">nslookup myapp-2.myapp.default.svc.cluster.local
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="10-k8s认证授权准入控制">10 k8s认证,授权,准入控制</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## kubectl客户端接入(k8s)ApiServer时要经过  &gt;&gt;   认证，授权，准入控制
</span></span><span class="line"><span class="cl">	kubectl的配置信息放在 /root/.kube/config里面，配置信息里包含着客户端证书客户端私钥
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## k8s账号分为两种：
</span></span><span class="line"><span class="cl">	kubectl explain pods.spec
</span></span><span class="line"><span class="cl">	普通用户： useraccount
</span></span><span class="line"><span class="cl">	pod用户：serviceAccount
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## kubectl客户端分两种
</span></span><span class="line"><span class="cl">	集群内部客户端： 与apiserver通信时使用 10.96.0.1 这个地址
</span></span><span class="line"><span class="cl">				kubectl get svc
</span></span><span class="line"><span class="cl">				kubectl describe svc kubernetes
</span></span><span class="line"><span class="cl">	集群外部客户端： apiserver 对外通信的监听地址来与外部客户端通信
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 客户端访问 API server 包含的信息
</span></span><span class="line"><span class="cl">    user: username,uid
</span></span><span class="line"><span class="cl">    group：组
</span></span><span class="line"><span class="cl">    extra: 提供额外信息
</span></span><span class="line"><span class="cl">    API：用于请求特定的API
</span></span><span class="line"><span class="cl">    Request path：http://x.x.x.x:6443/apis/apps/v1/namespaces/default/deployments/myapp-deploy/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 为pod获取私有镜像的两种方式
</span></span><span class="line"><span class="cl">	1、在pod里面直接使用imagepullsecrets的字段指定能完成的使用的secrets对象
</span></span><span class="line"><span class="cl">	2、在pod上自定义sa(serviceaccount),在serviceaccount里面再指定pod获取镜像时使用的secrets对象
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 操作k8s资源
</span></span><span class="line"><span class="cl">    # 起一个kubectl代理
</span></span><span class="line"><span class="cl">    kubectl proxy --port=8080
</span></span><span class="line"><span class="cl">    # 访问资源s
</span></span><span class="line"><span class="cl">    curl http://127.0.0.1:8080/apis/apps/v1/namespaces/kube-system/deployments
</span></span><span class="line"><span class="cl">    常用的增删改查
</span></span><span class="line"><span class="cl">        http request verb：
</span></span><span class="line"><span class="cl">            get,post,put,delete
</span></span><span class="line"><span class="cl">        API request verb：
</span></span><span class="line"><span class="cl">            get,list,create,update,patch,watch,delete....
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="101-认证">10.1 认证</h3>
<h4 id="1011-创建sa">10.1.1 创建SA</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 基本操作
</span></span><span class="line"><span class="cl"># 命令行创建
</span></span><span class="line"><span class="cl">kubectl create serviceaccount mysa --dry-run 
</span></span><span class="line"><span class="cl">kubectl create serviceaccount mysa -o yaml --dry-run
</span></span><span class="line"><span class="cl">kubectl create serviceaccount admin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看
</span></span><span class="line"><span class="cl">kubectl get sa
</span></span><span class="line"><span class="cl">kubectl describe sa admin
</span></span><span class="line"><span class="cl">kubectl get secret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># [root@master ~]# vim pod-sa-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-sa-damo
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - name: http
</span></span><span class="line"><span class="cl">      containerPort: 80
</span></span><span class="line"><span class="cl">  serviceAccountName: admin
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"># 创建pod使用自定义sa
</span></span><span class="line"><span class="cl">kubectl apply -f pod-sa-demo.yaml
</span></span><span class="line"><span class="cl">kubectl describe pod pod-sa-demo
</span></span><span class="line"><span class="cl">kubectl get secret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps: 账户的一些认证信息是存放在secret里面的
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1012-自定义账号认证">10.1.2 自定义账号认证</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">### 自定义账号接入kubectl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># kubectl客户端是有自己的配置文件的
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl config -h
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl config view
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">clusters:	// 集群列表
</span></span><span class="line"><span class="cl">- cluster:		
</span></span><span class="line"><span class="cl">    certificate-authority-data: DATA+OMITTED
</span></span><span class="line"><span class="cl">    server: https://192.168.101.67:6443
</span></span><span class="line"><span class="cl">  name: kubernetes
</span></span><span class="line"><span class="cl">contexts:		// 指明用哪个账号访问那个集群
</span></span><span class="line"><span class="cl">- context:
</span></span><span class="line"><span class="cl">    cluster: kubernetes
</span></span><span class="line"><span class="cl">    user: kubernetes-admin	// 用kubernetes-admin账号访问kubernetes集群
</span></span><span class="line"><span class="cl">  name: kubernetes-admin@kubernetes	  
</span></span><span class="line"><span class="cl">current-context: kubernetes-admin@kubernetes   // 表示该配置文件使用的是kubernetes-admin账号
</span></span><span class="line"><span class="cl">kind: Config
</span></span><span class="line"><span class="cl">preferences: {}
</span></span><span class="line"><span class="cl">users:	// 用户列表
</span></span><span class="line"><span class="cl">- name: kubernetes-admin
</span></span><span class="line"><span class="cl">  user:
</span></span><span class="line"><span class="cl">    client-certificate-data: REDACTED
</span></span><span class="line"><span class="cl">    client-key-data: REDACTED
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 生成私钥
</span></span><span class="line"><span class="cl">[root@master pki]# pwd
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki
</span></span><span class="line"><span class="cl">[root@master pki]# (umask 077; openssl genrsa -out magedu.key 2048)
</span></span><span class="line"><span class="cl">Generating RSA private key, 2048 bit long modulus
</span></span><span class="line"><span class="cl">.................................+++
</span></span><span class="line"><span class="cl">............+++
</span></span><span class="line"><span class="cl">e is 65537 (0x10001)
</span></span><span class="line"><span class="cl">[root@master pki]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 证书签署请求
</span></span><span class="line"><span class="cl">[root@master pki]# openssl req -new -key magedu.key -out magedu.csr -subj &#34;/CN=magedu&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 签署证书
</span></span><span class="line"><span class="cl">[root@master pki]# openssl x509 -req -in magedu.csr -CA ./ca.crt -CAkey ./ca.key -CAcreateserial -out magedu.crt -days 365
</span></span><span class="line"><span class="cl">Signature ok
</span></span><span class="line"><span class="cl">subject=/CN=magedu
</span></span><span class="line"><span class="cl">Getting CA Private Key
</span></span><span class="line"><span class="cl">[root@master pki]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 设置配置文件里的用户
</span></span><span class="line"><span class="cl">kubectl config set-credentials magedu --client-certificate=./magedu.crt --client-key=./magedu.key --embed-certs=true
</span></span><span class="line"><span class="cl">kubectl config view
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 设置上下文，让magedu也能访问集群
</span></span><span class="line"><span class="cl">kubectl config set-context magedu@kubernetes --cluster=kubernetes --user=magedu
</span></span><span class="line"><span class="cl">kubectl config view
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 使用新创建的账号
</span></span><span class="line"><span class="cl">kubectl config use-context magedu@kubernetes
</span></span><span class="line"><span class="cl">kubectl config view
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1013-新定义kubectl配置文件">10.1.3 新定义kubectl配置文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 自定义配置文件路径
</span></span><span class="line"><span class="cl">kubectl config --help
</span></span><span class="line"><span class="cl">kubectl config set-cluster mycluster --kubeconfig=/tmp/test.conf --server=&#34;https://192.168.101.67:6443&#34; --certificate-authority=/etc/kubernetes/pki/ca.crt --embed-certs=true
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl config view --kubeconfig=/tmp/test.conf
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="102-rbac-授权">10.2 RBAC 授权</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 授权插件：Node，ABAC，RBAC，Webhook
</span></span><span class="line"><span class="cl">	RBAC: 基于角色访问控制
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># RBAC原理：首先创建账号(sa，userAccount),将账号(sa，普通用户)绑定role，则使用该账号(sa，普通用户)的用户或pod就有了role定义的权限	
</span></span><span class="line"><span class="cl">			能与role绑定的除了账号，还包括group
</span></span><span class="line"><span class="cl">			如果绑定的是sa，则使用sa的pod就有了对role所赋予的权限
</span></span><span class="line"><span class="cl">			如果绑定的是group，则group内所有账号都有role所赋予的权限
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl"># RBAC工作资源类型: 
</span></span><span class="line"><span class="cl">	1、role：
</span></span><span class="line"><span class="cl">		operations
</span></span><span class="line"><span class="cl">		objects
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	2、rolebinding：
</span></span><span class="line"><span class="cl">		user account OR service account
</span></span><span class="line"><span class="cl">		rolesa
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	3、上两种属于名称空间级别，即只作用于当前名称空间
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	4、clusterRole：
</span></span><span class="line"><span class="cl">		如果账号(sa，userAccount)使用 rolebinding 绑定clusterRole，则clusterRole定义的权限只对rolebinding所在的名称空间生效
</span></span><span class="line"><span class="cl">		如果账号(sa，userAccount)使用 clusterrolebinding 绑定 clusterRole 则clusterRole定义的权限对所有名称空间生效
</span></span><span class="line"><span class="cl">	5、clusterrolebinding
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps：一般而言当要设置管理员授权时，不需要定义role，直接通过rolebinding引用clusterRole,
</span></span><span class="line"><span class="cl">		例如要创建一个管理员的授权，就直接通过rolebinding引用admin(集群级role)就可以了
</span></span><span class="line"><span class="cl">		kubectl create rolebinding default-ns-admin --clusterrole=admin --user=magedu
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1021-创建-role">10.2.1 创建 role</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 命令行创建
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl create role pods-reader --verb=get,list,watch --resource=pods --dry-run -o yaml
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: Role
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: null
</span></span><span class="line"><span class="cl">  name: pods-reader
</span></span><span class="line"><span class="cl">rules:
</span></span><span class="line"><span class="cl">- apiGroups:
</span></span><span class="line"><span class="cl">  - &#34;&#34;
</span></span><span class="line"><span class="cl">  resources:
</span></span><span class="line"><span class="cl">  - pods
</span></span><span class="line"><span class="cl">  verbs:
</span></span><span class="line"><span class="cl">  - get
</span></span><span class="line"><span class="cl">  - list
</span></span><span class="line"><span class="cl">  - watch
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 配置文件创建
</span></span><span class="line"><span class="cl">[root@master ~]# cat role-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: Role
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pods-reader
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">rules:
</span></span><span class="line"><span class="cl">- apiGroups:
</span></span><span class="line"><span class="cl">  - &#34;&#34;
</span></span><span class="line"><span class="cl">  resources:
</span></span><span class="line"><span class="cl">  - pods
</span></span><span class="line"><span class="cl">  verbs:
</span></span><span class="line"><span class="cl">  - get
</span></span><span class="line"><span class="cl">  - list
</span></span><span class="line"><span class="cl">  - watch
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f role-demo.yaml
</span></span><span class="line"><span class="cl">role.rbac.authorization.k8s.io/pods-reader created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get role
</span></span><span class="line"><span class="cl">NAME          AGE
</span></span><span class="line"><span class="cl">pods-reader   11s
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl describe role pods-reader
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1022-创建-rolebinding">10.2.2 创建 rolebinding</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 使用(userAccount)账号绑定角色
</span></span><span class="line"><span class="cl">## 命令行创建
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl create rolebinding magedu-read-pods --role=pods-reader --user=magedu --dry-run -o yaml
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: RoleBinding
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: null
</span></span><span class="line"><span class="cl">  name: magedu-read-pods
</span></span><span class="line"><span class="cl">roleRef:
</span></span><span class="line"><span class="cl">  apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: Role
</span></span><span class="line"><span class="cl">  name: pods-reader
</span></span><span class="line"><span class="cl">subjects:
</span></span><span class="line"><span class="cl">- apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: User
</span></span><span class="line"><span class="cl">  name: magedu
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## yaml文件创建
</span></span><span class="line"><span class="cl">[root@master ~]# cat rolebinding-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: RoleBinding
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: null
</span></span><span class="line"><span class="cl">  name: magedu-read-pods
</span></span><span class="line"><span class="cl">roleRef:
</span></span><span class="line"><span class="cl">  apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: Role  
</span></span><span class="line"><span class="cl">  name: pods-reader  // role名称
</span></span><span class="line"><span class="cl">subjects:
</span></span><span class="line"><span class="cl">- apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: User
</span></span><span class="line"><span class="cl">  name: magedu  // 账号名称
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f rolebinding-demo.yaml
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/magedu-read-pods created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get rolebinding
</span></span><span class="line"><span class="cl">NAME               AGE
</span></span><span class="line"><span class="cl">magedu-read-pods   15s
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 测试
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl config use-context magedu@kubernetes
</span></span><span class="line"><span class="cl">Switched to context &#34;magedu@kubernetes&#34;.
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get pods
</span></span><span class="line"><span class="cl">NAME          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-sa-damo   1/1     Running   1          27h
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get pods -n kube-system
</span></span><span class="line"><span class="cl">Error from server (Forbidden): pods is forbidden: User &#34;magedu&#34; cannot list resource &#34;pods&#34; in API group &#34;&#34; in the namespace &#34;kube-system&#34;
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps：账号(sa，userAccount)使用rolebinding绑定role,则role定义的权限只在role所在的名称空间生效
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1023-创建-clusterrole">10.2.3 创建 clusterRole</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 命令行创建
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl create clusterrole cluster-reader --verb=get,list,watch --resource=pods --dry-run -o yaml                                                           apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: ClusterRole
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: null
</span></span><span class="line"><span class="cl">  name: cluster-reader
</span></span><span class="line"><span class="cl">rules:
</span></span><span class="line"><span class="cl">- apiGroups:
</span></span><span class="line"><span class="cl">  - &#34;&#34;
</span></span><span class="line"><span class="cl">  resources:
</span></span><span class="line"><span class="cl">  - pods
</span></span><span class="line"><span class="cl">  verbs:
</span></span><span class="line"><span class="cl">  - get
</span></span><span class="line"><span class="cl">  - list
</span></span><span class="line"><span class="cl">  - watch
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 配置文件创建
</span></span><span class="line"><span class="cl">[root@master ~]# cat clusterrole-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: ClusterRole
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: cluster-reader
</span></span><span class="line"><span class="cl">rules:
</span></span><span class="line"><span class="cl">- apiGroups:
</span></span><span class="line"><span class="cl">  - &#34;&#34;
</span></span><span class="line"><span class="cl">  resources:
</span></span><span class="line"><span class="cl">  - pods
</span></span><span class="line"><span class="cl">  verbs:
</span></span><span class="line"><span class="cl">  - get
</span></span><span class="line"><span class="cl">  - list
</span></span><span class="line"><span class="cl">  - watch
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f clusterrole-demo.yaml
</span></span><span class="line"><span class="cl">clusterrole.rbac.authorization.k8s.io/cluster-reader created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get clusterrole
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## magedu账号(userAccount)使用rolebinding绑定clusterRole
</span></span><span class="line"><span class="cl">## clusterRole定义的权限只对rolebinding所在的名称空间有效
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl create rolebinding magedu-read-pods --clusterrole=cluster-reader --user=magedu --dry-run -o yaml  apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: RoleBinding
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: null
</span></span><span class="line"><span class="cl">  name: magedu-read-pods
</span></span><span class="line"><span class="cl">roleRef:
</span></span><span class="line"><span class="cl">  apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: ClusterRole
</span></span><span class="line"><span class="cl">  name: cluster-reader
</span></span><span class="line"><span class="cl">subjects:
</span></span><span class="line"><span class="cl">- apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: User
</span></span><span class="line"><span class="cl">  name: magedu
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">[root@master ~]# cat rolebinding-clusterrole.yaml
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: RoleBinding
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: magedu-read-pods
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">roleRef:
</span></span><span class="line"><span class="cl">  apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: ClusterRole
</span></span><span class="line"><span class="cl">  name: cluster-reader
</span></span><span class="line"><span class="cl">subjects:
</span></span><span class="line"><span class="cl">- apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: User
</span></span><span class="line"><span class="cl">  name: magedu
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f rolebinding-clusterrole.yaml
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/magedu-read-pods created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get rolebinding
</span></span><span class="line"><span class="cl">NAME               AGE
</span></span><span class="line"><span class="cl">magedu-read-pods   2m21s
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 这样一来ik8s用户使用magedu@kubernetes这个账号时，
</span></span><span class="line"><span class="cl">## clusterRole定义的权限只能对rolebinding所在的名称空间生效。
</span></span><span class="line"><span class="cl">## ps：ik8s用户使用kubectl，它的k8s账户是magedu@kubernetes
</span></span><span class="line"><span class="cl">## 该账户的权限取决于它关联的role或者clusterRole
</span></span><span class="line"><span class="cl">[root@master ~]# useradd ik8s
</span></span><span class="line"><span class="cl">[root@master ~]# cp -rp .kube/ /home/ik8s/
</span></span><span class="line"><span class="cl">[root@master ~]# chown -R ik8s.ik8s /home/ik8s/
</span></span><span class="line"><span class="cl">[root@master ~]# su - ik8s
</span></span><span class="line"><span class="cl">[ik8s@master ~]$ kubectl config view
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">clusters:
</span></span><span class="line"><span class="cl">- cluster:
</span></span><span class="line"><span class="cl">    certificate-authority-data: DATA+OMITTED
</span></span><span class="line"><span class="cl">    server: https://192.168.101.67:6443
</span></span><span class="line"><span class="cl">  name: kubernetes
</span></span><span class="line"><span class="cl">contexts:
</span></span><span class="line"><span class="cl">- context:
</span></span><span class="line"><span class="cl">    cluster: kubernetes
</span></span><span class="line"><span class="cl">    user: kubernetes-admin
</span></span><span class="line"><span class="cl">  name: kubernetes-admin@kubernetes
</span></span><span class="line"><span class="cl">- context:
</span></span><span class="line"><span class="cl">    cluster: kubernetes
</span></span><span class="line"><span class="cl">    user: magedu
</span></span><span class="line"><span class="cl">  name: magedu@kubernetes
</span></span><span class="line"><span class="cl">current-context: kubernetes-admin@kubernetes
</span></span><span class="line"><span class="cl">kind: Config
</span></span><span class="line"><span class="cl">preferences: {}
</span></span><span class="line"><span class="cl">users:
</span></span><span class="line"><span class="cl">- name: kubernetes-admin
</span></span><span class="line"><span class="cl">  user:
</span></span><span class="line"><span class="cl">    client-certificate-data: REDACTED
</span></span><span class="line"><span class="cl">    client-key-data: REDACTED
</span></span><span class="line"><span class="cl">- name: magedu
</span></span><span class="line"><span class="cl">  user:
</span></span><span class="line"><span class="cl">    client-certificate-data: REDACTED
</span></span><span class="line"><span class="cl">    client-key-data: REDACTED
</span></span><span class="line"><span class="cl">[ik8s@master ~]$ kubectl config use-context magedu@kubernetes
</span></span><span class="line"><span class="cl">Switched to context &#34;magedu@kubernetes&#34;.
</span></span><span class="line"><span class="cl">[ik8s@master ~]
</span></span><span class="line"><span class="cl">[ik8s@master ~]$ kubectl get pods -n default
</span></span><span class="line"><span class="cl">NAME          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod-sa-damo   1/1     Running   1          28h
</span></span><span class="line"><span class="cl">[ik8s@master ~]$ kubectl get pods -n kube-system
</span></span><span class="line"><span class="cl">Error from server (Forbidden): pods is forbidden: User &#34;magedu&#34; cannot list resource &#34;pods&#34; in API group &#34;&#34; in the namespace &#34;kube-system&#34;
</span></span><span class="line"><span class="cl">[ik8s@master ~]$
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1024-创建-clusterrolebinding">10.2.4 创建 clusterRolebinding</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 命令行创建
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl create clusterrolebinding magedu-read-all-pods --clusterrole=cluster-reader --user=magedu --dry-run -o yaml                               apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span><span class="line"><span class="cl">kind: ClusterRoleBinding
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: null
</span></span><span class="line"><span class="cl">  name: magedu-read-all-pods
</span></span><span class="line"><span class="cl">roleRef:
</span></span><span class="line"><span class="cl">  apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: ClusterRole
</span></span><span class="line"><span class="cl">  name: cluster-reader
</span></span><span class="line"><span class="cl">subjects:
</span></span><span class="line"><span class="cl">- apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: User
</span></span><span class="line"><span class="cl">  name: magedu
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get clusterrolebinding
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 将账号(userAccount)通过clusterRolebinding绑定clusterRole
</span></span><span class="line"><span class="cl">[root@master ~]# cat clusterrolebinding.yaml
</span></span><span class="line"><span class="cl">apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span><span class="line"><span class="cl">kind: ClusterRoleBinding
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: magedu-read-all-pods
</span></span><span class="line"><span class="cl">roleRef:
</span></span><span class="line"><span class="cl">  apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: ClusterRole
</span></span><span class="line"><span class="cl">  name: cluster-reader
</span></span><span class="line"><span class="cl">subjects:
</span></span><span class="line"><span class="cl">- apiGroup: rbac.authorization.k8s.io
</span></span><span class="line"><span class="cl">  kind: User
</span></span><span class="line"><span class="cl">  name: magedu
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f clusterrolebinding.yaml
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/magedu-read-all-pods created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get clusterrolebinding
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 这个时候其他用户使用magedu这个账号就可以访问所有名称空间的资源了
</span></span><span class="line"><span class="cl">## ps：ik8s用户使用kubectl，它的k8s账户是magedu@kubernetes
</span></span><span class="line"><span class="cl">## 该账户的权限取决于它关联的role或者clusterRole
</span></span><span class="line"><span class="cl">[root@master ~]# useradd ik8s
</span></span><span class="line"><span class="cl">[root@master ~]# cp -rp .kube/ /home/ik8s/
</span></span><span class="line"><span class="cl">[root@master ~]# chown -R ik8s.ik8s /home/ik8s/
</span></span><span class="line"><span class="cl">[root@master ~]# su - ik8s
</span></span><span class="line"><span class="cl">[ik8s@master ~]$ kubectl config view
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">clusters:
</span></span><span class="line"><span class="cl">- cluster:
</span></span><span class="line"><span class="cl">    certificate-authority-data: DATA+OMITTED
</span></span><span class="line"><span class="cl">    server: https://192.168.101.67:6443
</span></span><span class="line"><span class="cl">  name: kubernetes
</span></span><span class="line"><span class="cl">contexts:
</span></span><span class="line"><span class="cl">- context:
</span></span><span class="line"><span class="cl">    cluster: kubernetes
</span></span><span class="line"><span class="cl">    user: kubernetes-admin
</span></span><span class="line"><span class="cl">  name: kubernetes-admin@kubernetes
</span></span><span class="line"><span class="cl">- context:
</span></span><span class="line"><span class="cl">    cluster: kubernetes
</span></span><span class="line"><span class="cl">    user: magedu
</span></span><span class="line"><span class="cl">  name: magedu@kubernetes
</span></span><span class="line"><span class="cl">current-context: kubernetes-admin@kubernetes
</span></span><span class="line"><span class="cl">kind: Config
</span></span><span class="line"><span class="cl">preferences: {}
</span></span><span class="line"><span class="cl">users:
</span></span><span class="line"><span class="cl">- name: kubernetes-admin
</span></span><span class="line"><span class="cl">  user:
</span></span><span class="line"><span class="cl">    client-certificate-data: REDACTED
</span></span><span class="line"><span class="cl">    client-key-data: REDACTED
</span></span><span class="line"><span class="cl">- name: magedu
</span></span><span class="line"><span class="cl">  user:
</span></span><span class="line"><span class="cl">    client-certificate-data: REDACTED
</span></span><span class="line"><span class="cl">    client-key-data: REDACTED
</span></span><span class="line"><span class="cl">[ik8s@master ~]$ kubectl config use-context magedu@kubernetes
</span></span><span class="line"><span class="cl">Switched to context &#34;magedu@kubernetes&#34;.
</span></span><span class="line"><span class="cl">[ik8s@master ~]$ kubectl get pods -n kube-system
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-bccdc95cf-87dnm          1/1     Running   54         91d
</span></span><span class="line"><span class="cl">coredns-bccdc95cf-xk5r6          1/1     Running   54         91d
</span></span><span class="line"><span class="cl">etcd-master                      1/1     Running   8          91d
</span></span><span class="line"><span class="cl">kube-apiserver-master            1/1     Running   8          91d
</span></span><span class="line"><span class="cl">kube-controller-manager-master   1/1     Running   11         91d
</span></span><span class="line"><span class="cl">kube-flannel-ds-54gjv            1/1     Running   5          91d
</span></span><span class="line"><span class="cl">kube-flannel-ds-6kkm9            1/1     Running   5          91d
</span></span><span class="line"><span class="cl">kube-flannel-ds-sftk6            1/1     Running   9          91d
</span></span><span class="line"><span class="cl">kube-proxy-krlxl                 1/1     Running   5          91d
</span></span><span class="line"><span class="cl">kube-proxy-wxxkg                 1/1     Running   8          91d
</span></span><span class="line"><span class="cl">kube-proxy-zbgqg                 1/1     Running   5          91d
</span></span><span class="line"><span class="cl">kube-scheduler-master            1/1     Running   11         91d
</span></span><span class="line"><span class="cl">[ik8s@master ~]$
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="103-dashboard认证及分级授权">10.3 dashboard认证及分级授权</h3>
<h4 id="1031-简介">10.3.1 简介</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 是什么？
</span></span><span class="line"><span class="cl">Kubernetes Dashboard是Kubernetes集群的Web UI，用户可以通过Dashboard进行管理集群内所有资源对象，例如查看资源对象的运行情况，部署新的资源对象，伸缩Deployment中的Pod数量等等一系列操作。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">## 登录dashboard的时要用ServiceAccount账号进行登录
</span></span><span class="line"><span class="cl">## 原理就是dashboard是运行的一个pod，所以我们必须要为dashboard的pod提供一个kubectconfig
</span></span><span class="line"><span class="cl">## 所以它的用户主题必须是ServiceAccount
</span></span><span class="line"><span class="cl">## 如果要使用dashboard对集群做管理，就需要对ServiceAccount进行授权
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1、部署
</span></span><span class="line"><span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2、将service改为NodePort
</span></span><span class="line"><span class="cl"> kubectl patch svc kubernetes-dashboard -p &#39;{&#34;spec&#34;:{&#34;type&#34;:&#34;NodePort&#34;}}&#39; -n  kube-system
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">3、认证
</span></span><span class="line"><span class="cl">	认证的账号必须为ServiceAccount：被dashboard pod来来由kubernetes进行认证
</span></span><span class="line"><span class="cl">	token：
</span></span><span class="line"><span class="cl">		(1) 创建serviceAccount，根据其管理目标，使用rolebonding或者clusterrolebonding进行角色绑定
</span></span><span class="line"><span class="cl">		(2) 获取到此ServiceAccount的secret，查看secret的详细信息，其中就有token
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	kubeconfig：把SA的token封装为kubeconfig文件中
</span></span><span class="line"><span class="cl">		(1) 创建serviceAccount，根据其管理目标，使用rolebonding或者clusterrolebonding进行角色绑定
</span></span><span class="line"><span class="cl">		(2) DEF_NS_ADMIN_TOKEN=$(kubectl get secret def-ns-admin-token-d2zhb -o jsonpath={.data.token} | base64 -d)
</span></span><span class="line"><span class="cl">			kubectl config set-credentials def-ns-admin --token=$DEF_NS_ADMIN_TOKEN --kubeconfig=/root/def-ns-admin.conf
</span></span><span class="line"><span class="cl">		(3)生成kubeconfig文件
</span></span><span class="line"><span class="cl">			kubectl config set-cluster
</span></span><span class="line"><span class="cl">			kubectl config set-credentials
</span></span><span class="line"><span class="cl">			kubectl config set-context
</span></span><span class="line"><span class="cl">			kubectl config use-context
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1032-dashboard部署">10.3.2 dashboard部署</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 1、安装dashboard，这里要注意版本兼容性问题
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml
</span></span><span class="line"><span class="cl">ps：由于进行默认在国外，所以需要自己从国内拉然后改名字，拉之前要看一下该pod是使用那个节点拉镜像的
</span></span><span class="line"><span class="cl">docker pull kainonly/kubernetes-dashboard-amd64:v1.10.1
</span></span><span class="line"><span class="cl">docker tag kainonly/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2、配置svc为nodepod
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl patch svc kubernetes-dashboard -p &#39;{&#34;spec&#34;:{&#34;type&#34;:&#34;NodePort&#34;}}&#39; -n  kube-system
</span></span><span class="line"><span class="cl">service/kubernetes-dashboard patched
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3、浏览器访问登录
</span></span><span class="line"><span class="cl">https://192.168.101.67:30136/#!/login
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1033-dashboard令牌登录">10.3.3 dashboard令牌登录</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 1、创建ServiceAccount账号
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl create serviceaccount dashboard-admin -n kube-system
</span></span><span class="line"><span class="cl">serviceaccount/dashboard-admin created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get sa -n kube-system |grep dashboard-admin
</span></span><span class="line"><span class="cl">dashboard-admin                      1         32s
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2、对ServiceAccount账号进行授权
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin
</span></span><span class="line"><span class="cl">clusterrolebinding.rbac.authorization.k8s.io/dashboard-cluster-admin created
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3、获取token
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get secret -n kube-system |grep dashboard
</span></span><span class="line"><span class="cl">dashboard-admin-token-gkrcb                      kubernetes.io/service-account-token   3      6m12s
</span></span><span class="line"><span class="cl">dashboard-cert                                   Opaque                                2      17m
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl describe secret -n kube-system dashboard-admin-token-gkrcb
</span></span><span class="line"><span class="cl">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tZ2tyY2IiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiNDA2ZTI1MTQtM2I4Ni00ODMwLWE0YTUtMGZhYmY1OTlkM2UwIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.juG4UvS6hsVrYjADiGP6ZORNwJ6w9_MUi5ONFQDun1NbAi15-IGZ_I0F-AUXplOLusEGDGuXSMCOTDJ83aHvE-KIXhGD6bXRU0F-9JAuDlEX2LPT5-PbEJq47dW-2DU5tQvCdKYqgMRl16GsSGHQdq1xj_jq-Bk1wWw5l8nXo82b5TrFypxiC6ntjA1KWQvjkLSTQr1SJ_Eoqcxh8n-Jyt2MC8aza95cTdrO6FlSnnnnJZQSzVBZmuKuXDgZzwOmk7-Kn-UuVIjbQKjA9YQENKV-06bs12ELoSp5A4tnxfrr4UbYnNcWxGC2JpURybEHBGDBuh_KIqlblHIWu_PERA
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 4、浏览器访问登录
</span></span><span class="line"><span class="cl">https://192.168.101.67:30136/#!/login
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1034-dashboard使用kubeconfig登录">10.3.4 dashboard使用kubeconfig登录</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 1 创建serviceaccount账户
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl create serviceaccount def-ns-admin -n default
</span></span><span class="line"><span class="cl">serviceaccount/def-ns-admin created
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2 授权：将该账户通过rolebinding绑定在集群及别的admin上
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl create rolebinding def-ns-admin --clusterrole=admin --serviceaccount=default:def-ns-admin
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/def-ns-admin created
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3 获取该账号的token
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get secret
</span></span><span class="line"><span class="cl">NAME                       TYPE                                  DATA   AGE
</span></span><span class="line"><span class="cl">def-ns-admin-token-d2zhb   kubernetes.io/service-account-token   3      3m35s
</span></span><span class="line"><span class="cl">default-token-c6l8s        kubernetes.io/service-account-token   3      91d
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl describe secret def-ns-admin-token-d2zhb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 4 配置kubeconfig集群
</span></span><span class="line"><span class="cl">[root@master ~]# cd /etc/kubernetes/pki/
</span></span><span class="line"><span class="cl">[root@master pki]# kubectl config set-cluster kubernetes --certificate-authority=./ca.crt --server=:&#34;https://192.168.101.67:6443&#34; --embed-certs=true --kubeconfig=/root/def-ns-admin.conf
</span></span><span class="line"><span class="cl">Cluster &#34;kubernetes&#34; set.
</span></span><span class="line"><span class="cl">[root@master pki]#
</span></span><span class="line"><span class="cl">// 查看效果
</span></span><span class="line"><span class="cl">[root@master pki]# kubectl config view --kubeconfig=/root/def-ns-admin.conf
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">clusters:
</span></span><span class="line"><span class="cl">- cluster:
</span></span><span class="line"><span class="cl">    certificate-authority-data: DATA+OMITTED
</span></span><span class="line"><span class="cl">    server: :https://192.168.101.67:6443
</span></span><span class="line"><span class="cl">  name: kubernetes
</span></span><span class="line"><span class="cl">contexts: []
</span></span><span class="line"><span class="cl">current-context: &#34;&#34;
</span></span><span class="line"><span class="cl">kind: Config
</span></span><span class="line"><span class="cl">preferences: {}
</span></span><span class="line"><span class="cl">users: []
</span></span><span class="line"><span class="cl">[root@master pki]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 5 将sa账户的token解码保存到变量中
</span></span><span class="line"><span class="cl">[root@master pki]# DEF_NS_ADMIN_TOKEN=$(kubectl get secret def-ns-admin-token-d2zhb -o jsonpath={.data.token} | base64 -d)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 6 创建kubeconfig用户
</span></span><span class="line"><span class="cl">[root@master pki]# kubectl config set-credentials def-ns-admin --token=$DEF_NS_ADMIN_TOKEN --kubeconfig=/root/def-ns-admin.conf
</span></span><span class="line"><span class="cl">User &#34;def-ns-admin&#34; set.
</span></span><span class="line"><span class="cl">[root@master pki]# kubectl config view --kubeconfig=/root/def-ns-admin.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 7 配置kubeconfig上下文
</span></span><span class="line"><span class="cl">[root@master pki]# kubectl config set-context def-ns-admin@kubernetes --cluster=kubernetes --user=def-ns-admin --kubeconfig=/root/def-ns-admin.conf
</span></span><span class="line"><span class="cl">Context &#34;def-ns-admin@kubernetes&#34; created.
</span></span><span class="line"><span class="cl">[root@master pki]#
</span></span><span class="line"><span class="cl">[root@master pki]# kubectl config view --kubeconfig=/root/def-ns-admin.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 8 设置kubeconfig当前应用账户
</span></span><span class="line"><span class="cl">[root@master pki]# kubectl config use-context def-ns-admin@kubernetes --kubeconfig=/root/def-ns-admin.conf
</span></span><span class="line"><span class="cl">Switched to context &#34;def-ns-admin@kubernetes&#34;.
</span></span><span class="line"><span class="cl">[root@master pki]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 9 将该配置文件传输至电脑，然后使用该配置文件登录dashboard
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="11-k8s网络">11 k8s网络</h2>
<h3 id="111-k8s网络通信">11.1 k8s网络通信</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(1) 容器间通信：同一个Pod内的多个容器通信，lo
</span></span><span class="line"><span class="cl">(2) Pod通信：Pod IP &lt;--&gt; Pod IP
</span></span><span class="line"><span class="cl">(3) pod与service通信：PodIP &lt;--&gt; ClusterIP
</span></span><span class="line"><span class="cl">(4) service与集群外部客户端的通信
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CNI(容器网络接口):
</span></span><span class="line"><span class="cl">	flannel
</span></span><span class="line"><span class="cl">	calico
</span></span><span class="line"><span class="cl">	canel
</span></span><span class="line"><span class="cl">	kube-router
</span></span><span class="line"><span class="cl">	...
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	解决方案：
</span></span><span class="line"><span class="cl">		虚拟网桥
</span></span><span class="line"><span class="cl">		多路复用: MacVLAN
</span></span><span class="line"><span class="cl">		硬件交换：SR-IOV
</span></span><span class="line"><span class="cl">		 
</span></span><span class="line"><span class="cl">		 
</span></span><span class="line"><span class="cl">flannel：
</span></span><span class="line"><span class="cl">	支持多种后端传输：
</span></span><span class="line"><span class="cl">		Vxlan：
</span></span><span class="line"><span class="cl">			1、vxlan：不同网段则使用vxlan
</span></span><span class="line"><span class="cl">			2、directrouting：如果源pod所在的节点与 目标pod所在的节点在同网段，自动使用host-gw
</span></span><span class="line"><span class="cl">		host-gw：需要主机在同一个二层网络中，性能比vxlan高
</span></span><span class="line"><span class="cl">		UDP：性能最低
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="112-flannel">11.2 flannel</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">flannel网络插件为k8s提供网络服务，那个节点有kubelet那个节点就要有flannel
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">flannel的配置参数：
</span></span><span class="line"><span class="cl">	Network：flannel使用CIDR格式的网络地址，用于为pod配置网络功能
</span></span><span class="line"><span class="cl">		例： 10.244.0.0/16  -&gt;
</span></span><span class="line"><span class="cl">				master: 10.244.0.0/24
</span></span><span class="line"><span class="cl">				node01: 10.244.1.0/24
</span></span><span class="line"><span class="cl">				...
</span></span><span class="line"><span class="cl">				node255: 10.244.255.0/24	/最多256个节点
</span></span><span class="line"><span class="cl">			10.0.0.0/8
</span></span><span class="line"><span class="cl">				10.0.0.0/24
</span></span><span class="line"><span class="cl">				...
</span></span><span class="line"><span class="cl">				10.255.255.0/24
</span></span><span class="line"><span class="cl">	SubnetLen：把Network切子网供各个网络节点使用时，使用多少掩码进行切分，默认24位
</span></span><span class="line"><span class="cl">	SubentMin：指定分配给节点起始的第一个子网
</span></span><span class="line"><span class="cl">	SubentMAX: 指定分配节点的最后一个子网
</span></span><span class="line"><span class="cl">	Backend: 各pod之间的通信方式
</span></span><span class="line"><span class="cl">			vxlan, host-gw,udp
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看flannel配置文件
</span></span><span class="line"><span class="cl">kubectl get configmap kube-flannel-cfg -o json -n kube-system
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1121-不同节点pod通信">11.2.1 不同节点pod通信</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 分别在两个节点上都创建一个pod
</span></span><span class="line"><span class="cl">[root@master ~]# cat deploy-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: myapp-deploy
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 2
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: myapp
</span></span><span class="line"><span class="cl">      release: canary
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: myapp
</span></span><span class="line"><span class="cl">        release: canary
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: myapp
</span></span><span class="line"><span class="cl">        image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - name: http
</span></span><span class="line"><span class="cl">          containerPort: 80
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f deploy-demo.yaml
</span></span><span class="line"><span class="cl">deployment.apps/myapp-deploy created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get pods -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 进入node1上面的pod
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl exec -it myapp-deploy-f4db5d79c-rg8v8 -- /bin/sh
</span></span><span class="line"><span class="cl">/ #
</span></span><span class="line"><span class="cl">/ #
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 进入node2上面的pod
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl exec -it myapp-deploy-f4db5d79c-vgvhm -- /bin/sh
</span></span><span class="line"><span class="cl">/ # ping 10.244.1.4		// ping第一个节点的ip发现能通
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># nodel1上抓包，发现数据先从cni0进入，转给flannel.1进行封装转发给对应节点网卡
</span></span><span class="line"><span class="cl">[root@node1 ~]# tcpdump -i cni0 -nn icmp
</span></span><span class="line"><span class="cl">[root@node1 ~]# tcpdump -i flannel.1 -nn
</span></span><span class="line"><span class="cl">[root@node1 ~]# tcpdump -i ens33  -nn
</span></span><span class="line"><span class="cl">ps：这里能通信是通过cni接口实现的
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1122-设置directrouting">11.2.2 设置directrouting</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">将11.2.1上面的通信方式修改为directrouting
</span></span><span class="line"><span class="cl">directrouting：如果源pod所在的节点与 目标pod所在的节点在同网段，自动使用host-gw
</span></span><span class="line"><span class="cl">缺陷：一旦pod多了容易，他们都在同一个二层网络，容易产生广播风暴
</span></span><span class="line"><span class="cl">    当集群规模达到500-1000个节点这种方式就会出现性能问题
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 修改flannel配置文件
</span></span><span class="line"><span class="cl">[root@master flannel]#  wget https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span></span><span class="line"><span class="cl">[root@master flannel] vim kube-flannel.yml
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">      &#34;Network&#34;: &#34;10.244.0.0/16&#34;,
</span></span><span class="line"><span class="cl">      &#34;Backend&#34;: {
</span></span><span class="line"><span class="cl">        &#34;Type&#34;: &#34;vxlan&#34;
</span></span><span class="line"><span class="cl">        &#34;Directrouting&#34;: true
</span></span><span class="line"><span class="cl">      }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[root@master flannel]#
</span></span><span class="line"><span class="cl">[root@master flannel]# kubectl delete -f kube-flannel.yml // 生产环境不能这样搞
</span></span><span class="line"><span class="cl">[root@master flannel]# kubectl apply -f kube-flannel.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 当修改完directrouting后会发现路由信息已经由flannel.1变为对应网卡
</span></span><span class="line"><span class="cl">[root@master flannel]# ip route
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="113-canel网络策略">11.3 canel网络策略</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 使用flannel的网络功能，使用calico的网络策略
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">networkPolicy：	
</span></span><span class="line"><span class="cl">    Egres：自己访问对方，可以定义对方的地址端口
</span></span><span class="line"><span class="cl">    Ingress：对方访问自己，可以定义对方的地址端口
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">网络策略：
</span></span><span class="line"><span class="cl">	名称空间：
</span></span><span class="line"><span class="cl">		拒绝所有出战，入站；
</span></span><span class="line"><span class="cl">		放行所有出战目标为本名称空间内的所有Pod；
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">policeType： 策略类型
</span></span><span class="line"><span class="cl">	当一个策略中即有Ingress又有Egres时，policeType控制那个生效
</span></span><span class="line"><span class="cl">	也可以使他们同时生效
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps：策略配置选择器不仅包括podSelector还包括namespace等其他选择器
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1131-安装">11.3.1 安装</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl apply -f \
</span></span><span class="line"><span class="cl">https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/rbac.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl apply -f \
</span></span><span class="line"><span class="cl">https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/canal.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1132-定义策略">11.3.2 定义策略</h4>
<h5 id="11321-拒绝入站">11.3.2.1 拒绝入站</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># kubectl explain networkpolicy  查看帮助
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 1、定义入站规则
</span></span><span class="line"><span class="cl">[root@master ~]# vim ingress-def.yaml
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: NetworkPolicy
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: deny-all-ingress
</span></span><span class="line"><span class="cl">  namespace: dev
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  podSelector: {}    # 控制规则生效pod
</span></span><span class="line"><span class="cl">  policyTypes:   
</span></span><span class="line"><span class="cl">  - Ingress
</span></span><span class="line"><span class="cl">  # 设置Ingress就只表示Ingress生效，但如果ingress没有定义规则就表示默认禁止所有，没有加Egres表示不控制Egres，表示Egres默认都是允许的
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"># 2、创建namespace
</span></span><span class="line"><span class="cl">kubectl create namespace dev
</span></span><span class="line"><span class="cl">kubectl create namespace prod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3、指定dev创建规则
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f ingress-def.yaml -n dev
</span></span><span class="line"><span class="cl">networkpolicy.networking.k8s.io/deny-all-ingress created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get netpol -n dev
</span></span><span class="line"><span class="cl">NAME               POD-SELECTOR   AGE
</span></span><span class="line"><span class="cl">deny-all-ingress   &lt;none&gt;         18s
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 4、在dev上创建pod，会发现由于制定了规则，访问不了其中的pod
</span></span><span class="line"><span class="cl">[root@master ~]# vim pod-a.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod1
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f pod-a.yaml -n dev
</span></span><span class="line"><span class="cl">pod/pod1 created
</span></span><span class="line"><span class="cl">[root@master ~]#  kubectl get pods -n dev
</span></span><span class="line"><span class="cl">NAME   READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod1   1/1     Running   0          65s
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get pods -n dev -o wide
</span></span><span class="line"><span class="cl">[root@master ~]# curl 10.244.3.2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 5、在prod上创建pod，由于没有定义规则，可以访问其中pod
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f pod-a.yaml -n prod
</span></span><span class="line"><span class="cl">[root@master ~]#  kubectl get pods -n prod -o wide
</span></span><span class="line"><span class="cl">[root@master ~]# curl 10.244.1.2
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="11322-允许入站">11.3.2.2 允许入站</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># kubectl explain networkpolicy  查看帮助
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 1、定义入站规则
</span></span><span class="line"><span class="cl">[root@master ~]# vim ingress-def.yaml
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: NetworkPolicy
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: deny-all-ingress
</span></span><span class="line"><span class="cl">  namespace: dev
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  podSelector: {}    # 控制规则生效pod
</span></span><span class="line"><span class="cl">  ingress:  # 明确定义ingress规则，这样表示允许所有
</span></span><span class="line"><span class="cl">  - {}
</span></span><span class="line"><span class="cl">  policyTypes:   
</span></span><span class="line"><span class="cl">  - Ingress
</span></span><span class="line"><span class="cl">  # 设置Ingress就只表示Ingress生效，但如果ingress没有定义规则就表示默认禁止所有，没有加Egres表示不控制Egres，表示Egres默认都是允许的
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"># 2、指定dev创建规则
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f ingress-def.yaml -n dev
</span></span><span class="line"><span class="cl">networkpolicy.networking.k8s.io/deny-all-ingress created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get netpol -n dev
</span></span><span class="line"><span class="cl">NAME               POD-SELECTOR   AGE
</span></span><span class="line"><span class="cl">deny-all-ingress   &lt;none&gt;         18s
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3、这样一来dev里面的pod就允许访问了
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get pods -n dev -o wide
</span></span><span class="line"><span class="cl">[root@master ~]# curl 10.244.3.2
</span></span><span class="line"><span class="cl">Hello MyApp | Version: v1 | &lt;a href=&#34;hostname.html&#34;&gt;Pod Name&lt;/a&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="11323-允许特定的入站流量">11.3.2.3 允许特定的入站流量</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># kubectl explain networkpolicy  查看帮助
</span></span><span class="line"><span class="cl">任何在dev名称空间的对标签值是app=myapp的pod，放行该pod的80端口
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 1、给dev下的pod打标签
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl label pods pod1 app=myapp -n dev
</span></span><span class="line"><span class="cl">pod/pod1 labeled
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2、定义规则
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: NetworkPolicy
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: allow-myapp-ingress
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  podSelector:    # 控制规则生效pod
</span></span><span class="line"><span class="cl">    matchLabels:  # 标签选择器
</span></span><span class="line"><span class="cl">      app: myapp
</span></span><span class="line"><span class="cl">  ingress:  # 明确定义ingress规则，这样表示允许所有
</span></span><span class="line"><span class="cl">  - from:
</span></span><span class="line"><span class="cl">    - ipBlock:
</span></span><span class="line"><span class="cl">        cidr: 10.244.0.0/16   # 放行这个网段
</span></span><span class="line"><span class="cl">        except:
</span></span><span class="line"><span class="cl">        - 10.244.1.2/32   # 排除这个地址
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - protocol: TCP
</span></span><span class="line"><span class="cl">      port: 80
</span></span><span class="line"><span class="cl">    - protocol: TCP
</span></span><span class="line"><span class="cl">      port: 443
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 允许来自10.244.0.0/16这个网段的客户端访问本地有pod标签的一组本地端口
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3、在dev上创建规则
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f  allow-netpol-demo.yaml -n dev
</span></span><span class="line"><span class="cl">networkpolicy.networking.k8s.io/allow-myapp-ingress created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get netpol -n dev
</span></span><span class="line"><span class="cl">NAME                  POD-SELECTOR   AGE
</span></span><span class="line"><span class="cl">allow-myapp-ingress   app=myapp      54s
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 4、测试发现80和443都没被阻拦，而其他端口被策略阻拦了
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get pods -n dev -o wide --show-labels
</span></span><span class="line"><span class="cl">[root@master ~]# curl 10.244.3.2
</span></span><span class="line"><span class="cl">Hello MyApp | Version: v1 | &lt;a href=&#34;hostname.html&#34;&gt;Pod Name&lt;/a&gt;
</span></span><span class="line"><span class="cl">[root@master ~]# curl 10.244.3.2:443
</span></span><span class="line"><span class="cl">curl: (7) Failed connect to 10.244.3.2:443; Connection refused
</span></span><span class="line"><span class="cl">[root@master ~]# curl 10.244.3.2:22  
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="11324-管控出站流量">11.3.2.4 管控出站流量</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">与入站很相似，就把入站的ingress改为egress
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 1、配置规则
</span></span><span class="line"><span class="cl">[root@master ~]# vim egress-def
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: NetworkPolicy
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: deny-all-ingress
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  podSelector: {}
</span></span><span class="line"><span class="cl">  policyTypes:
</span></span><span class="line"><span class="cl">  - Egress
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2、创建规则
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f egress-def -n prod
</span></span><span class="line"><span class="cl">networkpolicy.networking.k8s.io/deny-all-ingress created
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get netpol -n prod
</span></span><span class="line"><span class="cl">NAME               POD-SELECTOR   AGE
</span></span><span class="line"><span class="cl">deny-all-ingress   &lt;none&gt;         35s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 3、进入pod
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get pods -n prod -o wide
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl exec pod1 -it -n prod -- /bin/sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 4、随便找个集群内部的地址进行测试发现不桶
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl exec pod1 -it -n prod -- /bin/sh
</span></span><span class="line"><span class="cl">/ # ping 10.244.0.4
</span></span><span class="line"><span class="cl">PING 10.244.0.4 (10.244.0.4): 56 data bytes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 5、配置规则允许访问外部的10.244.0.4
</span></span><span class="line"><span class="cl">[root@master ~]# vim egress-def
</span></span><span class="line"><span class="cl">apiVersion: networking.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: NetworkPolicy
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: deny-all-ingress
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  podSelector: {}
</span></span><span class="line"><span class="cl">  egress:  # 配置具体规则，不配置默认禁止所有
</span></span><span class="line"><span class="cl">  - {}  # 空代表允许所有
</span></span><span class="line"><span class="cl">  policyTypes:
</span></span><span class="line"><span class="cl">  - Egress
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl apply -f egress-def -n prod
</span></span><span class="line"><span class="cl">networkpolicy.networking.k8s.io/deny-all-ingress configured
</span></span><span class="line"><span class="cl">[root@master ~]#
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 6、进入pod内再次进行测试发现允许通信了
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl exec pod1 -it -n prod -- /bin/sh
</span></span><span class="line"><span class="cl">/ # ping 10.244.0.4
</span></span><span class="line"><span class="cl">PING 10.244.0.4 (10.244.0.4): 56 data bytes
</span></span><span class="line"><span class="cl">64 bytes from 10.244.0.4: seq=0 ttl=62 time=0.901 ms
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="12-k8s调度">12 k8s调度</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 调度过程：Predicate(预选) -&gt; Priority(优选) -&gt; select(选定)
</span></span><span class="line"><span class="cl">	1、预选：预选策略工作逻辑，检查所有，有一个不符合就排除
</span></span><span class="line"><span class="cl">	2、优选：把所有函数进行评估，然后得分相加
</span></span><span class="line"><span class="cl">	3、选定：如果得分相同，则随机取得一个
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 调度器： 
</span></span><span class="line"><span class="cl">	预选策略：
</span></span><span class="line"><span class="cl">		CheckNodeCondition
</span></span><span class="line"><span class="cl">		GeneralPred：
</span></span><span class="line"><span class="cl">			HostName：检查pod对象是否定义了pod.spec.hostname，如果定义了就检查主机节点的hostname
</span></span><span class="line"><span class="cl">			PodFitsHostPort：Pods.spec.containers.ports.hostPort
</span></span><span class="line"><span class="cl">			MatchNodeSelector: pod.spec.nodeSelector
</span></span><span class="line"><span class="cl">			PodFitsResources: 检查pod的资源需求是否能被节点满足
</span></span><span class="line"><span class="cl">		NoDiskConflict：检查pod依赖的存储卷是否能满足需求
</span></span><span class="line"><span class="cl">		PodToleratesNodeTaints： 检查pod上的spec.tolerates可容忍的污点是否完全包含节点上的污点
</span></span><span class="line"><span class="cl">		PodToleratesNodeNoExecuteTaints： 默认不启用
</span></span><span class="line"><span class="cl">		CheckNodeLabelPresence： 默认不启用
</span></span><span class="line"><span class="cl">		CheckServiceAffinity：将相同service上的pod对象尽可能放在一个节点上，默认不启用
</span></span><span class="line"><span class="cl">		MaxEBSVolumeCount
</span></span><span class="line"><span class="cl">		MaxGCEPDVolumeCount
</span></span><span class="line"><span class="cl">		MaxAzureDiskVolumeCount
</span></span><span class="line"><span class="cl">		CheckVolumeBinding
</span></span><span class="line"><span class="cl">		NoVolumezoneConflict
</span></span><span class="line"><span class="cl">		CheckNodeMemoryPressure
</span></span><span class="line"><span class="cl">		CheckNodePIDPressure
</span></span><span class="line"><span class="cl">		CheckNodeDiskPressure
</span></span><span class="line"><span class="cl">		MatchInterPodAffinity
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 优选函数
</span></span><span class="line"><span class="cl">	leastRequested:
</span></span><span class="line"><span class="cl">	BalancendResourceAllocation:
</span></span><span class="line"><span class="cl">		CPU和内存资源被占用率相近的胜出
</span></span><span class="line"><span class="cl">	NodePreferAvoidPods：
</span></span><span class="line"><span class="cl">		节点上注解信息&#34;scheduler.alpha.kubernetes.io/perferAvoidPods&#34;
</span></span><span class="line"><span class="cl">	TaintToleration:
</span></span><span class="line"><span class="cl">		将pod对象的spec.tolerations列表与系欸但的taints列表项进行匹配度检查，匹配条目越多，得分越低
</span></span><span class="line"><span class="cl">	SeletorSperading：
</span></span><span class="line"><span class="cl">	InterPodAfftinity：
</span></span><span class="line"><span class="cl">	NodeAffinity：
</span></span><span class="line"><span class="cl">	MostRequested：
</span></span><span class="line"><span class="cl">	ModelLabel
</span></span><span class="line"><span class="cl">	ImageLocality：根据满足当前pod都对象需求已有镜像体积大小之和
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="121-k8s高级调度">12.1 k8s高级调度</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">节点选择器：nodeSelector， nodeName
</span></span><span class="line"><span class="cl">节点亲和度调度：nodeAffinity
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1211-nodeselector">12.1.1 nodeSelector</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 编辑yaml文件
</span></span><span class="line"><span class="cl">[root@master schedule]# cat pod-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-demo
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    magedu.com/created-by: &#34;cluster admin&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">  nodeSelector:
</span></span><span class="line"><span class="cl">    disktype: ssd  # 自己定义
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl apply -f pod-demo.yaml
</span></span><span class="line"><span class="cl">pod/pod-demo created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 给node1打标签
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl label nodes node1 disktype=ssd
</span></span><span class="line"><span class="cl">node/node1 labeled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看验证
</span></span><span class="line"><span class="cl"># 发现该pod只会在node1上创建
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl get nodes --show-labels
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl get pods -o wide
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1212-nodeaffinity">12.1.2 nodeAffinity</h4>
<h5 id="12121-node硬亲和性">12.1.2.1 node硬亲和性</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 节点亲和性:提前把节点标签定义好，然后在pod里面定义亲和性选择节点
</span></span><span class="line"><span class="cl">## 查看帮助 kubectl explain pods.spec.affinity
</span></span><span class="line"><span class="cl">软亲和性表示就算没有，也会找一个节点创建
</span></span><span class="line"><span class="cl">硬亲和性表示没有这样标签的节点pod就处于pending状态
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 配置硬亲和性文件
</span></span><span class="line"><span class="cl">[root@master schedule]# cat pod-nodeaffinity-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-node-affinity-demo
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    magedu.com/created-by: &#34;cluster admin&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">  affinity:
</span></span><span class="line"><span class="cl">    nodeAffinity:
</span></span><span class="line"><span class="cl">      requiredDuringSchedulingIgnoredDuringExecution: # 硬亲和性
</span></span><span class="line"><span class="cl">        nodeSelectorTerms:
</span></span><span class="line"><span class="cl">        - matchExpressions:
</span></span><span class="line"><span class="cl">          - key: zone
</span></span><span class="line"><span class="cl">            operator: In
</span></span><span class="line"><span class="cl">            values:
</span></span><span class="line"><span class="cl">            - foo
</span></span><span class="line"><span class="cl">            - bar
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl apply -f pod-nodeaffinity-demo.yaml
</span></span><span class="line"><span class="cl">pod/pod-node-affinity-demo created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 验证，只有满足了该标签要求的节点pod才会在上面创建
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl get pods -o wide
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="12122-node软亲和性">12.1.2.2 node软亲和性</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## 查看帮助 kubectl explain pods.spec.affinity
</span></span><span class="line"><span class="cl">软亲和性表示就算没有，也会找一个节点创建
</span></span><span class="line"><span class="cl">硬亲和性表示没有这样标签的节点pod就处于pending状态
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 配置文件
</span></span><span class="line"><span class="cl">[root@master schedule]# cat pod-nodeaffinity-demo2.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-node-affinity-demo
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    magedu.com/created-by: &#34;cluster admin&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">  affinity:
</span></span><span class="line"><span class="cl">    nodeAffinity:
</span></span><span class="line"><span class="cl">      preferredDuringSchedulingIgnoredDuringExecution:
</span></span><span class="line"><span class="cl">      - preference:
</span></span><span class="line"><span class="cl">          matchExpressions:
</span></span><span class="line"><span class="cl">          - key: zone
</span></span><span class="line"><span class="cl">            operator: In
</span></span><span class="line"><span class="cl">            values:
</span></span><span class="line"><span class="cl">            - foo
</span></span><span class="line"><span class="cl">            - bar
</span></span><span class="line"><span class="cl">        weight: 60
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl apply -f pod-nodeaffinity-demo2.yaml
</span></span><span class="line"><span class="cl">pod/pod-node-affinity-demo created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 验证测试，发现没符合标签的节点，他也会创建
</span></span><span class="line"><span class="cl"># 有符合的节点就调度到对应节点上
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl get pods
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1213-podaffinity">12.1.3 podAffinity</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## pod亲和性：第一个pod随机选择一个位置，第二个pod要更具第一个pod的位置来进行调度
</span></span><span class="line"><span class="cl">## 使用方法： 可以把同一机柜，或同一排机柜的服务器打好对应的标签，例如 rack=rack1，这样pod就可以根据这些来进行位置选择
</span></span><span class="line"><span class="cl">## 查看帮助 kubectl explain ipods.spec.affinity.podAffinity
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="12131-pod亲和">12.1.3.1 pod亲和</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 配置文件
</span></span><span class="line"><span class="cl">[root@master schedule]# cat pod-required-affinity-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-first
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-second
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: backend
</span></span><span class="line"><span class="cl">    tier: db
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: busybox
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">  affinity:
</span></span><span class="line"><span class="cl">    podAffinity:
</span></span><span class="line"><span class="cl">      requiredDuringSchedulingIgnoredDuringExecution:
</span></span><span class="line"><span class="cl">      - labelSelector:
</span></span><span class="line"><span class="cl">          matchExpressions:
</span></span><span class="line"><span class="cl">          - {key: app,operator: In,values: [&#34;myapp&#34;]}
</span></span><span class="line"><span class="cl">          # 当前pod要更标签是app，值是myapp的pod在一起
</span></span><span class="line"><span class="cl">        topologyKey: kubernetes.io/hostname
</span></span><span class="line"><span class="cl">        # 需要这两个pod在同一个位置上
</span></span><span class="line"><span class="cl">        # 使用节点名称来作为标准
</span></span><span class="line"><span class="cl">        # 只要节点名一样就是统一位置
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl apply -f pod-required-affinity-demo.yaml
</span></span><span class="line"><span class="cl">pod/pod-first created
</span></span><span class="line"><span class="cl">pod/pod-second created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 验证，发现两个pod被调度到统一节点上
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl get pods -o wide
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="12132-pod反亲和">12.1.3.2 pod反亲和</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 配置文件
</span></span><span class="line"><span class="cl">[root@master schedule]# cat pod-required-anti-affinity-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-first
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-second
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: backend
</span></span><span class="line"><span class="cl">    tier: db
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: busybox
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">  affinity:
</span></span><span class="line"><span class="cl">    # podAffinity: 表示亲和
</span></span><span class="line"><span class="cl">    podAntiAffinity: # 表示反亲和
</span></span><span class="line"><span class="cl">      requiredDuringSchedulingIgnoredDuringExecution:
</span></span><span class="line"><span class="cl">      - labelSelector:
</span></span><span class="line"><span class="cl">          matchExpressions:
</span></span><span class="line"><span class="cl">          - {key: app,operator: In,values: [&#34;myapp&#34;]}
</span></span><span class="line"><span class="cl">          # 当前pod要更标签是app，值是myapp的pod在一起
</span></span><span class="line"><span class="cl">        topologyKey: kubernetes.io/hostname
</span></span><span class="line"><span class="cl">        # 需要这两个pod不能再同一个位置上
</span></span><span class="line"><span class="cl">        # 使用节点名称来作为标准
</span></span><span class="line"><span class="cl">        # 只要节点名一样就是统一位置
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl apply -f pod-required-anti-affinity-demo.yaml
</span></span><span class="line"><span class="cl">pod/pod-first created
</span></span><span class="line"><span class="cl">pod/pod-second created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 验证
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl get pods -o wide
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="1214-taint污点">12.1.4 taint污点</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># taint的effect定义对Pod排斥效果，污点效果：
</span></span><span class="line"><span class="cl">	NoSchedule：仅影响调度过程，对现存的pod对象不产生影响
</span></span><span class="line"><span class="cl">	NoExecute：即影响调度过程，也影响现存的pod对象；不能容忍的pod对象将被驱逐
</span></span><span class="line"><span class="cl">	PerferNoSchedule：最好不，就是可以调度过来
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 使用过程，pod定义能匹配的污点和容忍度(Tolerations)，节点上定义污点(taint)
</span></span><span class="line"><span class="cl">	根据节点和pod之间的污点关系来进行调度
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="12141-污点调度">12.1.4.1 污点调度</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 给node1打上污点，污点效果为NoSchedule
</span></span><span class="line"><span class="cl">kubectl taint --help
</span></span><span class="line"><span class="cl">kubectl taint node node1 node-type=production:NoSchedule
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># pod配置文件
</span></span><span class="line"><span class="cl">[root@master schedule]# cat deploy-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: myapp-deploy
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 3
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: myapp
</span></span><span class="line"><span class="cl">      release: canary
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: myapp
</span></span><span class="line"><span class="cl">        release: canary
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: myapp
</span></span><span class="line"><span class="cl">        image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - name: http
</span></span><span class="line"><span class="cl">          containerPort: 80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl apply -f deploy-demo.yaml
</span></span><span class="line"><span class="cl">deployment.apps/myapp-deploy created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 测试发现pod都在node2上因为不能容忍node1的污点
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl get pods -o wide
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 这个时候也给node2打上污点，效果是NoExecute
</span></span><span class="line"><span class="cl">kubectl taint node node2 node-type=production:NoExecute
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 测试发现pod都被驱逐了，处于Pending状态
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl get pods -o wide
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="12142-污点容忍">12.1.4.2 污点容忍</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 查看帮助 kubectl explain pods.spec.tolarations
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 配置文件
</span></span><span class="line"><span class="cl">[root@master schedule]# cat deploy-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: myapp-deploy
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: 3
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: myapp
</span></span><span class="line"><span class="cl">      release: canary
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: myapp
</span></span><span class="line"><span class="cl">        release: canary
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: myapp
</span></span><span class="line"><span class="cl">        image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - name: http
</span></span><span class="line"><span class="cl">          containerPort: 80
</span></span><span class="line"><span class="cl">      tolerations:  # 容忍度
</span></span><span class="line"><span class="cl">      - key: &#34;node-type&#34;
</span></span><span class="line"><span class="cl">        # operator: &#34;Equal&#34;  # key和value要都要必须符合
</span></span><span class="line"><span class="cl">        operator: &#34;Exist&#34;  # 只要key符合就可以容忍
</span></span><span class="line"><span class="cl">        # value: &#34;production&#34;
</span></span><span class="line"><span class="cl">        value: &#34;&#34;
</span></span><span class="line"><span class="cl">        effect: &#34;NoSchedule&#34;  # 容忍的污点效果
</span></span><span class="line"><span class="cl">        # effect: &#34;&#34;  # 为空表示所有效果都容忍
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod并测试，发现其容忍了对应的污点node
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl apply -f deploy-demo.yaml
</span></span><span class="line"><span class="cl">deployment.apps/myapp-deploy configured
</span></span><span class="line"><span class="cl">[root@master schedule]# kubectl get pods -w
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="13-k8s资源限制">13 k8s资源限制</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 1 requests: 需求，运行容器的最低保障
</span></span><span class="line"><span class="cl">	limits: 限制，资源最多不能超过的阈值
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 2 CPU:
</span></span><span class="line"><span class="cl">	一颗逻辑cpu
</span></span><span class="line"><span class="cl">	1=1000,millicores
</span></span><span class="line"><span class="cl">	500m=0.5CPU
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 3 内存：
</span></span><span class="line"><span class="cl">	E、P、T、G、M、K
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl"># 4 QOS:
</span></span><span class="line"><span class="cl">	Guranteed：
</span></span><span class="line"><span class="cl">		资源抢占时，这一类容器要被优先运行
</span></span><span class="line"><span class="cl">		同时设置CPU和内存的requests和limits
</span></span><span class="line"><span class="cl">			cpu.limits = CPU.requests
</span></span><span class="line"><span class="cl">			memory.limits = memory.request
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">	Burstable：
</span></span><span class="line"><span class="cl">		资源抢占时，这一类有中等优先级
</span></span><span class="line"><span class="cl">		至少有一个容器设置CPU或内存资源的requests属性
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	BestEffort
</span></span><span class="line"><span class="cl">		没有任何一个容器设置了requests做limits属性；最低优先级级别
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="131-资源限制">13.1 资源限制</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 查看帮助 kubectl explain pods.spec.containers.resources
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># pod配置
</span></span><span class="line"><span class="cl">[root@master metrics]# cat pod-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-demo
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    magedu.com/created-by: &#34;cluster admin&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/stress-ng  # 压测镜像
</span></span><span class="line"><span class="cl">    command: [&#34;/usr/bin/stress-ng&#34;,&#34;-m 1&#34;,&#34;-c 1&#34;,&#34;--metrics-brief&#34;]
</span></span><span class="line"><span class="cl">    resources:
</span></span><span class="line"><span class="cl">      requests:
</span></span><span class="line"><span class="cl">        cpu: &#34;200m&#34;
</span></span><span class="line"><span class="cl">        memory: &#34;128Mi&#34;
</span></span><span class="line"><span class="cl">      limits:
</span></span><span class="line"><span class="cl">        cpu: &#34;500m&#34;
</span></span><span class="line"><span class="cl">        memory: &#34;200Mi&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">[root@master metrics]# kubectl apply -f pod-demo.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看测试，发现由于给对应节点分配的CPU是两个，
</span></span><span class="line"><span class="cl"># 而pod的限制是最多使用0.5个，所以显示占了四分之一也就是25%左右
</span></span><span class="line"><span class="cl">[root@master metrics]# kubectl exec pod-demo -- top
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="132-资源qos">13.2 资源QOS</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># QOS:
</span></span><span class="line"><span class="cl">	Guranteed：
</span></span><span class="line"><span class="cl">		资源抢占时，这一类容器要被优先运行
</span></span><span class="line"><span class="cl">		同时设置CPU和内存的requests和limits
</span></span><span class="line"><span class="cl">			cpu.limits = CPU.requests
</span></span><span class="line"><span class="cl">			memory.limits = memory.request
</span></span><span class="line"><span class="cl">			
</span></span><span class="line"><span class="cl">	Burstable：
</span></span><span class="line"><span class="cl">		资源抢占时，这一类有中等优先级
</span></span><span class="line"><span class="cl">		至少有一个容器设置CPU或内存资源的requests属性
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	BestEffort
</span></span><span class="line"><span class="cl">		没有任何一个容器设置了requests做limits属性；最低优先级级别
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"># pod配置
</span></span><span class="line"><span class="cl">[root@master metrics]# cat pod-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Pod
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: pod-demo
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: myapp
</span></span><span class="line"><span class="cl">    tier: frontend
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    magedu.com/created-by: &#34;cluster admin&#34;
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: myapp
</span></span><span class="line"><span class="cl">    image: ikubernetes/myapp:v1
</span></span><span class="line"><span class="cl">    resources:
</span></span><span class="line"><span class="cl">      requests:
</span></span><span class="line"><span class="cl">        cpu: &#34;200m&#34;
</span></span><span class="line"><span class="cl">        memory: &#34;128Mi&#34;
</span></span><span class="line"><span class="cl">      limits:
</span></span><span class="line"><span class="cl">        cpu: &#34;200m&#34;
</span></span><span class="line"><span class="cl">        memory: &#34;128Mi&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">[root@master metrics]# kubectl apply -f pod-demo.yaml
</span></span><span class="line"><span class="cl">pod/pod-demo created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看验证发现QOS为最高优先级
</span></span><span class="line"><span class="cl">[root@master metrics]# kubectl describe pods pod-demo
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="14-资源指标api自定义指标api">14 资源指标API，自定义指标API</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 资源指标：metrics-server
</span></span><span class="line"><span class="cl">   自定义资源指标：prometheus，k8s-prometheus-adapter
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 新一代架构：
</span></span><span class="line"><span class="cl">	核心指标流水线：由kubelet、metrics-server以及API server提供的api组成；CPU累计使用率、内存实时使用率，pod的资源占用率及容器的磁盘占用率；
</span></span><span class="line"><span class="cl">	监控流水线：用于从系统手机各种指标数据并提供终端用户、存储系统以及HPA，他们包含核心指标及许多的非核心指标
</span></span><span class="line"><span class="cl">	ps: 非核心指标本身不能被k8s解析
</span></span><span class="line"><span class="cl">	
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="141-metrics-server">14.1 metrics-server</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">metrics是一个监控系统资源使用的插件，可以监控node节点上的CPU、内存的使用率，或pod对资源的占用率，通过读资源占用的了解，可以合理的部署容器应用
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">https://blog.csdn.net/qq_24794401/article/details/106625980?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166109331116780357256238%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166109331116780357256238&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-106625980-null-null.142^v42^pc_ran_alice,185^v2^control&amp;utm_term=metrics-server%E9%83%A8%E7%BD%B2&amp;spm=1018.2226.3001.4187
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="142-prometheus">14.2 prometheus</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Prometheus是一个开源的系统监控和报警系统，现在已经加入到CNCF基金会，成为继k8s之后第二个在CNCF托管的项目，在kubernetes容器管理系统中，通常会搭配prometheus进行监控，同时也支持多种exporter采集数据，还支持pushgateway进行数据上报，Prometheus性能足够支撑上万台规模的集群。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">https://blog.csdn.net/qq_34533957/article/details/117407743?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166109319016781790773885%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166109319016781790773885&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-117407743-null-null.142^v42^pc_ran_alice,185^v2^control&amp;utm_term=prometheus%E7%9B%91%E6%8E%A7k8s&amp;spm=1018.2226.3001.4187
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="15-hpa控制器">15 HPA控制器</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 查看帮助 kubectl autoscal --help
</span></span><span class="line"><span class="cl"># hpa监控的指标可以根据prometheus，metrics-server所输出的资源指标来判定pod扩容缩减
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建pod
</span></span><span class="line"><span class="cl">kubectl run myapp --image=ikubernetes/myapp:v1 --replicas=1 --requests=&#39;cpu=50m,memory=256Mi&#39; --limits=&#39;cpu=50m,memory=256Mi&#39; --labels=&#39;app=myapp&#39; --expose --port=80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get pods
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 定义自动伸缩，最少为一个，当cpu利用率超过60时自动扩展，最多扩展8个pod
</span></span><span class="line"><span class="cl">kubectl autoscal deployment myapp --min=1 --max=8 --cpu-percent=60
</span></span><span class="line"><span class="cl">kubectl get hpa
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建配置文件hpa-v2-demo.yaml
</span></span><span class="line"><span class="cl">apiVersion: autoscaling/v2beta1
</span></span><span class="line"><span class="cl">kind: HorizontalPodAutoscaler
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: myapp-hpa-v2
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  scaleTargetRef:
</span></span><span class="line"><span class="cl">    apiVersion: apps/v1
</span></span><span class="line"><span class="cl">    kind: Deployment
</span></span><span class="line"><span class="cl">    name: myapp
</span></span><span class="line"><span class="cl">  minReplicas: 1
</span></span><span class="line"><span class="cl">  maxReplicas: 10
</span></span><span class="line"><span class="cl">  metrics:
</span></span><span class="line"><span class="cl">  - type: Resurce  # 基于资源来评估
</span></span><span class="line"><span class="cl">    resource：
</span></span><span class="line"><span class="cl">      name: cpu
</span></span><span class="line"><span class="cl">      targetAverageUtilization: 55
</span></span><span class="line"><span class="cl">  - type: Resource
</span></span><span class="line"><span class="cl">    resource:
</span></span><span class="line"><span class="cl">      name: memory
</span></span><span class="line"><span class="cl">      targetAverageValue: 50Mi
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建HPA
</span></span><span class="line"><span class="cl">kubectl apply -f hpa-v2-demo.yaml
</span></span><span class="line"><span class="cl">kubectl describe hpa
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="16-helm">16 helm</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># Helm是Kubernetes 应用的包管理工具，主要用来管理 Charts，类似Linux系统的yum。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Helm Chart 是用来封装 Kubernetes 原生应用程序的一系列 YAML 文件。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># helm类似于kubectl，他的服务端是Tiler，helm找Tiler再找api server发送请求完成部署应用
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 一旦chart部署了，就称之为release
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># helm：
</span></span><span class="line"><span class="cl">	核心术语：
</span></span><span class="line"><span class="cl">		chart：一个helm程序包，包含了应用程序的一系列的yaml文件
</span></span><span class="line"><span class="cl">		repository：charts仓库，https/http服务器
</span></span><span class="line"><span class="cl">		Release：chart实例化之后部署再k8s上的chart实例
</span></span><span class="line"><span class="cl">		chart -&gt; Config -&gt; Release 
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	程序架构：
</span></span><span class="line"><span class="cl">		helm：客户端，管理本地的Chart仓库，管理Chart，与Tiller服务器交互，发送Chart，实例安装、查询、卸载等操作
</span></span><span class="line"><span class="cl">		Tiller：服务端，接收helm发来的Chart与config，合并生成relase完成部署
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># helm相关网站
</span></span><span class="line"><span class="cl">https://helm.sh/zh/docs/topics/charts/
</span></span><span class="line"><span class="cl">hub.kubeapps.com
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="161-helm部署">16.1 helm部署</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 下载合用版本的压缩包并将其展开。
</span></span><span class="line"><span class="cl">wget https://get.helm.sh/helm-v3.0.2-linux-amd64.tar.gz 
</span></span><span class="line"><span class="cl">tar -xvf helm-v3.0.2-linux-amd64.tar.gz 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将其二进制程序文件复制或移动到系统PATH环境变量指向的目录中
</span></span><span class="line"><span class="cl">cp linux-amd64/helm /usr/local/bin/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 以添加自动完成的代码：
</span></span><span class="line"><span class="cl">source &lt;(helm completion bash) 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Helm客户端安装完成后，进行验证。
</span></span><span class="line"><span class="cl">helm version
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 添加官方Charts仓库
</span></span><span class="line"><span class="cl">helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">https://artifacthub.io/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 更新仓库信息
</span></span><span class="line"><span class="cl">helm repo update
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看官方Charts仓库
</span></span><span class="line"><span class="cl">helm search repo stable 
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="162-常用操作">16.2 常用操作</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://hub.kubeapps.com/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">helm常用命令:
</span></span><span class="line"><span class="cl">	release管理：
</span></span><span class="line"><span class="cl">		install
</span></span><span class="line"><span class="cl">		delete
</span></span><span class="line"><span class="cl">		upgrade/rollback
</span></span><span class="line"><span class="cl">		list
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		history：查看release的历史信息
</span></span><span class="line"><span class="cl">		status: 获取release状态信息
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	chart管理：
</span></span><span class="line"><span class="cl">		create
</span></span><span class="line"><span class="cl">		fetch
</span></span><span class="line"><span class="cl">		get
</span></span><span class="line"><span class="cl">		inspect
</span></span><span class="line"><span class="cl">		package
</span></span><span class="line"><span class="cl">		verify
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"># 查看Charts
</span></span><span class="line"><span class="cl">[root@master ~]# helm search repo redis
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 部署redis
</span></span><span class="line"><span class="cl">[root@master ~]# helm install  redis1 stable/redis
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 查看charts状态
</span></span><span class="line"><span class="cl">[root@master ~]# helm status redis
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 删除charts
</span></span><span class="line"><span class="cl">[root@master ~]# helm delete redis1
</span></span><span class="line"><span class="cl">[root@master ~]# helm delete --purge redis1
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="163-自定义chart">16.3 自定义chart</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="err">#</span> <span class="mi">1</span><span class="err">、</span><span class="nx">获取chart并解压</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="err">~</span><span class="p">]</span><span class="err">#</span> <span class="nx">helm</span> <span class="nx">fetch</span> <span class="nx">stable</span><span class="o">/</span><span class="nx">redis</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="err">~</span><span class="p">]</span><span class="err">#</span> <span class="nx">tar</span> <span class="nx">xf</span> <span class="nx">redis</span><span class="o">-</span><span class="mf">1.1.15</span><span class="p">.</span><span class="nx">tgz</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="mi">2</span><span class="err">、</span><span class="nx">创建chart</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="err">~</span><span class="p">]</span><span class="err">#</span> <span class="nx">helm</span> <span class="nx">create</span> <span class="nx">myapp</span>
</span></span><span class="line"><span class="cl"><span class="nx">Creating</span> <span class="nx">myapp</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="err">~</span><span class="p">]</span><span class="err">#</span> <span class="nx">tree</span> <span class="nx">myapp</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="nx">myapp</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="nx">charts</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="nx">Chart</span><span class="p">.</span><span class="nx">yaml</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="nx">templates</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="nx">deployment</span><span class="p">.</span><span class="nx">yaml</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="nx">_helpers</span><span class="p">.</span><span class="nx">tpl</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="nx">ingress</span><span class="p">.</span><span class="nx">yaml</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="nx">NOTES</span><span class="p">.</span><span class="nx">txt</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="nx">serviceaccount</span><span class="p">.</span><span class="nx">yaml</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="nx">service</span><span class="p">.</span><span class="nx">yaml</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">└──</span> <span class="nx">tests</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>       <span class="err">└──</span> <span class="nx">test</span><span class="o">-</span><span class="nx">connection</span><span class="p">.</span><span class="nx">yaml</span>
</span></span><span class="line"><span class="cl"><span class="err">└──</span> <span class="nx">values</span><span class="p">.</span><span class="nx">yaml</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="mi">3</span><span class="err">、</span><span class="nx">定义Chart</span><span class="p">.</span><span class="nx">yaml文件</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="nx">myapp</span><span class="p">]</span><span class="err">#</span> <span class="nx">cat</span> <span class="nx">Chart</span><span class="p">.</span><span class="nx">yaml</span>
</span></span><span class="line"><span class="cl"><span class="nx">apiVersion</span><span class="p">:</span> <span class="nx">v2</span>
</span></span><span class="line"><span class="cl"><span class="nx">name</span><span class="p">:</span> <span class="nx">myapp</span>
</span></span><span class="line"><span class="cl"><span class="nx">description</span><span class="p">:</span> <span class="nx">A</span> <span class="nx">Helm</span> <span class="nx">chart</span> <span class="k">for</span> <span class="nx">Kubernetes</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span><span class="p">:</span> <span class="nx">application</span>
</span></span><span class="line"><span class="cl"><span class="nx">version</span><span class="p">:</span> <span class="mf">0.1.0</span>
</span></span><span class="line"><span class="cl"><span class="nx">appVersion</span><span class="p">:</span> <span class="mf">1.16.0</span>
</span></span><span class="line"><span class="cl"><span class="nx">maintainer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">ke</span>
</span></span><span class="line"><span class="cl">  <span class="nx">email</span><span class="p">:</span> <span class="nx">khwcloud</span><span class="err">@</span><span class="nx">qq</span><span class="p">.</span><span class="nx">com</span>
</span></span><span class="line"><span class="cl">  <span class="nx">url</span><span class="p">:</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//khwcloud.gitee.io
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="nx">myapp</span><span class="p">]</span><span class="err">#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="mi">4</span><span class="err">、</span><span class="nx">定义values</span><span class="p">.</span><span class="nx">yaml文件</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="nx">myapp</span><span class="p">]</span><span class="err">#</span> <span class="nx">cat</span> <span class="nx">values</span><span class="p">.</span><span class="nx">yaml</span>
</span></span><span class="line"><span class="cl"><span class="nx">replicaCount</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nx">image</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="nx">repository</span><span class="p">:</span> <span class="nx">ikubernetes</span><span class="o">/</span><span class="nx">myapp</span><span class="p">:</span><span class="nx">v1</span>
</span></span><span class="line"><span class="cl">  <span class="nx">tag</span><span class="p">:</span> <span class="nx">v1</span>
</span></span><span class="line"><span class="cl">  <span class="nx">pullPolicy</span><span class="p">:</span> <span class="nx">IfNotPresent</span>
</span></span><span class="line"><span class="cl"><span class="nx">service</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="kd">type</span><span class="p">:</span> <span class="nx">ClusterIP</span>
</span></span><span class="line"><span class="cl">  <span class="nx">port</span><span class="p">:</span> <span class="mi">80</span>
</span></span><span class="line"><span class="cl"><span class="nx">resources</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">limits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cpu</span><span class="p">:</span> <span class="mi">100</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl">    <span class="nx">memory</span><span class="p">:</span> <span class="mi">128</span><span class="nx">Mi</span>
</span></span><span class="line"><span class="cl">  <span class="nx">requests</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cpu</span><span class="p">:</span> <span class="mi">100</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl">    <span class="nx">memory</span><span class="p">:</span> <span class="mi">128</span><span class="nx">Mi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="mi">5</span><span class="err">、</span><span class="nx">语法验证</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="nx">myapp</span><span class="p">]</span><span class="err">#</span> <span class="nx">helm</span> <span class="nx">lint</span> <span class="p">..</span><span class="o">/</span><span class="nx">myapp</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="o">==</span><span class="p">&gt;</span> <span class="nx">Linting</span> <span class="p">..</span><span class="o">/</span><span class="nx">myapp</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">INFO</span><span class="p">]</span> <span class="nx">Chart</span><span class="p">.</span><span class="nx">yaml</span><span class="p">:</span> <span class="nx">icon</span> <span class="nx">is</span> <span class="nx">recommended</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span> <span class="nf">chart</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="nx">linted</span><span class="p">,</span> <span class="mi">0</span> <span class="nf">chart</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="nx">failed</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="mi">6</span><span class="err">、</span><span class="nx">把配置好的chart打包</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="err">~</span><span class="p">]</span><span class="err">#</span> <span class="nx">helm</span> <span class="kn">package</span> <span class="nx">myapp</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="nx">Successfully</span> <span class="nx">packaged</span> <span class="nx">chart</span> <span class="nx">and</span> <span class="nx">saved</span> <span class="nx">it</span> <span class="nx">to</span><span class="p">:</span> <span class="o">/</span><span class="nx">root</span><span class="o">/</span><span class="nx">myapp</span><span class="o">-</span><span class="mf">0.1.0</span><span class="p">.</span><span class="nx">tgz</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="err">~</span><span class="p">]</span><span class="err">#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="mi">7</span><span class="err">、</span><span class="nx">将打包的chart上传仓库</span>
</span></span><span class="line"><span class="cl"><span class="nx">安装Helm</span><span class="o">-</span><span class="nx">Push插件</span>
</span></span><span class="line"><span class="cl"><span class="nx">helm</span> <span class="nx">plugin</span> <span class="nx">install</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//github.com/chartmuseum/helm-push
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">helm</span> <span class="nx">push</span> <span class="nx">myapp</span><span class="o">-</span><span class="mf">0.1.0</span><span class="p">.</span><span class="nx">tgz</span> <span class="err">$</span><span class="nx">NAMESPACE</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="mi">8</span><span class="err">、</span><span class="nx">部署chart</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="err">~</span><span class="p">]</span><span class="err">#</span> <span class="nx">helm</span> <span class="nx">search</span> <span class="nx">repo</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">master</span> <span class="err">~</span><span class="p">]</span><span class="err">#</span> <span class="nx">helm</span> <span class="nx">install</span> <span class="o">--</span><span class="nx">name</span> <span class="nx">myapp</span> <span class="nx">local</span><span class="o">/</span><span class="nx">myapp</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="17-部署efk日志系统">17 部署efk日志系统</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">https://blog.csdn.net/weixin_44443884/article/details/125095867?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166109313016780357237492%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166109313016780357237492&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-125095867-null-null.142^v42^pc_ran_alice,185^v2^control&amp;utm_term=k8s%20efk&amp;spm=1018.2226.3001.4187
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="18-常见问题">18 常见问题</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1、解决k8s的coredns一直处于的crashloopbackoff问题
</span></span><span class="line"><span class="cl">[root@master ~]# kubectl get pod -n kube-system
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS             RESTARTS   AGE
</span></span><span class="line"><span class="cl">coredns-bccdc95cf-87dnm          0/1     CrashLoopBackOff   16         82d
</span></span><span class="line"><span class="cl">coredns-bccdc95cf-xk5r6          0/1     CrashLoopBackOff   16         82d
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">这个问题很可能是由iptables规则的错乱或者缓存导致的，可以依次执行以下命令解决：
</span></span><span class="line"><span class="cl">1 [root@master ~]# systemctl stop kubelet
</span></span><span class="line"><span class="cl">2 [root@master ~]# systemctl stop docker
</span></span><span class="line"><span class="cl">3 [root@master ~]# iptables --flush
</span></span><span class="line"><span class="cl">4 [root@master ~]# iptables -tnat --flush
</span></span><span class="line"><span class="cl">5 [root@master ~]# systemctl start kubelet
</span></span><span class="line"><span class="cl">6 [root@master ~]# systemctl start docker
</span></span><span class="line"><span class="cl">systemctl stop firewalld
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">查看集群情况：kubectl get pod -n kube-system
</span></span><span class="line"><span class="cl">查看kubelet情况：systemctl status kubelet -l
</span></span><span class="line"><span class="cl">查看kubelet系统日志：journalctl -xefu kubelet
</span></span><span class="line"><span class="cl">docker ps 查看容器启动情况
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2、遇到pod拉取国外镜像失败
</span></span><span class="line"><span class="cl">首先可以describe一下pod，查看下该pod使用那个node节点拉取
</span></span><span class="line"><span class="cl">找到对应节点，从国内仓库把镜像托进来就可以
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">khw</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2022-05-15
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/k8s/">k8s</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/cloudday4cicd/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">cloud,day4,cicd</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/cloudday1docker/">
            <span class="next-text nav-default">cloud,day1,docker</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://gitee.com/khwcloud" class="iconfont icon-github" title="github"></a>
  <a href="http://localhost:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2022
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">khw</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.9e3db4166f5901c11faec00349b7b03ae36c12a6e820a208cf498f1aee812258.js"></script>








</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>python,day13,cmdb - blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="khw" /><meta name="description" content="cmdb资产管理系统
" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.100.1 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/pythonday13cmdb/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.8c3cbcb0324c2bb4875ceccba4007cbad4b4ac8377f33af9953c3e7684534a50.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="python,day13,cmdb" />
<meta property="og:description" content="cmdb资产管理系统" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/pythonday13cmdb/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-13T11:06:25+08:00" />
<meta property="article:modified_time" content="2022-04-13T11:06:25+08:00" />

<meta itemprop="name" content="python,day13,cmdb">
<meta itemprop="description" content="cmdb资产管理系统"><meta itemprop="datePublished" content="2022-04-13T11:06:25+08:00" />
<meta itemprop="dateModified" content="2022-04-13T11:06:25+08:00" />
<meta itemprop="wordCount" content="19979">
<meta itemprop="keywords" content="python,cmdb," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="python,day13,cmdb"/>
<meta name="twitter:description" content="cmdb资产管理系统"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">类别</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">类别</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">python,day13,cmdb</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-13 </span>
        <div class="post-category">
            <a href="/categories/python/"> python </a>
            </div>
          <span class="more-meta"> 19979 words </span>
          <span class="more-meta"> 40 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#cmdb项目">cmdb项目</a>
      <ul>
        <li><a href="#1-项目实现">1 项目实现</a></li>
        <li><a href="#1-项目架构">1 项目架构</a></li>
        <li><a href="#2-paramiko模块">2 paramiko模块</a></li>
        <li><a href="#3-第一阶段代码">3 第一阶段代码</a></li>
        <li><a href="#4-第二阶段代码">4 第二阶段代码</a></li>
        <li><a href="#5-日志">5 日志</a>
          <ul>
            <li><a href="#51-捕获异常信息">5.1 捕获异常信息</a></li>
            <li><a href="#52-日志处理">5.2 日志处理</a></li>
            <li><a href="#53-日志等级">5.3 日志等级</a></li>
            <li><a href="#54-多文件日志">5.4 多文件日志</a></li>
            <li><a href="#55-单例日志">5.5 单例日志</a></li>
          </ul>
        </li>
        <li><a href="#6-基于对象封装">6 基于对象封装</a></li>
        <li><a href="#7-案例结合日志和封装实现插件数据处理">7 案例：结合日志和封装实现插件数据处理</a></li>
        <li><a href="#8-资产采集">8 资产采集</a></li>
        <li><a href="#9-资产入库">9 资产入库</a></li>
        <li><a href="#10-今日未采集服务器的资产列表">10 今日未采集服务器的资产列表</a></li>
        <li><a href="#11-api规范restful-api">11 API规范(restful api)</a></li>
        <li><a href="#12-扩展知识点">12 扩展知识点</a></li>
        <li><a href="#13-知识点总结">13 知识点总结</a></li>
        <li><a href="#14-项目总结">14 项目总结</a></li>
        <li><a href="#15-项目代码汇总">15 项目代码汇总</a>
          <ul>
            <li><a href="#151-中控机部分">15.1 中控机部分</a></li>
            <li><a href="#152-api接口部分">15.2 api接口部分</a></li>
            <li><a href="#153-资产管理平台部分">15.3 资产管理平台部分</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>cmdb资产管理系统</p>
<h1 id="cmdb项目">cmdb项目</h1>
<h2 id="1-项目实现">1 项目实现</h2>
<h2 id="1-项目架构">1 项目架构</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1、为什么要开发cmdb?
</span></span><span class="line"><span class="cl">	目的是想要搭建运维自动化平台，减少人工干预，降低人员成本。
</span></span><span class="line"><span class="cl">	构建自动化平台要以资产为核心，之前服务器资产信息都是保存在excel中，不便于管理，所以希望开发一套自动资产采集的系统。
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2、cmdb如何实现?
</span></span><span class="line"><span class="cl">    三部分组成：资产管理平台，api接口部分，中控机部分。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    1)中控机部分：通过paramiko模块(基于ssh创建的连接执行命令)，获取服务器资产信息，然后再进行资产信息的删选(数据的请求方式，获取那些数据等)。然后将资产信息通过requests调用api接口保存到数据库中，并在开发插件的过程中，基于反射和工厂模式实现插件定制的可扩展
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    2)api接口：获取中控机提交的资产数据并进行资产变更处理，它还可以为其他第三方应用提供数据接口
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">    3)资产管理平台：为运维或运维主管提供资产管理，数据报表统计等
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">3、为什么不直接连接数据库？而是使用API呢？
</span></span><span class="line"><span class="cl">	直接连接数据库导致数据不安全，搭建API的平台专门用于提供API服务
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-paramiko模块">2 paramiko模块</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># pip install paramiko
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import paramiko
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 创建ssh对象
</span></span><span class="line"><span class="cl">ssh = paramiko.SSHClient()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 允许连接不在know_hosts文件中的主机
</span></span><span class="line"><span class="cl">ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 连接服务器
</span></span><span class="line"><span class="cl">ssh.connect(hostname=&#39;x.x.x.x&#39;, port=22, username=&#39;root&#39;, password=&#39;xxxx&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 执行命令
</span></span><span class="line"><span class="cl">stdin ,stdout, stderr = ssh.exec_command(&#39;df&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 获取命令结果
</span></span><span class="line"><span class="cl">result = stdout.read()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 关闭连接
</span></span><span class="line"><span class="cl">ssh.close()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">print(result.decode())
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-第一阶段代码">3 第一阶段代码</h2>
<ul>
<li>autoclient(中控机会按照定时任务每天执行)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import requests
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def get_server_info(hostname):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    获取服务器信息
</span></span><span class="line"><span class="cl">    :return:
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    import paramiko
</span></span><span class="line"><span class="cl">    # 创建ssh对象
</span></span><span class="line"><span class="cl">    ssh = paramiko.SSHClient()
</span></span><span class="line"><span class="cl">    # 允许连接不在know_hosts文件中的主机
</span></span><span class="line"><span class="cl">    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
</span></span><span class="line"><span class="cl">    # 连接服务器
</span></span><span class="line"><span class="cl">    ssh.connect(hostname=hostname, port=22, username=&#39;root&#39;, password=&#39;xxxx&#39;)
</span></span><span class="line"><span class="cl">    # 执行命令
</span></span><span class="line"><span class="cl">    stdin, stdout, stderr = ssh.exec_command(&#39;df&#39;)
</span></span><span class="line"><span class="cl">    # 获取命令结果
</span></span><span class="line"><span class="cl">    result = stdout.read()
</span></span><span class="line"><span class="cl">    # 关闭连接
</span></span><span class="line"><span class="cl">    ssh.close()
</span></span><span class="line"><span class="cl">    print(result.decode(&#39;utf-8&#39;)[0:7])
</span></span><span class="line"><span class="cl">    # 对资产信息进行筛选，筛选出我想要的数据
</span></span><span class="line"><span class="cl">    return result.decode(&#39;utf-8&#39;)[0:7]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def run():
</span></span><span class="line"><span class="cl">    # 获取服务器信息
</span></span><span class="line"><span class="cl">    info = get_server_info(&#39;x.x.x.x&#39;)
</span></span><span class="line"><span class="cl">    print(&#39;连接服务器获取资产信息：&#39;, info)
</span></span><span class="line"><span class="cl">    # 将服务器信息发送到api平台(负责入库)
</span></span><span class="line"><span class="cl">    # http://127.0.0.1:8000/api/get_data/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # result = requests.get(
</span></span><span class="line"><span class="cl">    #     url=&#34;http://127.0.0.1:8000/api/get_data/&#34;,
</span></span><span class="line"><span class="cl">    #     params={&#39;host&#39;:&#39;x.x.x.x&#39;, &#39;info&#39;:info}
</span></span><span class="line"><span class="cl">    # )
</span></span><span class="line"><span class="cl">    # print(&#39;把资产信息发送到API&#39;, result.text)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 发送post请求
</span></span><span class="line"><span class="cl">    result = requests.post(
</span></span><span class="line"><span class="cl">        url=&#34;http://127.0.0.1:8000/api/get_data/&#34;,
</span></span><span class="line"><span class="cl">        data={&#39;host&#39;: &#39;x.x.x.x&#39;, &#39;info&#39;: info}
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    print(&#39;把资产信息发送到API&#39;, result.text)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">if __name__ == &#39;__main__&#39;:
</span></span><span class="line"><span class="cl">    run()
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>autoserver</p>
<ul>
<li>
<p>api</p>
<ul>
<li>get_data视图函数</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from django.shortcuts import render,HttpResponse
</span></span><span class="line"><span class="cl">from django.views.decorators.csrf import csrf_exempt
</span></span><span class="line"><span class="cl"># Create your views here.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@csrf_exempt
</span></span><span class="line"><span class="cl">def get_data(request):
</span></span><span class="line"><span class="cl">    print(request.GET)
</span></span><span class="line"><span class="cl">    print(request.POST)
</span></span><span class="line"><span class="cl">    host = request.POST.get(&#39;host&#39;)
</span></span><span class="line"><span class="cl">    info = request.POST.get(&#39;info&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 获取数据之后把他们放到数据库
</span></span><span class="line"><span class="cl">    return HttpResponse(&#39;成功&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>web</p>
<ul>
<li>index视图函数</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from django.shortcuts import render
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Create your views here.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def index(request):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    后台管理首页
</span></span><span class="line"><span class="cl">    :param request:
</span></span><span class="line"><span class="cl">    :return:
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # django中优先去最外层的templates中找，如果找不着会更具每个app的注册顺序去app中找
</span></span><span class="line"><span class="cl">    return render(request, &#39;index.html&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h2 id="4-第二阶段代码">4 第二阶段代码</h2>
<ul>
<li>
<p>autoclient(中控机会按照定时任务每天执行)</p>
<ul>
<li>
<p>app.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import requests
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def ssh(hostname,cmd):
</span></span><span class="line"><span class="cl">    import paramiko
</span></span><span class="line"><span class="cl">    import settings
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 创建ssh对象
</span></span><span class="line"><span class="cl">    ssh = paramiko.SSHClient()
</span></span><span class="line"><span class="cl">    # 允许连接不在know_hosts文件中的主机
</span></span><span class="line"><span class="cl">    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
</span></span><span class="line"><span class="cl">    # 连接服务器
</span></span><span class="line"><span class="cl">    ssh.connect(hostname=hostname, port=settings.SSH_PORT, username=settings.SSH_USER, password=settings.SSH_PWD)
</span></span><span class="line"><span class="cl">    # 执行命令
</span></span><span class="line"><span class="cl">    stdin, stdout, stderr = ssh.exec_command(cmd)
</span></span><span class="line"><span class="cl">    # 获取命令结果
</span></span><span class="line"><span class="cl">    result = stdout.read()
</span></span><span class="line"><span class="cl">    # 关闭连接
</span></span><span class="line"><span class="cl">    ssh.close()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # print(result.decode())
</span></span><span class="line"><span class="cl">    return result.decode()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def task(host):
</span></span><span class="line"><span class="cl">    from lib.plugins import get_server_info
</span></span><span class="line"><span class="cl">    server_info = get_server_info(ssh, host)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    result = requests.post(
</span></span><span class="line"><span class="cl">        url=&#34;http://127.0.0.1:8000/api/get_data/&#34;,
</span></span><span class="line"><span class="cl">        data={&#39;host&#39;: host, &#39;info&#39;: server_info}
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    print(result)
</span></span><span class="line"><span class="cl">    print(server_info)
</span></span><span class="line"><span class="cl">    print(ssh)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># task(ssh, host=&#39;x.x.x.x&#39;)
</span></span><span class="line"><span class="cl">def run():
</span></span><span class="line"><span class="cl">    ###############第一阶段#################
</span></span><span class="line"><span class="cl">    # # from lib.plugins.disk import DiskPlugin
</span></span><span class="line"><span class="cl">    # # from lib.plugins.network import NetworkPlugin
</span></span><span class="line"><span class="cl">    # # from lib.plugins.memory import MemoryPlugin
</span></span><span class="line"><span class="cl">    # # obj1 = DiskPlugin()
</span></span><span class="line"><span class="cl">    # # disk_info = obj1.process()
</span></span><span class="line"><span class="cl">    # #
</span></span><span class="line"><span class="cl">    # # obj2 = MemoryPlugin()
</span></span><span class="line"><span class="cl">    # # memory_info = obj2.process()
</span></span><span class="line"><span class="cl">    # #
</span></span><span class="line"><span class="cl">    # # obj3 = NetworkPlugin()
</span></span><span class="line"><span class="cl">    # # network_info = obj3.process()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ####################第二阶段#####################
</span></span><span class="line"><span class="cl">    # import importlib
</span></span><span class="line"><span class="cl">    # from settings import PLUGIN_CLASS_DICT
</span></span><span class="line"><span class="cl">    # for key,path in PLUGIN_CLASS_DICT.items():
</span></span><span class="line"><span class="cl">    #     # key = &#34;disk&#34;  path = &#39;lib.plugins.disk.DiskPlugin&#39;
</span></span><span class="line"><span class="cl">    #     # path.rsplit(&#39;.&#39;,maxsplit=1)表示从右往左找到第一个点，然后以点为中心左右分割成两个元素放到列表中
</span></span><span class="line"><span class="cl">    #     # lib.plugins.disk     DiskPlugin
</span></span><span class="line"><span class="cl">    #     module_path, class_name = path.rsplit(&#39;.&#39;,maxsplit=1)
</span></span><span class="line"><span class="cl">    #
</span></span><span class="line"><span class="cl">    #     # 模块导入，将path导入(lib.plugins.disk)
</span></span><span class="line"><span class="cl">    #     module = importlib.import_module(module_path)
</span></span><span class="line"><span class="cl">    #
</span></span><span class="line"><span class="cl">    #     # 获取导入对象的类&lt;class &#39;lib.plugins.disk.DiskPlugin&#39;&gt;，类可以加括号实例化
</span></span><span class="line"><span class="cl">    #     #  print(getattr(obj,&#39;name&#39;))  获取对象的属性值
</span></span><span class="line"><span class="cl">    #     cls = getattr(module,class_name)
</span></span><span class="line"><span class="cl">    #
</span></span><span class="line"><span class="cl">    #     # 将类实例化成对象
</span></span><span class="line"><span class="cl">    #     plugin_object = cls()
</span></span><span class="line"><span class="cl">    #
</span></span><span class="line"><span class="cl">    #     # 执行对象内的函数
</span></span><span class="line"><span class="cl">    #     info = plugin_object.process()
</span></span><span class="line"><span class="cl">    #
</span></span><span class="line"><span class="cl">    #     print(key,info)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ####################第三阶段#####################
</span></span><span class="line"><span class="cl">    from concurrent.futures import ThreadPoolExecutor
</span></span><span class="line"><span class="cl">    pool = ThreadPoolExecutor(10)   # 创建十个进程
</span></span><span class="line"><span class="cl">    host_list = [
</span></span><span class="line"><span class="cl">        &#39;x.x.x.x&#39;,
</span></span><span class="line"><span class="cl">    ]
</span></span><span class="line"><span class="cl">    # 调用方法获得服务器信息
</span></span><span class="line"><span class="cl">    for host in host_list:
</span></span><span class="line"><span class="cl">        pool.submit(task, host)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">if __name__ == &#39;__main__&#39;:
</span></span><span class="line"><span class="cl">    run()
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>settings.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PLUGIN_CLASS_DICT = {
</span></span><span class="line"><span class="cl">    &#39;disk&#39;:&#39;lib.plugins.disk.DiskPlugin&#39;,
</span></span><span class="line"><span class="cl">    &#39;memory&#39;:&#39;lib.plugins.memory.MemoryPlugin&#39;,
</span></span><span class="line"><span class="cl">    &#39;network&#39;:&#39;lib.plugins.network.NetworkPlugin&#39;,
</span></span><span class="line"><span class="cl">    &#39;basic&#39;:&#39;lib.plugins.basic.BasicPlugin&#39;,
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SSH_USER = &#39;root&#39;
</span></span><span class="line"><span class="cl">SSH_PORT = 22
</span></span><span class="line"><span class="cl">SSH_PWD = &#39;xxxxx&#39;
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>plugins</p>
<ul>
<li>
<p><strong><strong>init</strong></strong>.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import importlib
</span></span><span class="line"><span class="cl">from settings import PLUGIN_CLASS_DICT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def get_server_info(ssh,hostname):
</span></span><span class="line"><span class="cl">    server_info = {}
</span></span><span class="line"><span class="cl">    for key, path in PLUGIN_CLASS_DICT.items():
</span></span><span class="line"><span class="cl">        # key = &#34;disk&#34;  path = &#39;lib.plugins.disk.DiskPlugin&#39;
</span></span><span class="line"><span class="cl">        # path.rsplit(&#39;.&#39;,maxsplit=1)表示从右往左找到第一个点，然后以点为中心左右分割成两个元素放到列表中
</span></span><span class="line"><span class="cl">        # lib.plugins.disk     DiskPlugin
</span></span><span class="line"><span class="cl">        module_path, class_name = path.rsplit(&#39;.&#39;, maxsplit=1)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 模块导入，将path导入(lib.plugins.disk)
</span></span><span class="line"><span class="cl">        module = importlib.import_module(module_path)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 获取导入对象的类&lt;class &#39;lib.plugins.disk.DiskPlugin&#39;&gt;，类可以加括号实例化
</span></span><span class="line"><span class="cl">        #  print(getattr(obj,&#39;name&#39;))  获取对象的属性值
</span></span><span class="line"><span class="cl">        cls = getattr(module, class_name)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 将类实例化成对象
</span></span><span class="line"><span class="cl">        plugin_object = cls()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 执行对象内的函数
</span></span><span class="line"><span class="cl">        info = plugin_object.process(ssh,hostname)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 将对应的key和结果放到字典中
</span></span><span class="line"><span class="cl">        server_info[key] = info
</span></span><span class="line"><span class="cl">    return server_info
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>base.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 方法的限制
</span></span><span class="line"><span class="cl">class Base_Plugin(object):
</span></span><span class="line"><span class="cl">    def process(self):
</span></span><span class="line"><span class="cl">        raise NotImplementedError(&#34;%s中必须实现process方法&#34;%self.__class__.__name__)
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>disk.py</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from .base import Base_Plugin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class DiskPlugin(Base_Plugin):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    采集硬盘信息
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def process(self,ssh,hostname):
</span></span><span class="line"><span class="cl">        # 假设执行了命令
</span></span><span class="line"><span class="cl">        return ssh(hostname,&#39;df&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<p>​</p>
<h2 id="5-日志">5 日志</h2>
<h3 id="51-捕获异常信息">5.1 捕获异常信息</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import traceback
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">try:
</span></span><span class="line"><span class="cl">    int(&#39;asdads&#39;)
</span></span><span class="line"><span class="cl">except Exception as e:
</span></span><span class="line"><span class="cl">    print(traceback.format_exc())
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="52-日志处理">5.2 日志处理</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import logging
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">logging.basicConfig(filename=&#39;log.log&#39;,
</span></span><span class="line"><span class="cl">                    format=&#39;%(asctime)s - %(name)s - %(levelname)s -%(module)s:  %(message)s&#39;,
</span></span><span class="line"><span class="cl">                    datefmt=&#39;%Y-%m-%d %H:%M:%S %p&#39;,
</span></span><span class="line"><span class="cl">                    level=10)
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">logging.debug(&#39;debug&#39;)
</span></span><span class="line"><span class="cl">logging.info(&#39;info&#39;)
</span></span><span class="line"><span class="cl">logging.warning(&#39;warning&#39;)
</span></span><span class="line"><span class="cl">logging.error(&#39;error&#39;)
</span></span><span class="line"><span class="cl">logging.critical(&#39;critical&#39;)
</span></span><span class="line"><span class="cl">logging.log(10,&#39;log&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="53-日志等级">5.3 日志等级</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">CRITICAL = 50
</span></span><span class="line"><span class="cl">FATAL = CRITICAL
</span></span><span class="line"><span class="cl">ERROR = 40
</span></span><span class="line"><span class="cl">WARNING = 30
</span></span><span class="line"><span class="cl">WARN = WARNING
</span></span><span class="line"><span class="cl">INFO = 20
</span></span><span class="line"><span class="cl">DEBUG = 10
</span></span><span class="line"><span class="cl">NOTSET = 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">注：只有【当前写等级】大于【日志等级】时，日志文件才被记录。
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="54-多文件日志">5.4 多文件日志</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">对于上述记录日志的功能，只能将日志记录在单文件中，如果想要设置多个日志文件，logging.basicConfig将无法完成，需要自定义文件和日志操作对象。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 日志一
</span></span><span class="line"><span class="cl"># 定义文件
</span></span><span class="line"><span class="cl">file_1_1 = logging.FileHandler(&#39;l1_1.log&#39;, &#39;a&#39;, encoding=&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">fmt = logging.Formatter(fmt=&#34;%(asctime)s - %(name)s - %(levelname)s -%(module)s:  %(message)s&#34;)
</span></span><span class="line"><span class="cl">file_1_1.setFormatter(fmt)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">file_1_2 = logging.FileHandler(&#39;l1_2.log&#39;, &#39;a&#39;, encoding=&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">fmt = logging.Formatter()
</span></span><span class="line"><span class="cl">file_1_2.setFormatter(fmt)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 定义日志
</span></span><span class="line"><span class="cl">logger1 = logging.Logger(&#39;s1&#39;, level=logging.ERROR)
</span></span><span class="line"><span class="cl">logger1.addHandler(file_1_1)
</span></span><span class="line"><span class="cl">logger1.addHandler(file_1_2)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 写日志
</span></span><span class="line"><span class="cl">logger1.critical(&#39;1111&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 日志（二）
</span></span><span class="line"><span class="cl"># 定义文件
</span></span><span class="line"><span class="cl">file_2_1 = logging.FileHandler(&#39;l2_1.log&#39;, &#39;a&#39;)
</span></span><span class="line"><span class="cl">fmt = logging.Formatter()
</span></span><span class="line"><span class="cl">file_2_1.setFormatter(fmt)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 定义日志
</span></span><span class="line"><span class="cl">logger2 = logging.Logger(&#39;s2&#39;, level=logging.INFO)
</span></span><span class="line"><span class="cl">logger2.addHandler(file_2_1)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">如上述创建的两个日志对象
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">当使用【logger1】写日志时，会将相应的内容写入 l1_1.log 和 l1_2.log 文件中
</span></span><span class="line"><span class="cl">当使用【logger2】写日志时，会将相应的内容写入 l2_1.log 文件中
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="55-单例日志">5.5 单例日志</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import logging
</span></span><span class="line"><span class="cl">import settings
</span></span><span class="line"><span class="cl">class logger(object):
</span></span><span class="line"><span class="cl">    def __init__(self,file_path,level):
</span></span><span class="line"><span class="cl">        file_handler = logging.FileHandler(file_path, &#39;a&#39;, encoding=&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">        fmt = logging.Formatter(fmt=&#34;%(asctime)s - %(name)s - %(levelname)s -%(module)s:  %(message)s&#34;)
</span></span><span class="line"><span class="cl">        file_handler.setFormatter(fmt)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        self.logger = logging.Logger(&#39;cmdb&#39;, level=level)
</span></span><span class="line"><span class="cl">        self.logger.addHandler(file_handler)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def error(self,msg):
</span></span><span class="line"><span class="cl">        self.logger.error(msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">logger = logger(settings.LOGGING_PATH, logging.DEBUG)
</span></span><span class="line"><span class="cl"># info_logger = Logger(&#39;x1.txt&#39;,logging.DEBUG)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">使用：
</span></span><span class="line"><span class="cl">from .base import Base_Plugin
</span></span><span class="line"><span class="cl">from lib.utlis.log import logger
</span></span><span class="line"><span class="cl">import traceback
</span></span><span class="line"><span class="cl">class MemoryPlugin(Base_Plugin):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    内存信息
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def process(self,ssh,hostname):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        result = None
</span></span><span class="line"><span class="cl">        try:
</span></span><span class="line"><span class="cl">            result = int(&#39;asdasd&#39;)
</span></span><span class="line"><span class="cl">        except Exception as e:
</span></span><span class="line"><span class="cl">            # 如果报错则存它的堆栈信息
</span></span><span class="line"><span class="cl">            logger.error(traceback.format_exc())
</span></span><span class="line"><span class="cl">        return result   
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="6-基于对象封装">6 基于对象封装</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class BaseResponse(object):
</span></span><span class="line"><span class="cl">    def __init__(self, status=True, data=None, error=None):
</span></span><span class="line"><span class="cl">        self.status = status
</span></span><span class="line"><span class="cl">        self.data = data
</span></span><span class="line"><span class="cl">        self.error = error
</span></span><span class="line"><span class="cl">    @property
</span></span><span class="line"><span class="cl">    def dict(self):
</span></span><span class="line"><span class="cl">        return self.__dict__
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def test(request):
</span></span><span class="line"><span class="cl">    # result = {&#39;status&#39;:True, &#39;data&#39;:None, &#39;error&#39;:None}
</span></span><span class="line"><span class="cl">    result = BaseResponse()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    nid = request.GET.get(&#39;id&#39;)
</span></span><span class="line"><span class="cl">    if nid == 10:
</span></span><span class="line"><span class="cl">        # result[&#39;data&#39;] = &#39;数据正确，已收到&#39;
</span></span><span class="line"><span class="cl">        result.data = &#39;数据正确，已收到&#39;
</span></span><span class="line"><span class="cl">    else:
</span></span><span class="line"><span class="cl">        # result[&#39;error&#39;] = &#39;错误&#39;
</span></span><span class="line"><span class="cl">        # result[&#39;status&#39;] = False
</span></span><span class="line"><span class="cl">        result.error = &#39;错误&#39;
</span></span><span class="line"><span class="cl">        result.status = False
</span></span><span class="line"><span class="cl">        # 这个时候result是个对象，需要将对象转为字典，通过__dict__
</span></span><span class="line"><span class="cl">    return JsonResponse(result.dict)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="7-案例结合日志和封装实现插件数据处理">7 案例：结合日志和封装实现插件数据处理</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from .base import Base_Plugin
</span></span><span class="line"><span class="cl">from lib.utlis.response import BaseResponse
</span></span><span class="line"><span class="cl">from lib.utlis.log import logger
</span></span><span class="line"><span class="cl">import traceback
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class MemoryPlugin(Base_Plugin):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    内存信息
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    result = BaseResponse()
</span></span><span class="line"><span class="cl">    def process(self,ssh,hostname):
</span></span><span class="line"><span class="cl">        result = BaseResponse()
</span></span><span class="line"><span class="cl">        try:
</span></span><span class="line"><span class="cl">            result.data = int(&#39;asdf&#39;)
</span></span><span class="line"><span class="cl">        except Exception as e:
</span></span><span class="line"><span class="cl">            logger.error(traceback.format_exc())
</span></span><span class="line"><span class="cl">            result.status = False
</span></span><span class="line"><span class="cl">            result.error = traceback.format_exc()
</span></span><span class="line"><span class="cl">        return result.dict
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return ssh(hostname,&#39;top&#39;)
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">- lib.utlis.response.py
</span></span><span class="line"><span class="cl">class BaseResponse(object):
</span></span><span class="line"><span class="cl">    def __init__(self, status=True, data=None, error=None):
</span></span><span class="line"><span class="cl">        self.status = status
</span></span><span class="line"><span class="cl">        self.data = data
</span></span><span class="line"><span class="cl">        self.error = error
</span></span><span class="line"><span class="cl">    @property
</span></span><span class="line"><span class="cl">    def dict(self):
</span></span><span class="line"><span class="cl">        return self.__dict__
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="8-资产采集">8 资产采集</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">物理机资产信息
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cpu:
</span></span><span class="line"><span class="cl">	cat /proc/cpuinfo
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">主板:
</span></span><span class="line"><span class="cl">	dmidecode -t1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">内存:
</span></span><span class="line"><span class="cl">	dmidecode -q -t 17 2 &gt;/dev/null
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">网卡(salt源码):
</span></span><span class="line"><span class="cl">	ip link show
</span></span><span class="line"><span class="cl">	ip addr show 
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">硬盘:
</span></span><span class="line"><span class="cl">	/opt/MegaRAID/MegaCli/MegaCli64 -PDList -aALL
</span></span><span class="line"><span class="cl">	需要安装
</span></span><span class="line"><span class="cl">	https://www.cnblogs.com/xth0331/p/9655593.html
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="9-资产入库">9 资产入库</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">数据库+新资产，通过集合的交并差进行对比，之后再来做资产的变更记录以及持久化。
</span></span><span class="line"><span class="cl">反射
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>views.py</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from django.shortcuts import HttpResponse
</span></span><span class="line"><span class="cl">from django.views.decorators.csrf import csrf_exempt
</span></span><span class="line"><span class="cl"># Create your views here.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@csrf_exempt
</span></span><span class="line"><span class="cl">def get_data(request):
</span></span><span class="line"><span class="cl">    content = request.body.decode(&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">    server_info_dict = json.loads(content)
</span></span><span class="line"><span class="cl">    hostname = server_info_dict[&#39;host&#39;]
</span></span><span class="line"><span class="cl">    info_dict = server_info_dict[&#39;info&#39;]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    from api.service.disk import process_disk_info
</span></span><span class="line"><span class="cl">    from api import models
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    host_object = models.Server.objects.filter(hostname=hostname).first()
</span></span><span class="line"><span class="cl">    if not host_object:
</span></span><span class="line"><span class="cl">        print(&#39;服务器不存在&#39;)
</span></span><span class="line"><span class="cl">        return HttpResponse(&#39;服务器不存在&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    process_disk_info(host_object,info_dict[&#39;disk&#39;])
</span></span><span class="line"><span class="cl">    # 获取数据之后把他们放到数据库
</span></span><span class="line"><span class="cl">    return HttpResponse(&#39;成功&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>disk.py</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from api import models
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def process_disk_info(host_object,disk_dict):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;处理汇报来的硬盘信息&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    print(disk_dict)
</span></span><span class="line"><span class="cl">    if not disk_dict[&#39;status&#39;]:
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;硬盘的资产信息没有获取到&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        print(&#39;获取硬盘资产时错误：&#39;, disk_dict[&#39;error&#39;])
</span></span><span class="line"><span class="cl">        return
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 新汇报的数据
</span></span><span class="line"><span class="cl">    new_disk_dict = disk_dict[&#39;data&#39;]
</span></span><span class="line"><span class="cl">    new_disk_slot_set = set(new_disk_dict)  # 得到集合
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    db_disk_queryset = models.Disk.objects.filter(server=host_object).all()
</span></span><span class="line"><span class="cl">    db_disk_dict = {row.slot:row for row in db_disk_queryset}
</span></span><span class="line"><span class="cl">    db_disk_slot_set = set(db_disk_dict)       # 得到集合
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    create_slot_set = new_disk_slot_set - db_disk_slot_set
</span></span><span class="line"><span class="cl">    remove_slot_set = db_disk_slot_set - new_disk_slot_set
</span></span><span class="line"><span class="cl">    update_slot_set = new_disk_slot_set &amp; db_disk_slot_set
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    print(&#39;新增&#39;,create_slot_set)
</span></span><span class="line"><span class="cl">    print(&#39;删除&#39;,remove_slot_set)
</span></span><span class="line"><span class="cl">    print(&#39;更新&#39;,update_slot_set)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    record_str_list = []
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 添加
</span></span><span class="line"><span class="cl">    for slot in create_slot_set:
</span></span><span class="line"><span class="cl">        models.Disk.objects.create(**new_disk_dict[slot],server=host_object)
</span></span><span class="line"><span class="cl">        msg = r&#34;【新增硬盘】槽位:{slot},类型:{pd_type},容量:{capacity}\n&#34;.format(**new_disk_dict[slot])
</span></span><span class="line"><span class="cl">        record_str_list.append(msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 删除
</span></span><span class="line"><span class="cl">    models.Disk.objects.filter(server=host_object,slot__in=remove_slot_set).delete()
</span></span><span class="line"><span class="cl">    if remove_slot_set:
</span></span><span class="line"><span class="cl">        msg = &#34;【删除硬盘】槽位:{}&#34;.format(&#39;,&#39;.join(remove_slot_set))
</span></span><span class="line"><span class="cl">        record_str_list.append(msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 更新
</span></span><span class="line"><span class="cl">    for slot in update_slot_set:
</span></span><span class="line"><span class="cl">        # print(new_disk_dict[slot])  # {&#39;slot&#39;: &#39;1&#39;, &#39;pd_type&#39;: &#39;SAS&#39;, &#39;capacity&#39;: &#39;279.396&#39;, &#39;model&#39;: &#39;TOSHIBA AL1&#39;}
</span></span><span class="line"><span class="cl">        # print(db_disk_dict[slot])   # 对象，需要点取值，也可以用过getattr(对象,&#39;x&#39;)取值
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        temp = []
</span></span><span class="line"><span class="cl">        for key, value in new_disk_dict[slot].items():
</span></span><span class="line"><span class="cl">            # print(key, value,getattr(db_disk_dict[slot],key))
</span></span><span class="line"><span class="cl">            old_value = getattr(db_disk_dict[slot],key)
</span></span><span class="line"><span class="cl">            if value == old_value:
</span></span><span class="line"><span class="cl">                continue
</span></span><span class="line"><span class="cl">            msg = &#34;硬盘的{},由{}变更成了{}&#34;.format(key,old_value,value)
</span></span><span class="line"><span class="cl">            temp.append(msg)
</span></span><span class="line"><span class="cl">            setattr(db_disk_dict[slot],key,value)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 如果有变化
</span></span><span class="line"><span class="cl">        if temp:
</span></span><span class="line"><span class="cl">            db_disk_dict[slot].save()
</span></span><span class="line"><span class="cl">            row = &#34;【更新硬盘】槽位:{}，更新的内容:{}&#34;.format(slot,&#39;;&#39;.join(temp))
</span></span><span class="line"><span class="cl">            record_str_list.append(row)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    print(record_str_list)
</span></span><span class="line"><span class="cl">    if record_str_list:
</span></span><span class="line"><span class="cl">        models.AssetsRecord.objects.create(content=&#34;\n&#34;.join(record_str_list),server=host_object)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>models.py</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from django.db import models
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Create your models here.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Server(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;服务器表&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    hostname = models.CharField(verbose_name=&#39;主机名&#39;,max_length=32)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Disk(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;硬盘表&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    slot = models.CharField(verbose_name=&#39;槽位&#39;,max_length=32)
</span></span><span class="line"><span class="cl">    pd_type = models.CharField(verbose_name=&#39;类型&#39;,max_length=32)
</span></span><span class="line"><span class="cl">    capacity = models.CharField(verbose_name=&#39;容量&#39;,max_length=32)
</span></span><span class="line"><span class="cl">    model = models.CharField(verbose_name=&#39;型号&#39;,max_length=32)
</span></span><span class="line"><span class="cl">    server = models.ForeignKey(verbose_name=&#39;服务器&#39;, to=&#39;Server&#39;, on_delete=models.CASCADE)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class AssetsRecord(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;资产变更记录&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    content = models.TextField(verbose_name=&#39;内容&#39;)
</span></span><span class="line"><span class="cl">    server = models.ForeignKey(verbose_name=&#39;服务器&#39;,to=&#39;Server&#39;, on_delete=models.CASCADE)
</span></span><span class="line"><span class="cl">    create_date = models.DateTimeField(verbose_name=&#39;时间&#39;,auto_now_add=True)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="10-今日未采集服务器的资产列表">10 今日未采集服务器的资产列表</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">未采集的资产：None、小于今天日期的。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">通过django的Q查询构造复杂的查询条件。
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>view.py</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import json
</span></span><span class="line"><span class="cl">from django.shortcuts import HttpResponse
</span></span><span class="line"><span class="cl">from django.views.decorators.csrf import csrf_exempt
</span></span><span class="line"><span class="cl">from django.http import JsonResponse
</span></span><span class="line"><span class="cl">from api import models
</span></span><span class="line"><span class="cl">from django.db.models import Q
</span></span><span class="line"><span class="cl">import datetime
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def get_server(reqeust):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;获取今日未采集的服务器列表&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    today = datetime.date.today()
</span></span><span class="line"><span class="cl">    # 最近汇报时间小于今天 or 最近汇报时间=None(新资产)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 这种方式只能是and不能是or所以需要用Q来做
</span></span><span class="line"><span class="cl">    # models.Server.objects.filter(last_date__lt=today, last_date__isnull=True)
</span></span><span class="line"><span class="cl">    server_queryset = models.Server.objects.filter(Q(last_date__lt=today) | Q(last_date__isnull=True)).values_list(
</span></span><span class="line"><span class="cl">        &#39;hostname&#39;)
</span></span><span class="line"><span class="cl">    # 这里的server_queryset是的queryset，不能直接放到JsonResponse，所以需要进一步处理
</span></span><span class="line"><span class="cl">    # server_list = list(server_queryset)     # [(sss),(sss)]
</span></span><span class="line"><span class="cl">    server_list = [item[0] for item in server_queryset]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return JsonResponse({&#39;status&#39;: True, &#39;data&#39;: server_list})
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>models.py</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from django.db import models
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Create your models here.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Server(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;服务器表&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    hostname = models.CharField(verbose_name=&#39;主机名&#39;,max_length=32)
</span></span><span class="line"><span class="cl">    last_date = models.DateField(verbose_name=&#39;最近汇报的时间&#39;,null=True)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="11-api规范restful-api">11 API规范(restful api)</h2>
<p>面向资源编程，把网络上所有的东西都视为资源</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://127.0.0.1:8000/api/server/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- GET,获取数据
</span></span><span class="line"><span class="cl">- POST,新增数据
</span></span><span class="line"><span class="cl">- PUT,修改数据
</span></span><span class="line"><span class="cl">- DELETE,删除数据
</span></span></code></pre></td></tr></table>
</div>
</div><p>基于django的cbv可以实现restful规范</p>
<ul>
<li>url.py</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from django.urls import path,re_path
</span></span><span class="line"><span class="cl">from api import views
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">urlpatterns = [
</span></span><span class="line"><span class="cl">    re_path(r&#39;^server/&#39;, views.ServerView.as_view()),
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">]
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>views.py</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import json
</span></span><span class="line"><span class="cl">import datetime
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from django.views import View
</span></span><span class="line"><span class="cl">from django.db.models import Q
</span></span><span class="line"><span class="cl">from django.http import JsonResponse
</span></span><span class="line"><span class="cl">from django.shortcuts import HttpResponse
</span></span><span class="line"><span class="cl">from django.views.decorators.csrf import csrf_exempt
</span></span><span class="line"><span class="cl">from django.utils.decorators import method_decorator
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from api import models
</span></span><span class="line"><span class="cl">from api.service.disk import process_disk_info
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@method_decorator(csrf_exempt, name=&#39;dispatch&#39;)
</span></span><span class="line"><span class="cl">class ServerView(View):
</span></span><span class="line"><span class="cl">    def get(self, reqeust, *args, **kwargs):
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;获取今日未采集的服务器列表&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        today = datetime.date.today()
</span></span><span class="line"><span class="cl">        # 最近汇报时间小于今天 or 最近汇报时间=None(新资产)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 这种方式只能是and不能是or所以需要用Q来做
</span></span><span class="line"><span class="cl">        # models.Server.objects.filter(last_date__lt=today, last_date__isnull=True)
</span></span><span class="line"><span class="cl">        server_queryset = models.Server.objects.filter(Q(last_date__lt=today) | Q(last_date__isnull=True)).values_list(
</span></span><span class="line"><span class="cl">            &#39;hostname&#39;)
</span></span><span class="line"><span class="cl">        # 这里的server_queryset是的queryset，不能直接放到JsonResponse，所以需要进一步处理
</span></span><span class="line"><span class="cl">        # server_list = list(server_queryset)     # [(sss),(sss)]
</span></span><span class="line"><span class="cl">        server_list = [item[0] for item in server_queryset]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return JsonResponse({&#39;status&#39;: True, &#39;data&#39;: server_list})
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def post(self, request, *args, **kwargs):
</span></span><span class="line"><span class="cl">        content = request.body.decode(&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">        server_info_dict = json.loads(content)
</span></span><span class="line"><span class="cl">        hostname = server_info_dict[&#39;host&#39;]
</span></span><span class="line"><span class="cl">        info_dict = server_info_dict[&#39;info&#39;]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        host_object = models.Server.objects.filter(hostname=hostname).first()
</span></span><span class="line"><span class="cl">        if not host_object:
</span></span><span class="line"><span class="cl">            print(&#39;服务器不存在&#39;)
</span></span><span class="line"><span class="cl">            return HttpResponse(&#39;服务器不存在&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        process_disk_info(host_object, info_dict[&#39;disk&#39;])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        host_object.last_date = datetime.date.today()
</span></span><span class="line"><span class="cl">        host_object.save()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 获取数据之后把他们放到数据库
</span></span><span class="line"><span class="cl">        return HttpResponse(&#39;成功&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="12-扩展知识点">12 扩展知识点</h2>
<p>http请求头：content_type</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">请求体数据格式。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">- From提交
</span></span><span class="line"><span class="cl">	Content-Type：application/x-www-form-urlencoded
</span></span><span class="line"><span class="cl">	数据格式：username=alex&amp;password=dsb
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">- JSON提交
</span></span><span class="line"><span class="cl">	Content-Type：application/json
</span></span><span class="line"><span class="cl">	数据格式：{&#34;username&#34;:&#34;alex&#34;...}
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">服务端读取Content-Type判定用户提交的请求体是什么格式
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ps：如果获取到了json的数据需要在request.body中取，将其解码，然后序列化得到数据
</span></span></code></pre></td></tr></table>
</div>
</div><p>向知乎发送GET请求：https://zhuanlan.zhihu.com/signin?next=%2F</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cocket客户端
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">socket.send(&#34;GET /signin?next=%2F http1.1\r\nhost:www.zhihu.com\r\nuser-agent:...\r\n\r\n&#34;)
</span></span></code></pre></td></tr></table>
</div>
</div><p>登录：向知乎发送POST请求：https://zhuanlan.zhihu.com/api/v3/oauth/sign_in</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">socket.send(&#34;POST /api/v3/oauth/sign_in 
</span></span><span class="line"><span class="cl">http1.1\r\nhost:www.zhihu.com\r\n\r\nusername=alex&amp;passwrod=dsb&#34;)
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果知乎的Django开发的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1、取request.body，原始数据：username=alex&amp;password=dsb
</span></span><span class="line"><span class="cl">2、django读取Content-Type请求头，如果请求头等于application/x-www-from-urlencoded,那么django就会解析request.body中的数据，生成一个QueryDict的对象(类似于字典),然后将字典赋值给request.POST
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">request.POST.get(&#39;username&#39;)
</span></span><span class="line"><span class="cl">reqeust.POST.get(&#39;password&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><p>实际使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 发送请求
</span></span><span class="line"><span class="cl">	- 如果是data，则发送过去的是b&#39;host=192.168.1.1&amp;&#39;info&#39;:[xxx]&#39;这种格式的然后django就会解析request.body中的数据，生成一个QueryDict的对象(类似于字典),然后将字典赋值给request.POST
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">        # result = requests.post(
</span></span><span class="line"><span class="cl">        #     url=&#34;http://127.0.0.1:8000/api/get_data/&#34;,
</span></span><span class="line"><span class="cl">        #     data={&#39;host&#39;: host, &#39;info&#39;: server_info}
</span></span><span class="line"><span class="cl">        # )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	- 如果是jason格式的，则后端收到的是jason的数据，只能到body中取
</span></span><span class="line"><span class="cl">		b&#39;{&#34;host&#34;: &#34;x.x.x.x&#34;}
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">        result = requests.post(
</span></span><span class="line"><span class="cl">            url=&#34;http://127.0.0.1:8000/api/get_data/&#34;,
</span></span><span class="line"><span class="cl">            json={&#39;host&#39;: host, &#39;info&#39;: server_info}
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"># 后端处理
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 如果来的是jason则如下处理
</span></span><span class="line"><span class="cl">def get_data(request):
</span></span><span class="line"><span class="cl">    content = request.body.decode(&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">    server_info_dict = json.loads(content)
</span></span><span class="line"><span class="cl">    # 获取数据之后把他们放到数据库
</span></span><span class="line"><span class="cl">    return HttpResponse(&#39;成功&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="13-知识点总结">13 知识点总结</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">	1) 类的继承做约束,约束的子类中必须要实现某个方法
</span></span><span class="line"><span class="cl">	2) 线程池
</span></span><span class="line"><span class="cl">	3) 反射
</span></span><span class="line"><span class="cl">		- 1 什么是反射：通过字符串的形式去操作对象中的成员
</span></span><span class="line"><span class="cl">		- 2 应用场景：CMDB插件的可扩展性使用到了
</span></span><span class="line"><span class="cl">	4) 工厂模式
</span></span><span class="line"><span class="cl">		- 1 简单工厂
</span></span><span class="line"><span class="cl">		- 2 工厂方法
</span></span><span class="line"><span class="cl">		- 3 抽象工厂
</span></span><span class="line"><span class="cl">	5) paramiko模块
</span></span><span class="line"><span class="cl">	6) csrftoken认证(装饰器实现的)
</span></span><span class="line"><span class="cl">	7) content-type请求头
</span></span><span class="line"><span class="cl">	8) 单例模式
</span></span><span class="line"><span class="cl">	9) @csrf_exempt/@csrf_protected
</span></span><span class="line"><span class="cl">	10) 约束
</span></span><span class="line"><span class="cl">		类的继承+异常
</span></span><span class="line"><span class="cl">		抽象类和抽象方法
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	11) 获取异常的堆栈信息
</span></span><span class="line"><span class="cl">	12) logging模块记录日志
</span></span><span class="line"><span class="cl">	13) 数据的封装BaseResponse
</span></span><span class="line"><span class="cl">	14) 创建数据，批量创建数据(通过字典)
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		object_list = {
</span></span><span class="line"><span class="cl">		models.user.info(name=&#39;alex&#39;,age=99)
</span></span><span class="line"><span class="cl">		...
</span></span><span class="line"><span class="cl">		100
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        models.userinfo.objects.bulk_create(object_list, 10)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	15) 使用django自带的auth认证模块进行用户密码校验
</span></span><span class="line"><span class="cl">	16) 自动签发token
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	17) 登录认证装饰器
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	18)	使用cookie和session完善登录功能
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="14-项目总结">14 项目总结</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1、为什么要开发cmdb?
</span></span><span class="line"><span class="cl">	目的是想要搭建运维自动化平台，减少人工干预，降低人员成本。
</span></span><span class="line"><span class="cl">	构建自动化平台要以资产为核心，之前服务器资产信息都是保存在excel中，不便于管理，所以希望开发一套自动资产采集的系统。
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">2、cmdb如何实现?
</span></span><span class="line"><span class="cl">    三部分组成：资产管理平台，api接口部分，中控机部分。
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    1)中控机部分：通过paramiko模块(基于ssh创建的连接执行命令)，获取服务器资产信息，然后再进行资产信息的删选(数据的请求方式，获取那些数据等)。然后将资产信息通过requests调用api接口保存到数据库中，并在开发插件的过程中，基于反射和工厂模式实现插件定制的可扩展
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    2)api接口：获取中控机提交的资产数据并进行资产变更处理，它还可以为其他第三方应用提供数据接口
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">    3)资产管理平台：为运维或运维主管提供资产管理，数据报表统计等
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">3、为什么不直接连接数据库？而是使用API呢？
</span></span><span class="line"><span class="cl">	直接连接数据库导致数据不安全，搭建API的平台专门用于提供API服务
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">4、用到的技术点
</span></span><span class="line"><span class="cl">	1) 类的继承做约束,约束的子类中必须要实现某个方法
</span></span><span class="line"><span class="cl">	2) 线程池
</span></span><span class="line"><span class="cl">	3) 反射
</span></span><span class="line"><span class="cl">		- 1 什么是反射：通过字符串的形式去操作对象中的成员
</span></span><span class="line"><span class="cl">		- 2 应用场景：CMDB插件的可扩展性使用到了
</span></span><span class="line"><span class="cl">	4) 工厂模式
</span></span><span class="line"><span class="cl">		- 1 简单工厂
</span></span><span class="line"><span class="cl">		- 2 工厂方法
</span></span><span class="line"><span class="cl">		- 3 抽象工厂
</span></span><span class="line"><span class="cl">	5) paramiko模块
</span></span><span class="line"><span class="cl">	6) csrftoken认证(装饰器实现的)
</span></span><span class="line"><span class="cl">	7) content-type请求头
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">5、项目亮点？记忆深刻？遇到的问题？如何解决？
</span></span><span class="line"><span class="cl">	插件
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">6、项目缺点？
</span></span><span class="line"><span class="cl">基于ssh，采集慢，适用于少量的服务器
</span></span><span class="line"><span class="cl">如果想要处理的多，需要在每台服务器上放一个agent(代码放在服务器上)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">7、采集的信息？
</span></span><span class="line"><span class="cl">	采集的都是物理机的信息，云里面的虚拟机可以通过现成的api接口采集
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">8、采集资产的时候用到了那些命令？
</span></span><span class="line"><span class="cl">	基于定时任务：每天采集一次。
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">9、资产采集有几张表
</span></span><span class="line"><span class="cl">	业务线表
</span></span><span class="line"><span class="cl">	服务器表
</span></span><span class="line"><span class="cl">	idc机房表
</span></span><span class="line"><span class="cl">	硬盘
</span></span><span class="line"><span class="cl">	内存
</span></span><span class="line"><span class="cl">	网卡
</span></span><span class="line"><span class="cl">	变更记录
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	用户表(使用了django的auth认证模块)
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">10、整个项目实现功能：资产采集，用户登录认证，展示资产详细信息变更记录等，添加管理机器，每天每台机器只手机一次
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="15-项目代码汇总">15 项目代码汇总</h2>
<h3 id="151-中控机部分">15.1 中控机部分</h3>
<h4 id="files">files</h4>
<h5 id="diskout">disk.out</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PD: 0 Information
</span></span><span class="line"><span class="cl">Enclosure Device ID: 252
</span></span><span class="line"><span class="cl">Slot Number: 1
</span></span><span class="line"><span class="cl">Drive&#39;s position: DiskGroup: 1, Span: 0, Arm: 0
</span></span><span class="line"><span class="cl">Enclosure position: N/A
</span></span><span class="line"><span class="cl">Device Id: 3
</span></span><span class="line"><span class="cl">WWN: 500003963820BFE1
</span></span><span class="line"><span class="cl">Sequence Number: 2
</span></span><span class="line"><span class="cl">Media Error Count: 0
</span></span><span class="line"><span class="cl">Other Error Count: 0
</span></span><span class="line"><span class="cl">Predictive Failure Count: 0
</span></span><span class="line"><span class="cl">Last Predictive Failure Event Seq Number: 0
</span></span><span class="line"><span class="cl">PD Type: SAS
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Raw Size: 279.396 GB [0x22ecb25c Sectors]
</span></span><span class="line"><span class="cl">Non Coerced Size: 278.896 GB [0x22dcb25c Sectors]
</span></span><span class="line"><span class="cl">Coerced Size: 278.875 GB [0x22dc0000 Sectors]
</span></span><span class="line"><span class="cl">Sector Size:  512
</span></span><span class="line"><span class="cl">Logical Sector Size:  512
</span></span><span class="line"><span class="cl">Physical Sector Size:  512
</span></span><span class="line"><span class="cl">Firmware state: Online, Spun Up
</span></span><span class="line"><span class="cl">Commissioned Spare : No
</span></span><span class="line"><span class="cl">Emergency Spare : No
</span></span><span class="line"><span class="cl">Device Firmware Level: 1004
</span></span><span class="line"><span class="cl">Shield Counter: 0
</span></span><span class="line"><span class="cl">Successful diagnostics completion on :  N/A
</span></span><span class="line"><span class="cl">SAS Address(0): 0x500003963820bfe2
</span></span><span class="line"><span class="cl">SAS Address(1): 0x0
</span></span><span class="line"><span class="cl">Connected Port Number: 1(path0)
</span></span><span class="line"><span class="cl">Inquiry Data: TOSHIBA AL13SEB300
</span></span><span class="line"><span class="cl">FDE Capable: Not Capable
</span></span><span class="line"><span class="cl">FDE Enable: Disable
</span></span><span class="line"><span class="cl">Secured: Unsecured
</span></span><span class="line"><span class="cl">Locked: Unlocked
</span></span><span class="line"><span class="cl">Needs EKM Attention: No
</span></span><span class="line"><span class="cl">Foreign State: None
</span></span><span class="line"><span class="cl">Device Speed: 6.0Gb/s
</span></span><span class="line"><span class="cl">Link Speed: 6.0Gb/s
</span></span><span class="line"><span class="cl">Media Type: Hard Disk Device
</span></span><span class="line"><span class="cl">Drive:  Not Certified
</span></span><span class="line"><span class="cl">Drive Temperature :24C (75.20 F)
</span></span><span class="line"><span class="cl">PI Eligibility:  No
</span></span><span class="line"><span class="cl">Drive is formatted for PI information:  No
</span></span><span class="line"><span class="cl">PI: No PI
</span></span><span class="line"><span class="cl">Port-0 :
</span></span><span class="line"><span class="cl">Port status: Active
</span></span><span class="line"><span class="cl">Port&#39;s Linkspeed: 6.0Gb/s
</span></span><span class="line"><span class="cl">Port-1 :
</span></span><span class="line"><span class="cl">Port status: Active
</span></span><span class="line"><span class="cl">Port&#39;s Linkspeed: 6.0Gb/s
</span></span><span class="line"><span class="cl">Drive has flagged a S.M.A.R.T alert : No
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="lib">lib</h4>
<h5 id="plugins">plugins</h5>
<h6 id="__init__py"><strong>init</strong>.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 执行各个收集模块的函数
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import importlib
</span></span><span class="line"><span class="cl">from settings import PLUGIN_CLASS_DICT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def get_server_info(ssh,hostname):
</span></span><span class="line"><span class="cl">    server_info = {}
</span></span><span class="line"><span class="cl">    for key, path in PLUGIN_CLASS_DICT.items():
</span></span><span class="line"><span class="cl">        # key = &#34;disk&#34;  path = &#39;lib.plugins.disk.DiskPlugin&#39;
</span></span><span class="line"><span class="cl">        # path.rsplit(&#39;.&#39;,maxsplit=1)表示从右往左找到第一个点，然后以点为中心左右分割成两个元素放到列表中
</span></span><span class="line"><span class="cl">        # lib.plugins.disk     DiskPlugin
</span></span><span class="line"><span class="cl">        module_path, class_name = path.rsplit(&#39;.&#39;, maxsplit=1)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 模块导入，将path导入(lib.plugins.disk)
</span></span><span class="line"><span class="cl">        module = importlib.import_module(module_path)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 获取导入对象的类&lt;class &#39;lib.plugins.disk.DiskPlugin&#39;&gt;，类可以加括号实例化
</span></span><span class="line"><span class="cl">        #  print(getattr(obj,&#39;name&#39;))  获取对象的属性值
</span></span><span class="line"><span class="cl">        cls = getattr(module, class_name)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 将类实例化成对象
</span></span><span class="line"><span class="cl">        plugin_object = cls()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 执行对象内的函数
</span></span><span class="line"><span class="cl">        info = plugin_object.process(ssh,hostname)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 将对应的key和结果放到字典中
</span></span><span class="line"><span class="cl">        server_info[key] = info
</span></span><span class="line"><span class="cl">    return server_info
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="basepy">base.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Base_Plugin(object):
</span></span><span class="line"><span class="cl">    def process(self):
</span></span><span class="line"><span class="cl">        raise NotImplementedError(&#34;%s中必须实现process方法&#34;%self.__class__.__name__)
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="basicpy">basic.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 基本信息
</span></span><span class="line"><span class="cl">from .base import Base_Plugin
</span></span><span class="line"><span class="cl">from lib.utlis.response import BaseResponse
</span></span><span class="line"><span class="cl">from lib.utlis.log import logger
</span></span><span class="line"><span class="cl">import traceback
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class BasicPlugin(Base_Plugin):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;基本信息&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    def process(self,ssh,hostname):
</span></span><span class="line"><span class="cl">        response = BaseResponse()
</span></span><span class="line"><span class="cl">        try:
</span></span><span class="line"><span class="cl">            uname = ssh(hostname, &#39;uname&#39;)
</span></span><span class="line"><span class="cl">            version = ssh(hostname, &#39;cat /etc/issue&#39;).strip().split(&#39;\n&#39;)[0]
</span></span><span class="line"><span class="cl">            response.data = {
</span></span><span class="line"><span class="cl">                &#39;uname&#39;:uname,
</span></span><span class="line"><span class="cl">                &#39;version&#39;:version,
</span></span><span class="line"><span class="cl">            }
</span></span><span class="line"><span class="cl">        except Exception as e:
</span></span><span class="line"><span class="cl">            logger.error(traceback.format_exc())
</span></span><span class="line"><span class="cl">            response.status = False
</span></span><span class="line"><span class="cl">            response.error = traceback.format_exc()
</span></span><span class="line"><span class="cl">        return response.dict
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="boardpy">board.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 主板信息
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from .base import Base_Plugin
</span></span><span class="line"><span class="cl">from lib.utlis.response import BaseResponse
</span></span><span class="line"><span class="cl">from lib.utlis.log import logger
</span></span><span class="line"><span class="cl">import traceback
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class BoardPlugin(Base_Plugin):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    主板
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    response = BaseResponse()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def process(self, ssh, hostname):
</span></span><span class="line"><span class="cl">        response = BaseResponse()
</span></span><span class="line"><span class="cl">        try:
</span></span><span class="line"><span class="cl">            result = ssh(hostname, &#39;dmidecode -t1&#39;)
</span></span><span class="line"><span class="cl">            response.data = self.parse(result)
</span></span><span class="line"><span class="cl">        except Exception as e:
</span></span><span class="line"><span class="cl">            logger.error(traceback.format_exc())
</span></span><span class="line"><span class="cl">            response.status = False
</span></span><span class="line"><span class="cl">            response.error = traceback.format_exc()
</span></span><span class="line"><span class="cl">        return response.dict
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def parse(self, content):
</span></span><span class="line"><span class="cl">        result = {}
</span></span><span class="line"><span class="cl">        key_map = {
</span></span><span class="line"><span class="cl">            &#39;Manufacturer&#39;: &#39;manufacturer&#39;,
</span></span><span class="line"><span class="cl">            &#39;Product Name&#39;: &#39;model&#39;,
</span></span><span class="line"><span class="cl">            &#39;Serial Number&#39;: &#39;sn&#39;,
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        for item in content.split(&#39;\n&#39;):
</span></span><span class="line"><span class="cl">            row_data = item.strip().split(&#39;:&#39;)
</span></span><span class="line"><span class="cl">            if len(row_data) == 2:
</span></span><span class="line"><span class="cl">                if row_data[0] in key_map:
</span></span><span class="line"><span class="cl">                    result[key_map[row_data[0]]] = row_data[1].strip() if row_data[1] else row_data[1]
</span></span><span class="line"><span class="cl">        return result
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="cpupy">cpu.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># cpu.py
</span></span><span class="line"><span class="cl">from .base import Base_Plugin
</span></span><span class="line"><span class="cl">from lib.utlis.response import BaseResponse
</span></span><span class="line"><span class="cl">from lib.utlis.log import logger
</span></span><span class="line"><span class="cl">import traceback
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class CpuPlugin(object):
</span></span><span class="line"><span class="cl">    def process(self,ssh,hostname):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        response = BaseResponse()
</span></span><span class="line"><span class="cl">        try:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            cpulist = ssh(hostname, &#39;cat /proc/cpuinfo&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            response.data = self.parse(cpulist)
</span></span><span class="line"><span class="cl">        except Exception as e:
</span></span><span class="line"><span class="cl">            logger.error(traceback.format_exc())
</span></span><span class="line"><span class="cl">            response.status = False
</span></span><span class="line"><span class="cl">            response.error = traceback.format_exc()
</span></span><span class="line"><span class="cl">        return response.dict
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def parse(self, content,hostname):
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        解析shell命令返回结果
</span></span><span class="line"><span class="cl">        :param content: shell 命令结果
</span></span><span class="line"><span class="cl">        :return:解析后的结果
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        response = {&#39;{hostname}&#39;.format(hostname=hostname):{&#39;cpu_count&#39;: 0, &#39;cpu_physical_count&#39;: 0, &#39;cpu_model&#39;: &#39;&#39;}}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        cpu_physical_set = set()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        content = content.strip()
</span></span><span class="line"><span class="cl">        for item in content.split(&#39;\n\n&#39;):
</span></span><span class="line"><span class="cl">            for row_line in item.split(&#39;\n&#39;):
</span></span><span class="line"><span class="cl">                key, value = row_line.split(&#39;:&#39;)
</span></span><span class="line"><span class="cl">                key = key.strip()
</span></span><span class="line"><span class="cl">                if key == &#39;processor&#39;:
</span></span><span class="line"><span class="cl">                    response[&#39;cpu_count&#39;] += 1
</span></span><span class="line"><span class="cl">                elif key == &#39;physical id&#39;:
</span></span><span class="line"><span class="cl">                    cpu_physical_set.add(value)
</span></span><span class="line"><span class="cl">                elif key == &#39;model name&#39;:
</span></span><span class="line"><span class="cl">                    if not response[&#39;cpu_model&#39;]:
</span></span><span class="line"><span class="cl">                        response[&#39;cpu_model&#39;] = value
</span></span><span class="line"><span class="cl">        response[&#39;cpu_physical_count&#39;] = len(cpu_physical_set)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return response
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="diskpy">disk.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">用于采集硬盘信息
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from .base import Base_Plugin
</span></span><span class="line"><span class="cl">from lib.utlis.response import BaseResponse
</span></span><span class="line"><span class="cl">from lib.utlis.log import logger
</span></span><span class="line"><span class="cl">import traceback
</span></span><span class="line"><span class="cl">import settings
</span></span><span class="line"><span class="cl">import re
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class DiskPlugin(Base_Plugin):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    采集硬盘信息
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    response = BaseResponse()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def process(self, ssh, hostname):
</span></span><span class="line"><span class="cl">        response = BaseResponse()
</span></span><span class="line"><span class="cl">        try:
</span></span><span class="line"><span class="cl">            # output = ssh(hostname, &#39;/opt/MegaRAID/MegaCli/MegaCli64 -PDList -aALL&#39;)
</span></span><span class="line"><span class="cl">            with open(settings.LOCAL_DISK_FILE_PATH) as f:
</span></span><span class="line"><span class="cl">                output = f.read()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            response.data = self.parse(output)
</span></span><span class="line"><span class="cl">        except Exception as e:
</span></span><span class="line"><span class="cl">            logger.error(traceback.format_exc())
</span></span><span class="line"><span class="cl">            response.status = False
</span></span><span class="line"><span class="cl">            response.error = traceback.format_exc()
</span></span><span class="line"><span class="cl">        return response.dict
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def parse(self, content):
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        解析shell命令返回结果
</span></span><span class="line"><span class="cl">        :param content: shell 命令结果
</span></span><span class="line"><span class="cl">        :return:解析后的结果
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        response = {}
</span></span><span class="line"><span class="cl">        result = []
</span></span><span class="line"><span class="cl">        for row_line in content.split(&#34;\n\n\n\n&#34;):
</span></span><span class="line"><span class="cl">            result.append(row_line)
</span></span><span class="line"><span class="cl">        for item in result:
</span></span><span class="line"><span class="cl">            temp_dict = {}
</span></span><span class="line"><span class="cl">            for row in item.split(&#39;\n&#39;):
</span></span><span class="line"><span class="cl">                if not row.strip():
</span></span><span class="line"><span class="cl">                    continue
</span></span><span class="line"><span class="cl">                if len(row.split(&#39;:&#39;)) != 2:
</span></span><span class="line"><span class="cl">                    continue
</span></span><span class="line"><span class="cl">                key, value = row.split(&#39;:&#39;)
</span></span><span class="line"><span class="cl">                name = self.mega_patter_match(key)
</span></span><span class="line"><span class="cl">                if name:
</span></span><span class="line"><span class="cl">                    if key == &#39;Raw Size&#39;:
</span></span><span class="line"><span class="cl">                        raw_size = re.search(&#39;(\d+\.\d+)&#39;, value.strip())
</span></span><span class="line"><span class="cl">                        if raw_size:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                            temp_dict[name] = raw_size.group()
</span></span><span class="line"><span class="cl">                        else:
</span></span><span class="line"><span class="cl">                            raw_size = &#39;0&#39;
</span></span><span class="line"><span class="cl">                    else:
</span></span><span class="line"><span class="cl">                        temp_dict[name] = value.strip()
</span></span><span class="line"><span class="cl">            if temp_dict:
</span></span><span class="line"><span class="cl">                response[temp_dict[&#39;slot&#39;]] = temp_dict
</span></span><span class="line"><span class="cl">        return response
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    @staticmethod
</span></span><span class="line"><span class="cl">    def mega_patter_match(needle):
</span></span><span class="line"><span class="cl">        grep_pattern = {&#39;Slot&#39;: &#39;slot&#39;, &#39;Raw Size&#39;: &#39;capacity&#39;, &#39;Inquiry&#39;: &#39;model&#39;, &#39;PD Type&#39;: &#39;pd_type&#39;}
</span></span><span class="line"><span class="cl">        for key, value in grep_pattern.items():
</span></span><span class="line"><span class="cl">            if needle.startswith(key):
</span></span><span class="line"><span class="cl">                return value
</span></span><span class="line"><span class="cl">        return False
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="memorypy">memory.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from .base import Base_Plugin
</span></span><span class="line"><span class="cl">from lib.utlis.response import BaseResponse
</span></span><span class="line"><span class="cl">from lib.utlis.log import logger
</span></span><span class="line"><span class="cl">from lib.utlis import convert
</span></span><span class="line"><span class="cl">import traceback
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class MemoryPlugin(Base_Plugin):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    内存信息
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    response = BaseResponse()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def process(self, ssh, hostname):
</span></span><span class="line"><span class="cl">        response = BaseResponse()
</span></span><span class="line"><span class="cl">        try:
</span></span><span class="line"><span class="cl">            result = ssh(hostname, &#39;dmidecode -q -t 17 2 &#39;)
</span></span><span class="line"><span class="cl">            response.data = self.parse(result)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        except Exception as e:
</span></span><span class="line"><span class="cl">            logger.error(traceback.format_exc())
</span></span><span class="line"><span class="cl">            response.status = False
</span></span><span class="line"><span class="cl">            response.error = traceback.format_exc()
</span></span><span class="line"><span class="cl">        return response.dict
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def parse(self,content):
</span></span><span class="line"><span class="cl">        ram_dict = {}
</span></span><span class="line"><span class="cl">        key_map = {
</span></span><span class="line"><span class="cl">            &#39;Size&#39;:&#39;capacity&#39;,
</span></span><span class="line"><span class="cl">            &#39;Locator&#39;:&#39;slot&#39;,
</span></span><span class="line"><span class="cl">            &#39;Type&#39;:&#39;model&#39;,
</span></span><span class="line"><span class="cl">            &#39;Speed&#39;:&#39;speed&#39;,
</span></span><span class="line"><span class="cl">            &#39;Manufacturer&#39;:&#39;manufacturer&#39;,
</span></span><span class="line"><span class="cl">            &#39;Serial Number&#39;:&#39;sn&#39;,
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        devices = content.split(&#39;Memory Device&#39;)
</span></span><span class="line"><span class="cl">        for item in devices:
</span></span><span class="line"><span class="cl">            item = item.strip()
</span></span><span class="line"><span class="cl">            if not item:
</span></span><span class="line"><span class="cl">                continue
</span></span><span class="line"><span class="cl">            if item.startswith(&#39;#&#39;):
</span></span><span class="line"><span class="cl">                continue
</span></span><span class="line"><span class="cl">            segment = {}
</span></span><span class="line"><span class="cl">            lines = item.split(&#39;\n\t&#39;)
</span></span><span class="line"><span class="cl">            for line in lines:
</span></span><span class="line"><span class="cl">                if len(line.split(&#39;:&#39;)) &gt;1:
</span></span><span class="line"><span class="cl">                    key,value = line.split(&#39;:&#39;)
</span></span><span class="line"><span class="cl">                else:
</span></span><span class="line"><span class="cl">                    key = line.split(&#39;:&#39;)[0]
</span></span><span class="line"><span class="cl">                    value = &#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                if key in key_map:
</span></span><span class="line"><span class="cl">                    if key == &#39;Size&#39;:
</span></span><span class="line"><span class="cl">                        segment[key_map[&#39;Size&#39;]] = convert.convert_mb_to_gb(value, 0)
</span></span><span class="line"><span class="cl">                    else:
</span></span><span class="line"><span class="cl">                        segment[key_map[key.strip()]] = value.strip()
</span></span><span class="line"><span class="cl">            ram_dict[segment[&#39;slot&#39;]] = segment
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return ram_dict
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="networkpy">network.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from .base import Base_Plugin
</span></span><span class="line"><span class="cl">from lib.utlis.response import BaseResponse
</span></span><span class="line"><span class="cl">from lib.utlis.log import logger
</span></span><span class="line"><span class="cl">from lib.utlis import convert
</span></span><span class="line"><span class="cl">import traceback
</span></span><span class="line"><span class="cl">import os,re
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class NetworkPlugin(Base_Plugin):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    网络信息
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    response = BaseResponse()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def process(self, ssh, hostname):
</span></span><span class="line"><span class="cl">        response = BaseResponse()
</span></span><span class="line"><span class="cl">        try:
</span></span><span class="line"><span class="cl">            cmd1 = ssh(hostname, &#39;ip link show&#39;)
</span></span><span class="line"><span class="cl">            cmd2 = ssh(hostname, &#39;ip addr show&#39;)
</span></span><span class="line"><span class="cl">            result = self._interfaces_ip(cmd1+ &#39;\n&#39; + cmd2)
</span></span><span class="line"><span class="cl">            print(result)
</span></span><span class="line"><span class="cl">            response.data = result
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        except Exception as e:
</span></span><span class="line"><span class="cl">            logger.error(traceback.format_exc())
</span></span><span class="line"><span class="cl">            response.status = False
</span></span><span class="line"><span class="cl">            response.error = traceback.format_exc()
</span></span><span class="line"><span class="cl">        return response.dict
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def which(self, exe):
</span></span><span class="line"><span class="cl">        def _is_executable_file_or_link(exe):
</span></span><span class="line"><span class="cl">            # check for os.X_OK doesn&#39;t suffice because directory may executable
</span></span><span class="line"><span class="cl">            return (os.access(exe, os.X_OK) and
</span></span><span class="line"><span class="cl">                    (os.path.isfile(exe) or os.path.islink(exe)))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if exe:
</span></span><span class="line"><span class="cl">            if _is_executable_file_or_link(exe):
</span></span><span class="line"><span class="cl">                # executable in cwd or fullpath
</span></span><span class="line"><span class="cl">                return exe
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            # default path based on busybox&#39;s default
</span></span><span class="line"><span class="cl">            default_path = &#39;/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin&#39;
</span></span><span class="line"><span class="cl">            search_path = os.environ.get(&#39;PATH&#39;, default_path)
</span></span><span class="line"><span class="cl">            path_ext = os.environ.get(&#39;PATHEXT&#39;, &#39;.EXE&#39;)
</span></span><span class="line"><span class="cl">            ext_list = path_ext.split(&#39;;&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            search_path = search_path.split(os.pathsep)
</span></span><span class="line"><span class="cl">            if True:
</span></span><span class="line"><span class="cl">                # Add any dirs in the default_path which are not in search_path. If
</span></span><span class="line"><span class="cl">                # there was no PATH variable found in os.environ, then this will be
</span></span><span class="line"><span class="cl">                # a no-op. This ensures that all dirs in the default_path are
</span></span><span class="line"><span class="cl">                # searched, which lets salt.utils.which() work well when invoked by
</span></span><span class="line"><span class="cl">                # salt-call running from cron (which, depending on platform, may
</span></span><span class="line"><span class="cl">                # have a severely limited PATH).
</span></span><span class="line"><span class="cl">                search_path.extend(
</span></span><span class="line"><span class="cl">                    [
</span></span><span class="line"><span class="cl">                        x for x in default_path.split(os.pathsep)
</span></span><span class="line"><span class="cl">                        if x not in search_path
</span></span><span class="line"><span class="cl">                    ]
</span></span><span class="line"><span class="cl">                )
</span></span><span class="line"><span class="cl">            for path in search_path:
</span></span><span class="line"><span class="cl">                full_path = os.path.join(path, exe)
</span></span><span class="line"><span class="cl">                if _is_executable_file_or_link(full_path):
</span></span><span class="line"><span class="cl">                    return full_path
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def _number_of_set_bits_to_ipv4_netmask(self, set_bits):  # pylint: disable=C0103
</span></span><span class="line"><span class="cl">        &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">        Returns an IPv4 netmask from the integer representation of that mask.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Ex. 0xffffff00 -&gt; &#39;255.255.255.0&#39;
</span></span><span class="line"><span class="cl">        &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">        return self.cidr_to_ipv4_netmask(self._number_of_set_bits(set_bits))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def cidr_to_ipv4_netmask(self, cidr_bits):
</span></span><span class="line"><span class="cl">        &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">        Returns an IPv4 netmask
</span></span><span class="line"><span class="cl">        &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">        try:
</span></span><span class="line"><span class="cl">            cidr_bits = int(cidr_bits)
</span></span><span class="line"><span class="cl">            if not 1 &lt;= cidr_bits &lt;= 32:
</span></span><span class="line"><span class="cl">                return &#39;&#39;
</span></span><span class="line"><span class="cl">        except ValueError:
</span></span><span class="line"><span class="cl">            return &#39;&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        netmask = &#39;&#39;
</span></span><span class="line"><span class="cl">        for idx in range(4):
</span></span><span class="line"><span class="cl">            if idx:
</span></span><span class="line"><span class="cl">                netmask += &#39;.&#39;
</span></span><span class="line"><span class="cl">            if cidr_bits &gt;= 8:
</span></span><span class="line"><span class="cl">                netmask += &#39;255&#39;
</span></span><span class="line"><span class="cl">                cidr_bits -= 8
</span></span><span class="line"><span class="cl">            else:
</span></span><span class="line"><span class="cl">                netmask += &#39;{0:d}&#39;.format(256 - (2 ** (8 - cidr_bits)))
</span></span><span class="line"><span class="cl">                cidr_bits = 0
</span></span><span class="line"><span class="cl">        return netmask
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def _number_of_set_bits(self, x):
</span></span><span class="line"><span class="cl">        &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">        Returns the number of bits that are set in a 32bit int
</span></span><span class="line"><span class="cl">        &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">        # Taken from http://stackoverflow.com/a/4912729. Many thanks!
</span></span><span class="line"><span class="cl">        x -= (x &gt;&gt; 1) &amp; 0x55555555
</span></span><span class="line"><span class="cl">        x = ((x &gt;&gt; 2) &amp; 0x33333333) + (x &amp; 0x33333333)
</span></span><span class="line"><span class="cl">        x = ((x &gt;&gt; 4) + x) &amp; 0x0f0f0f0f
</span></span><span class="line"><span class="cl">        x += x &gt;&gt; 8
</span></span><span class="line"><span class="cl">        x += x &gt;&gt; 16
</span></span><span class="line"><span class="cl">        return x &amp; 0x0000003f
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def _interfaces_ip(self, out):
</span></span><span class="line"><span class="cl">        &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">        Uses ip to return a dictionary of interfaces with various information about
</span></span><span class="line"><span class="cl">        each (up/down state, ip address, netmask, and hwaddr)
</span></span><span class="line"><span class="cl">        &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">        ret = dict()
</span></span><span class="line"><span class="cl">        right_keys = [&#39;name&#39;, &#39;hwaddr&#39;, &#39;up&#39;, &#39;netmask&#39;, &#39;ipaddrs&#39;]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        def parse_network(value, cols):
</span></span><span class="line"><span class="cl">            &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">            Return a tuple of ip, netmask, broadcast
</span></span><span class="line"><span class="cl">            based on the current set of cols
</span></span><span class="line"><span class="cl">            &#39;&#39;&#39;
</span></span><span class="line"><span class="cl">            brd = None
</span></span><span class="line"><span class="cl">            if &#39;/&#39; in value:  # we have a CIDR in this address
</span></span><span class="line"><span class="cl">                ip, cidr = value.split(&#39;/&#39;)  # pylint: disable=C0103
</span></span><span class="line"><span class="cl">            else:
</span></span><span class="line"><span class="cl">                ip = value  # pylint: disable=C0103
</span></span><span class="line"><span class="cl">                cidr = 32
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            if type_ == &#39;inet&#39;:
</span></span><span class="line"><span class="cl">                mask = self.cidr_to_ipv4_netmask(int(cidr))
</span></span><span class="line"><span class="cl">                if &#39;brd&#39; in cols:
</span></span><span class="line"><span class="cl">                    brd = cols[cols.index(&#39;brd&#39;) + 1]
</span></span><span class="line"><span class="cl">            return (ip, mask, brd)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        groups = re.compile(&#39;\r?\n\\d&#39;).split(out)
</span></span><span class="line"><span class="cl">        for group in groups:
</span></span><span class="line"><span class="cl">            iface = None
</span></span><span class="line"><span class="cl">            data = dict()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            for line in group.splitlines():
</span></span><span class="line"><span class="cl">                if &#39; &#39; not in line:
</span></span><span class="line"><span class="cl">                    continue
</span></span><span class="line"><span class="cl">                match = re.match(r&#39;^\d*:\s+([\w.\-]+)(?:@)?([\w.\-]+)?:\s+&lt;(.+)&gt;&#39;, line)
</span></span><span class="line"><span class="cl">                if match:
</span></span><span class="line"><span class="cl">                    iface, parent, attrs = match.groups()
</span></span><span class="line"><span class="cl">                    if &#39;UP&#39; in attrs.split(&#39;,&#39;):
</span></span><span class="line"><span class="cl">                        data[&#39;up&#39;] = True
</span></span><span class="line"><span class="cl">                    else:
</span></span><span class="line"><span class="cl">                        data[&#39;up&#39;] = False
</span></span><span class="line"><span class="cl">                    if parent and parent in right_keys:
</span></span><span class="line"><span class="cl">                        data[parent] = parent
</span></span><span class="line"><span class="cl">                    continue
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                cols = line.split()
</span></span><span class="line"><span class="cl">                if len(cols) &gt;= 2:
</span></span><span class="line"><span class="cl">                    type_, value = tuple(cols[0:2])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    iflabel = cols[-1:][0]
</span></span><span class="line"><span class="cl">                    if type_ in (&#39;inet&#39;,):
</span></span><span class="line"><span class="cl">                        if &#39;secondary&#39; not in cols:
</span></span><span class="line"><span class="cl">                            ipaddr, netmask, broadcast = parse_network(value, cols)
</span></span><span class="line"><span class="cl">                            if type_ == &#39;inet&#39;:
</span></span><span class="line"><span class="cl">                                if &#39;inet&#39; not in data:
</span></span><span class="line"><span class="cl">                                    data[&#39;inet&#39;] = list()
</span></span><span class="line"><span class="cl">                                addr_obj = dict()
</span></span><span class="line"><span class="cl">                                addr_obj[&#39;address&#39;] = ipaddr
</span></span><span class="line"><span class="cl">                                addr_obj[&#39;netmask&#39;] = netmask
</span></span><span class="line"><span class="cl">                                addr_obj[&#39;broadcast&#39;] = broadcast
</span></span><span class="line"><span class="cl">                                data[&#39;inet&#39;].append(addr_obj)
</span></span><span class="line"><span class="cl">                        else:
</span></span><span class="line"><span class="cl">                            if &#39;secondary&#39; not in data:
</span></span><span class="line"><span class="cl">                                data[&#39;secondary&#39;] = list()
</span></span><span class="line"><span class="cl">                            ip_, mask, brd = parse_network(value, cols)
</span></span><span class="line"><span class="cl">                            data[&#39;secondary&#39;].append({
</span></span><span class="line"><span class="cl">                                &#39;type&#39;: type_,
</span></span><span class="line"><span class="cl">                                &#39;address&#39;: ip_,
</span></span><span class="line"><span class="cl">                                &#39;netmask&#39;: mask,
</span></span><span class="line"><span class="cl">                                &#39;broadcast&#39;: brd,
</span></span><span class="line"><span class="cl">                            })
</span></span><span class="line"><span class="cl">                            del ip_, mask, brd
</span></span><span class="line"><span class="cl">                    elif type_.startswith(&#39;link&#39;):
</span></span><span class="line"><span class="cl">                        data[&#39;hwaddr&#39;] = value
</span></span><span class="line"><span class="cl">            if iface:
</span></span><span class="line"><span class="cl">                if iface.startswith(&#39;pan&#39;) or iface.startswith(&#39;lo&#39;) or iface.startswith(&#39;v&#39;):
</span></span><span class="line"><span class="cl">                    del iface, data
</span></span><span class="line"><span class="cl">                else:
</span></span><span class="line"><span class="cl">                    ret[iface] = data
</span></span><span class="line"><span class="cl">                    del iface, data
</span></span><span class="line"><span class="cl">        return ret
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def standard(self, interfaces_info):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        for key, value in interfaces_info.items():
</span></span><span class="line"><span class="cl">            ipaddrs = set()
</span></span><span class="line"><span class="cl">            netmask = set()
</span></span><span class="line"><span class="cl">            if not &#39;inet&#39; in value:
</span></span><span class="line"><span class="cl">                value[&#39;ipaddrs&#39;] = &#39;&#39;
</span></span><span class="line"><span class="cl">                value[&#39;netmask&#39;] = &#39;&#39;
</span></span><span class="line"><span class="cl">            else:
</span></span><span class="line"><span class="cl">                for item in value[&#39;inet&#39;]:
</span></span><span class="line"><span class="cl">                    ipaddrs.add(item[&#39;address&#39;])
</span></span><span class="line"><span class="cl">                    netmask.add(item[&#39;netmask&#39;])
</span></span><span class="line"><span class="cl">                value[&#39;ipaddrs&#39;] = &#39;/&#39;.join(ipaddrs)
</span></span><span class="line"><span class="cl">                value[&#39;netmask&#39;] = &#39;/&#39;.join(netmask)
</span></span><span class="line"><span class="cl">                del value[&#39;inet&#39;]
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="utlis">utlis</h5>
<h6 id="convertpy">convert.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 内存插件中的一个转换单位函数
</span></span><span class="line"><span class="cl">def convert_to_int(value, default=0):
</span></span><span class="line"><span class="cl">    try:
</span></span><span class="line"><span class="cl">        result = int(value)
</span></span><span class="line"><span class="cl">    except Exception as e:
</span></span><span class="line"><span class="cl">        result = default
</span></span><span class="line"><span class="cl">    return result
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def convert_mb_to_gb(value, default):
</span></span><span class="line"><span class="cl">    try:
</span></span><span class="line"><span class="cl">        value = value.strip(&#39;MB&#39;)
</span></span><span class="line"><span class="cl">        result = int(value)
</span></span><span class="line"><span class="cl">    except Exception as e:
</span></span><span class="line"><span class="cl">        result = default
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return result
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="logpy">log.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import logging
</span></span><span class="line"><span class="cl">import settings
</span></span><span class="line"><span class="cl">class logger(object):
</span></span><span class="line"><span class="cl">    def __init__(self,file_path,level):
</span></span><span class="line"><span class="cl">        file_handler = logging.FileHandler(file_path, &#39;a&#39;, encoding=&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">        fmt = logging.Formatter(fmt=&#34;%(asctime)s - %(name)s - %(levelname)s -%(module)s:  %(message)s&#34;)
</span></span><span class="line"><span class="cl">        file_handler.setFormatter(fmt)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        self.logger = logging.Logger(&#39;cmdb&#39;, level=level)
</span></span><span class="line"><span class="cl">        self.logger.addHandler(file_handler)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def error(self,msg):
</span></span><span class="line"><span class="cl">        self.logger.error(msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">logger = logger(settings.LOGGING_PATH, logging.DEBUG)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># info_logger = Logger(&#39;x1.txt&#39;,logging.DEBUG)
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="responsepy">response.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class BaseResponse(object):
</span></span><span class="line"><span class="cl">    def __init__(self, status=True, data=None, error=None):
</span></span><span class="line"><span class="cl">        self.status = status
</span></span><span class="line"><span class="cl">        self.data = data
</span></span><span class="line"><span class="cl">        self.error = error
</span></span><span class="line"><span class="cl">    @property
</span></span><span class="line"><span class="cl">    def dict(self):
</span></span><span class="line"><span class="cl">        return self.__dict__
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="log">log</h4>
<h5 id="cmdblog">cmdb.log</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">项目日志
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="apppy">app.py</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import requests
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import settings
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def ssh(hostname, cmd):
</span></span><span class="line"><span class="cl">    import paramiko
</span></span><span class="line"><span class="cl">    import settings
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 创建ssh对象
</span></span><span class="line"><span class="cl">    ssh = paramiko.SSHClient()
</span></span><span class="line"><span class="cl">    # 允许连接不在know_hosts文件中的主机
</span></span><span class="line"><span class="cl">    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
</span></span><span class="line"><span class="cl">    # 连接服务器
</span></span><span class="line"><span class="cl">    ssh.connect(hostname=hostname, port=settings.SSH_PORT, username=settings.SSH_USER, password=settings.SSH_PWD)
</span></span><span class="line"><span class="cl">    # 执行命令
</span></span><span class="line"><span class="cl">    stdin, stdout, stderr = ssh.exec_command(cmd)
</span></span><span class="line"><span class="cl">    # 获取命令结果
</span></span><span class="line"><span class="cl">    result = stdout.read()
</span></span><span class="line"><span class="cl">    # 关闭连接
</span></span><span class="line"><span class="cl">    ssh.close()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # print(result.decode())
</span></span><span class="line"><span class="cl">    return result.decode(&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def task(host):
</span></span><span class="line"><span class="cl">    from lib.plugins import get_server_info
</span></span><span class="line"><span class="cl">    server_info = get_server_info(ssh, host)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # result = requests.post(
</span></span><span class="line"><span class="cl">    #     url=&#34;http://127.0.0.1:8000/api/get_data/&#34;,
</span></span><span class="line"><span class="cl">    #     data={&#39;host&#39;: host, &#39;info&#39;: server_info}
</span></span><span class="line"><span class="cl">    # )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    result = requests.post(
</span></span><span class="line"><span class="cl">        url=settings.API_URL,
</span></span><span class="line"><span class="cl">        json={&#39;host&#39;: host, &#39;info&#39;: server_info}
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    print(result)
</span></span><span class="line"><span class="cl">    print(server_info)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def get_server_list():
</span></span><span class="line"><span class="cl">    response = requests.get(settings.API_URL)
</span></span><span class="line"><span class="cl">    return response.json()[&#39;data&#39;]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def run():
</span></span><span class="line"><span class="cl">    host_list = get_server_list()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    from concurrent.futures import ThreadPoolExecutor
</span></span><span class="line"><span class="cl">    pool = ThreadPoolExecutor(10)  # 创建十个进程
</span></span><span class="line"><span class="cl">    # 调用方法获得服务器信息
</span></span><span class="line"><span class="cl">    for host in host_list:
</span></span><span class="line"><span class="cl">        pool.submit(task, host)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">if __name__ == &#39;__main__&#39;:
</span></span><span class="line"><span class="cl">    run()
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="settingspy">settings.py</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import os
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">BASER_DIR = os.path.dirname(os.path.abspath(__file__))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PLUGIN_CLASS_DICT = {
</span></span><span class="line"><span class="cl">    &#39;disk&#39;:&#39;lib.plugins.disk.DiskPlugin&#39;,
</span></span><span class="line"><span class="cl">    &#39;memory&#39;:&#39;lib.plugins.memory.MemoryPlugin&#39;,
</span></span><span class="line"><span class="cl">    &#39;network&#39;:&#39;lib.plugins.network.NetworkPlugin&#39;,
</span></span><span class="line"><span class="cl">    &#39;basic&#39;:&#39;lib.plugins.basic.BasicPlugin&#39;,
</span></span><span class="line"><span class="cl">    &#39;board&#39;:&#39;lib.plugins.board.BoardPlugin&#39;,
</span></span><span class="line"><span class="cl">    &#39;cpu&#39;:&#39;lib.plugins.cpu.CpuPlugin&#39;,
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">SSH_USER = &#39;root&#39;
</span></span><span class="line"><span class="cl">SSH_PORT = 22
</span></span><span class="line"><span class="cl">SSH_PWD = &#39;xxxx&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">LOGGING_PATH = os.path.join(BASER_DIR,&#39;log/cmdb.log&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">LOCAL_DISK_FILE_PATH = os.path.join(BASER_DIR, &#39;files/disk.out&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">BASEDIR = os.path.join(BASER_DIR, &#39;files/cpuinfo.out&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">API_URL = &#34;http://127.0.0.1:8000/api/server/&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="requirementstxt">requirements.txt</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">asgiref==3.5.0
</span></span><span class="line"><span class="cl">bcrypt==3.2.0
</span></span><span class="line"><span class="cl">certifi==2021.10.8
</span></span><span class="line"><span class="cl">cffi==1.15.0
</span></span><span class="line"><span class="cl">charset-normalizer==2.0.12
</span></span><span class="line"><span class="cl">cryptography==36.0.2
</span></span><span class="line"><span class="cl">demjson3==3.0.5
</span></span><span class="line"><span class="cl">Django==2.2.2
</span></span><span class="line"><span class="cl">djangorestframework==3.13.1
</span></span><span class="line"><span class="cl">djangorestframework-jwt==1.1.1
</span></span><span class="line"><span class="cl">idna==3.3
</span></span><span class="line"><span class="cl">paramiko==2.10.3
</span></span><span class="line"><span class="cl">pycparser==2.21
</span></span><span class="line"><span class="cl">PyJWT==0.3.2
</span></span><span class="line"><span class="cl">PyMySQL==1.0.2
</span></span><span class="line"><span class="cl">PyNaCl==1.5.0
</span></span><span class="line"><span class="cl">pytz==2022.1
</span></span><span class="line"><span class="cl">requests==2.27.1
</span></span><span class="line"><span class="cl">six==1.16.0
</span></span><span class="line"><span class="cl">sqlparse==0.4.2
</span></span><span class="line"><span class="cl">tzdata==2022.1
</span></span><span class="line"><span class="cl">urllib3==1.26.9
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="152-api接口部分">15.2 api接口部分</h3>
<h4 id="api">api</h4>
<h5 id="service">service</h5>
<h6 id="diskpy-1">disk.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from api import models
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def process_disk_info(host_object, disk_dict):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;处理汇报来的硬盘信息&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    if not disk_dict[&#39;status&#39;]:
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;硬盘的资产信息没有获取到&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        print(&#39;获取硬盘资产时错误：&#39;, disk_dict[&#39;error&#39;])
</span></span><span class="line"><span class="cl">        return
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 新汇报的数据
</span></span><span class="line"><span class="cl">    new_disk_dict = disk_dict[&#39;data&#39;]
</span></span><span class="line"><span class="cl">    new_disk_slot_set = set(new_disk_dict)  # 得到集合
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    db_disk_queryset = models.Disk.objects.filter(server=host_object).all()
</span></span><span class="line"><span class="cl">    db_disk_dict = {row.slot: row for row in db_disk_queryset}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    db_disk_slot_set = set(db_disk_dict)  # 得到集合
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    create_slot_set = new_disk_slot_set - db_disk_slot_set
</span></span><span class="line"><span class="cl">    remove_slot_set = db_disk_slot_set - new_disk_slot_set
</span></span><span class="line"><span class="cl">    update_slot_set = new_disk_slot_set &amp; db_disk_slot_set
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # print(&#39;新增&#39;,create_slot_set)
</span></span><span class="line"><span class="cl">    # print(&#39;删除&#39;,remove_slot_set)
</span></span><span class="line"><span class="cl">    # print(&#39;更新&#39;,update_slot_set)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    record_str_list = []
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 添加
</span></span><span class="line"><span class="cl">    for slot in create_slot_set:
</span></span><span class="line"><span class="cl">        models.Disk.objects.create(**new_disk_dict[slot], server=host_object)
</span></span><span class="line"><span class="cl">        msg = r&#34;【新增硬盘】槽位:{slot},类型:{pd_type},容量:{capacity}&#34;.format(**new_disk_dict[slot])
</span></span><span class="line"><span class="cl">        record_str_list.append(msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 删除
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    models.Disk.objects.filter(server=host_object, slot__in=remove_slot_set).delete()
</span></span><span class="line"><span class="cl">    if remove_slot_set:
</span></span><span class="line"><span class="cl">        msg = &#34;【删除硬盘】槽位:{}&#34;.format(&#39;,&#39;.join(remove_slot_set))
</span></span><span class="line"><span class="cl">        record_str_list.append(msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 更新
</span></span><span class="line"><span class="cl">    for slot in update_slot_set:
</span></span><span class="line"><span class="cl">        # print(new_disk_dict[slot])  # {&#39;slot&#39;: &#39;1&#39;, &#39;pd_type&#39;: &#39;SAS&#39;, &#39;capacity&#39;: &#39;279.396&#39;, &#39;model&#39;: &#39;TOSHIBA AL1&#39;}
</span></span><span class="line"><span class="cl">        # print(db_disk_dict[slot])   # 对象，需要点取值，也可以用过getattr(对象,&#39;x&#39;)取值
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        temp = []
</span></span><span class="line"><span class="cl">        for key, value in new_disk_dict[slot].items():
</span></span><span class="line"><span class="cl">            # print(key, value,getattr(db_disk_dict[slot],key))
</span></span><span class="line"><span class="cl">            old_value = getattr(db_disk_dict[slot], key)
</span></span><span class="line"><span class="cl">            if value == old_value:
</span></span><span class="line"><span class="cl">                continue
</span></span><span class="line"><span class="cl">            msg = &#34;硬盘的{},由{}变更成了{}&#34;.format(key, old_value, value)
</span></span><span class="line"><span class="cl">            temp.append(msg)
</span></span><span class="line"><span class="cl">            setattr(db_disk_dict[slot], key, value)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 如果有变化
</span></span><span class="line"><span class="cl">        if temp:
</span></span><span class="line"><span class="cl">            db_disk_dict[slot].save()
</span></span><span class="line"><span class="cl">            row = &#34;【更新硬盘】槽位:{}，更新的内容:{}&#34;.format(slot, &#39;;&#39;.join(temp))
</span></span><span class="line"><span class="cl">            record_str_list.append(row)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    print(record_str_list)
</span></span><span class="line"><span class="cl">    if record_str_list:
</span></span><span class="line"><span class="cl">        models.AssetsRecord.objects.create(content=&#34;\n&#34;.join(record_str_list), server=host_object)
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="memorypy-1">memory.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from api import models
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def process_memory_info(host_object,memory_dict):
</span></span><span class="line"><span class="cl">    if not memory_dict[&#39;status&#39;]:
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;服务器基本信息没有获取到&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        print(&#39;获取硬盘资产时错误：&#39;, memory_dict[&#39;error&#39;])
</span></span><span class="line"><span class="cl">        return
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 新汇报的数据
</span></span><span class="line"><span class="cl">    new_memory_dict = memory_dict[&#39;data&#39;]
</span></span><span class="line"><span class="cl">    new_memory_slot_set = set(new_memory_dict)  # 得到集合
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 数据库里的老数据
</span></span><span class="line"><span class="cl">    db_memory_queryset = models.Memory.objects.all()
</span></span><span class="line"><span class="cl">    db_memory_dict = {row.slot: row for row in db_memory_queryset}
</span></span><span class="line"><span class="cl">    db_memory_slot_set = set(db_memory_dict)  # 得到集合
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    create_slot_set = new_memory_slot_set - db_memory_slot_set
</span></span><span class="line"><span class="cl">    remove_slot_set = db_memory_slot_set - new_memory_slot_set
</span></span><span class="line"><span class="cl">    update_slot_set = new_memory_slot_set &amp; db_memory_slot_set
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # print(&#39;新增&#39;,create_slot_set)
</span></span><span class="line"><span class="cl">    # print(&#39;删除&#39;,remove_slot_set)
</span></span><span class="line"><span class="cl">    # print(&#39;更新&#39;,update_slot_set)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    record_str_list = []
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 添加
</span></span><span class="line"><span class="cl">    for slot in create_slot_set:
</span></span><span class="line"><span class="cl">        models.Memory.objects.create(**new_memory_dict[slot], server_obj=host_object)
</span></span><span class="line"><span class="cl">        # print(format(**new_memory_dict[slot]))
</span></span><span class="line"><span class="cl">        msg = r&#34;【新增内存】槽位:{slot},manufacture:{manufacturer},model:{model},capacity:{capacity},sn:{sn},speed:{speed}&#34;.format(**new_memory_dict[slot])
</span></span><span class="line"><span class="cl">        record_str_list.append(msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 删除
</span></span><span class="line"><span class="cl">    models.Memory.objects.filter(server_obj=host_object, slot__in=remove_slot_set).delete()
</span></span><span class="line"><span class="cl">    if remove_slot_set:
</span></span><span class="line"><span class="cl">        msg = &#34;【删除内存】槽位:{}&#34;.format(&#39;,&#39;.join(remove_slot_set))
</span></span><span class="line"><span class="cl">        record_str_list.append(msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 更新
</span></span><span class="line"><span class="cl">    for slot in update_slot_set:
</span></span><span class="line"><span class="cl">        # print(new_disk_dict[slot])  # {&#39;slot&#39;: &#39;1&#39;, &#39;pd_type&#39;: &#39;SAS&#39;, &#39;capacity&#39;: &#39;279.396&#39;, &#39;model&#39;: &#39;TOSHIBA AL1&#39;}
</span></span><span class="line"><span class="cl">        # print(db_disk_dict[slot])   # 对象，需要点取值，也可以用过getattr(对象,&#39;x&#39;)取值
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        temp = []
</span></span><span class="line"><span class="cl">        for key, value in new_memory_dict[slot].items():
</span></span><span class="line"><span class="cl">            # print(key, value,getattr(db_disk_dict[slot],key))
</span></span><span class="line"><span class="cl">            old_value = getattr(db_memory_dict[slot], key)
</span></span><span class="line"><span class="cl">            if value == old_value:
</span></span><span class="line"><span class="cl">                continue
</span></span><span class="line"><span class="cl">            msg = &#34;内存的{},由{}变更成了{}&#34;.format(key, old_value, value)
</span></span><span class="line"><span class="cl">            temp.append(msg)
</span></span><span class="line"><span class="cl">            setattr(db_memory_dict[slot], key, value)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 如果有变化
</span></span><span class="line"><span class="cl">        if temp:
</span></span><span class="line"><span class="cl">            db_memory_dict[slot].save()
</span></span><span class="line"><span class="cl">            row = &#34;【更新内存】槽位:{}，更新的内容:{}&#34;.format(slot, &#39;;&#39;.join(temp))
</span></span><span class="line"><span class="cl">            record_str_list.append(row)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if record_str_list:
</span></span><span class="line"><span class="cl">        models.AssetsRecord.objects.create(content=&#34;\n&#34;.join(record_str_list), server=host_object)
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="networkpy-1">network.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from api import models
</span></span><span class="line"><span class="cl">import demjson3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def process_network_info(host_object,network_dict):
</span></span><span class="line"><span class="cl">    # print(network_dict)
</span></span><span class="line"><span class="cl">    if not network_dict[&#39;status&#39;]:
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;服务器网络信息没有获取到&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        print(&#39;获取网络信息时错误：&#39;, network_dict[&#39;error&#39;])
</span></span><span class="line"><span class="cl">        return
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 新汇报的数据
</span></span><span class="line"><span class="cl">    new_network_dict = network_dict[&#39;data&#39;]
</span></span><span class="line"><span class="cl">    new_network_slot_set = set(new_network_dict)  # 得到集合
</span></span><span class="line"><span class="cl">    print(new_network_dict)
</span></span><span class="line"><span class="cl">    db_network_queryset = models.Nic.objects.filter(server=host_object).all()
</span></span><span class="line"><span class="cl">    db_network_dict = {row.name: row for row in db_network_queryset}
</span></span><span class="line"><span class="cl">    db_network_slot_set = set(db_network_dict)  # 得到集合
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    create_slot_set = new_network_slot_set - db_network_slot_set
</span></span><span class="line"><span class="cl">    remove_slot_set = db_network_slot_set - new_network_slot_set
</span></span><span class="line"><span class="cl">    update_slot_set = new_network_slot_set &amp; db_network_slot_set
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # print(&#39;新增&#39;,create_slot_set)
</span></span><span class="line"><span class="cl">    # print(&#39;删除网卡&#39;,remove_slot_set)
</span></span><span class="line"><span class="cl">    # print(&#39;更新&#39;,update_slot_set)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    record_str_list = []
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 添加
</span></span><span class="line"><span class="cl">    for name in create_slot_set:
</span></span><span class="line"><span class="cl">        models.Nic.objects.create(**new_network_dict[name],name=name, server=host_object)
</span></span><span class="line"><span class="cl">        msg = r&#34;【新增网卡】名称:{name},hwaddr:{hwaddr},网卡地址:{inet},up:{up}&#34;.format(name=name,**new_network_dict[name])
</span></span><span class="line"><span class="cl">        record_str_list.append(msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 删除
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    models.Nic.objects.filter(server=host_object, name__in=remove_slot_set).delete()
</span></span><span class="line"><span class="cl">    if remove_slot_set:
</span></span><span class="line"><span class="cl">        msg = &#34;【删除网卡】名称:{}&#34;.format(&#39;,&#39;.join(remove_slot_set))
</span></span><span class="line"><span class="cl">        record_str_list.append(msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 更新
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    for name in update_slot_set:
</span></span><span class="line"><span class="cl">        # print(new_disk_dict[slot])  # {&#39;slot&#39;: &#39;1&#39;, &#39;pd_type&#39;: &#39;SAS&#39;, &#39;capacity&#39;: &#39;279.396&#39;, &#39;model&#39;: &#39;TOSHIBA AL1&#39;}
</span></span><span class="line"><span class="cl">        # print(db_disk_dict[slot])   # 对象，需要点取值，也可以用过getattr(对象,&#39;x&#39;)取值
</span></span><span class="line"><span class="cl">        temp = []
</span></span><span class="line"><span class="cl">        for key, value in new_network_dict[name].items():
</span></span><span class="line"><span class="cl">            # print(key, value,getattr(db_disk_dict[slot],key))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            old_value = getattr(db_network_dict[name], key)
</span></span><span class="line"><span class="cl">            if key == &#39;inet&#39;:
</span></span><span class="line"><span class="cl">                old_value = demjson3.decode(old_value)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            if value == old_value:
</span></span><span class="line"><span class="cl">                continue
</span></span><span class="line"><span class="cl">            msg = &#34;网卡{},由{}变更成了{}&#34;.format(key, old_value, value)
</span></span><span class="line"><span class="cl">            temp.append(msg)
</span></span><span class="line"><span class="cl">            setattr(db_network_dict[name], key, value)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 如果有变化
</span></span><span class="line"><span class="cl">        if temp:
</span></span><span class="line"><span class="cl">            db_network_dict[name].save()
</span></span><span class="line"><span class="cl">            row = &#34;【更新网卡】:{}，更新的内容:{}&#34;.format(name, &#39;;&#39;.join(temp))
</span></span><span class="line"><span class="cl">            record_str_list.append(row)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if record_str_list:
</span></span><span class="line"><span class="cl">        models.AssetsRecord.objects.create(content=&#34;\n&#34;.join(record_str_list), server=host_object)
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="modelspy">models.py</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from django.db import models
</span></span><span class="line"><span class="cl">from django.contrib.auth.models import AbstractUser
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Create your models here.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class User(AbstractUser):
</span></span><span class="line"><span class="cl">    telephone = models.CharField(max_length=11)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class BusinessUnit(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    业务线(部门)
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    name = models.CharField(&#39;业务线&#39;, max_length=64, unique=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class IDC(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    机房信息: 世纪互联、兆维
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    name = models.CharField(&#39;机房&#39;, max_length=32)
</span></span><span class="line"><span class="cl">    floor = models.IntegerField(&#39;楼层&#39;, default=1)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Server(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;服务器表&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    status_choice = (
</span></span><span class="line"><span class="cl">        (1,&#39;上线&#39;),
</span></span><span class="line"><span class="cl">        (2,&#39;下线&#39;)
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    status = models.IntegerField(verbose_name=&#39;状态&#39;,choices=status_choice,blank=True,
</span></span><span class="line"><span class="cl">                                      null=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    business_unit = models.ForeignKey(verbose_name=&#39;业务线&#39;, to=&#39;BusinessUnit&#39;, on_delete=models.CASCADE, blank=True,
</span></span><span class="line"><span class="cl">                                      null=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # IDC有关
</span></span><span class="line"><span class="cl">    idc = models.ForeignKey(verbose_name=&#39;机房&#39;, to=&#39;IDC&#39;, on_delete=models.CASCADE, blank=True, null=True)
</span></span><span class="line"><span class="cl">    cabinet_num = models.CharField(&#39;机柜号&#39;, max_length=30, null=True, blank=True)
</span></span><span class="line"><span class="cl">    cabinet_order = models.CharField(&#39;机柜中序号&#39;, max_length=30, null=True, blank=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    hostname = models.CharField(verbose_name=&#39;主机名&#39;, max_length=32)
</span></span><span class="line"><span class="cl">    last_date = models.DateField(verbose_name=&#39;最近汇报的时间&#39;, null=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 系统信息
</span></span><span class="line"><span class="cl">    os_platform = models.CharField(&#39;系统&#39;, max_length=16, null=True, blank=True)
</span></span><span class="line"><span class="cl">    os_version = models.CharField(&#39;系统版本&#39;, max_length=16, null=True, blank=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 主板信息
</span></span><span class="line"><span class="cl">    sn = models.CharField(&#39;SN号&#39;, max_length=64, db_index=True, blank=True, null=True)
</span></span><span class="line"><span class="cl">    manufacturer = models.CharField(verbose_name=&#39;制造商&#39;, max_length=64, null=True, blank=True)
</span></span><span class="line"><span class="cl">    model = models.CharField(&#39;型号&#39;, max_length=64, null=True, blank=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # CPU信息
</span></span><span class="line"><span class="cl">    cpu_count = models.IntegerField(&#39;CPU个数&#39;, null=True, blank=True)
</span></span><span class="line"><span class="cl">    cpu_physical_count = models.IntegerField(&#39;CPU物理个数&#39;, null=True, blank=True)
</span></span><span class="line"><span class="cl">    cpu_model = models.CharField(&#39;CPU型号&#39;, max_length=128, null=True, blank=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Disk(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;硬盘表&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    slot = models.CharField(verbose_name=&#39;槽位&#39;, max_length=32)
</span></span><span class="line"><span class="cl">    pd_type = models.CharField(verbose_name=&#39;类型&#39;, max_length=32)
</span></span><span class="line"><span class="cl">    capacity = models.CharField(verbose_name=&#39;容量&#39;, max_length=32)
</span></span><span class="line"><span class="cl">    model = models.CharField(verbose_name=&#39;型号&#39;, max_length=32)
</span></span><span class="line"><span class="cl">    server = models.ForeignKey(verbose_name=&#39;服务器&#39;, to=&#39;Server&#39;, on_delete=models.CASCADE)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class AssetsRecord(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;资产变更记录&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    content = models.TextField(verbose_name=&#39;内容&#39;)
</span></span><span class="line"><span class="cl">    server = models.ForeignKey(verbose_name=&#39;服务器&#39;, to=&#39;Server&#39;, on_delete=models.CASCADE)
</span></span><span class="line"><span class="cl">    create_date = models.DateTimeField(verbose_name=&#39;时间&#39;, auto_now_add=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Nic(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    网卡信息
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    name = models.CharField(&#39;网卡名称&#39;, max_length=128)
</span></span><span class="line"><span class="cl">    hwaddr = models.CharField(&#39;网卡mac地址&#39;, max_length=64)
</span></span><span class="line"><span class="cl">    # netmask = models.CharField(max_length=64)
</span></span><span class="line"><span class="cl">    # ipaddrs = models.CharField(&#39;ip地址&#39;, max_length=256)
</span></span><span class="line"><span class="cl">    inet = models.CharField(&#39;网卡地址&#39;,max_length=128,null=True, blank=True)
</span></span><span class="line"><span class="cl">    up = models.BooleanField(default=False)
</span></span><span class="line"><span class="cl">    server = models.ForeignKey(&#39;Server&#39;, on_delete=models.CASCADE)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __str__(self):
</span></span><span class="line"><span class="cl">        return self.name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Memory(models.Model):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    内存信息
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    slot = models.CharField(&#39;插槽位&#39;, max_length=32)
</span></span><span class="line"><span class="cl">    manufacturer = models.CharField(&#39;制造商&#39;, max_length=32, null=True, blank=True)
</span></span><span class="line"><span class="cl">    model = models.CharField(&#39;型号&#39;, max_length=64)
</span></span><span class="line"><span class="cl">    capacity = models.FloatField(&#39;容量&#39;, null=True, blank=True)
</span></span><span class="line"><span class="cl">    sn = models.CharField(&#39;内存SN号&#39;, max_length=64, null=True, blank=True)
</span></span><span class="line"><span class="cl">    speed = models.CharField(&#39;速度&#39;, max_length=16, null=True, blank=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    server_obj = models.ForeignKey(&#39;Server&#39;, related_name=&#39;memory&#39;, on_delete=models.CASCADE)
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="urlspy">urls.py</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from django.contrib import admin
</span></span><span class="line"><span class="cl">from django.urls import path,include,re_path
</span></span><span class="line"><span class="cl">from api import views
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">urlpatterns = [
</span></span><span class="line"><span class="cl">    re_path(r&#39;^server/&#39;, views.ServerView.as_view()),
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">]
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="viewspy">views.py</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import json
</span></span><span class="line"><span class="cl">import datetime
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from django.views import View
</span></span><span class="line"><span class="cl">from django.db.models import Q
</span></span><span class="line"><span class="cl">from django.http import JsonResponse
</span></span><span class="line"><span class="cl">from django.shortcuts import HttpResponse
</span></span><span class="line"><span class="cl">from django.views.decorators.csrf import csrf_exempt
</span></span><span class="line"><span class="cl">from django.utils.decorators import method_decorator
</span></span><span class="line"><span class="cl">from rest_framework.views import APIView
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from api import models
</span></span><span class="line"><span class="cl">from api.service.disk import process_disk_info
</span></span><span class="line"><span class="cl">from api.service.memory import process_memory_info
</span></span><span class="line"><span class="cl">from api.service.network import process_network_info
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># @method_decorator(csrf_exempt, name=&#39;dispatch&#39;)
</span></span><span class="line"><span class="cl"># class ServerView(View):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class ServerView(APIView):
</span></span><span class="line"><span class="cl">    def get(self, reqeust, *args, **kwargs):
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;获取今日未采集的服务器列表&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        today = datetime.date.today()
</span></span><span class="line"><span class="cl">        # 最近汇报时间小于今天 or 最近汇报时间=None(新资产)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 这种方式只能是and不能是or所以需要用Q来做
</span></span><span class="line"><span class="cl">        # models.Server.objects.filter(last_date__lt=today, last_date__isnull=True)
</span></span><span class="line"><span class="cl">        server_queryset = models.Server.objects.filter(Q(last_date__lt=today) | Q(last_date__isnull=True)).filter(status=1).values_list(
</span></span><span class="line"><span class="cl">            &#39;hostname&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 这里的server_queryset是的queryset，不能直接放到JsonResponse，所以需要进一步处理
</span></span><span class="line"><span class="cl">        # server_list = list(server_queryset)     # [(sss),(sss)]
</span></span><span class="line"><span class="cl">        server_list = [item[0] for item in server_queryset]
</span></span><span class="line"><span class="cl">        return JsonResponse({&#39;status&#39;: True, &#39;data&#39;: server_list})
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def post(self, request, *args, **kwargs):
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;获取中控机汇报的资产信息，并进行入库操作并 进行变更记录&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        content = request.body.decode(&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">        server_info_dict = json.loads(content)
</span></span><span class="line"><span class="cl">        hostname = server_info_dict[&#39;host&#39;]
</span></span><span class="line"><span class="cl">        info_dict = server_info_dict[&#39;info&#39;]
</span></span><span class="line"><span class="cl">        host_object = models.Server.objects.filter(hostname=hostname).first()
</span></span><span class="line"><span class="cl">        if not host_object:
</span></span><span class="line"><span class="cl">            print(&#39;服务器不存在&#39;)
</span></span><span class="line"><span class="cl">            return HttpResponse(&#39;服务器不存在&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        process_disk_info(host_object, info_dict[&#39;disk&#39;])
</span></span><span class="line"><span class="cl">        process_memory_info(host_object, info_dict[&#39;memory&#39;])
</span></span><span class="line"><span class="cl">        process_network_info(host_object, info_dict[&#39;network&#39;])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        host_object.last_date = datetime.date.today()
</span></span><span class="line"><span class="cl">        host_object.save()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # 获取数据之后把他们放到数据库
</span></span><span class="line"><span class="cl">        return HttpResponse(&#39;成功&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="cmdb">cmdb</h4>
<h5 id="settingspy-1">settings.py</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">Django settings for cmdb project.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Generated by &#39;django-admin startproject&#39; using Django 4.0.3.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For more information on this file, see
</span></span><span class="line"><span class="cl">https://docs.djangoproject.com/en/4.0/topics/settings/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">For the full list of settings and their values, see
</span></span><span class="line"><span class="cl">https://docs.djangoproject.com/en/4.0/ref/settings/
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from pathlib import Path
</span></span><span class="line"><span class="cl">import os
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Build paths inside the project like this: BASE_DIR / &#39;subdir&#39;.
</span></span><span class="line"><span class="cl">BASE_DIR = Path(__file__).resolve().parent.parent
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">print(BASE_DIR)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Quick-start development settings - unsuitable for production
</span></span><span class="line"><span class="cl"># See https://docs.djangoproject.com/en/4.0/howto/deployment/checklist/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># SECURITY WARNING: keep the secret key used in production secret!
</span></span><span class="line"><span class="cl">SECRET_KEY = &#39;django-insecure--w7+&amp;)s97%y(wj)p1q^1wyim1cy1$@=t=bw4cvmjtx^&amp;v84uz3&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># SECURITY WARNING: don&#39;t run with debug turned on in production!
</span></span><span class="line"><span class="cl">DEBUG = True
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ALLOWED_HOSTS = []
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Application definition
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">INSTALLED_APPS = [
</span></span><span class="line"><span class="cl">    &#39;django.contrib.admin&#39;,
</span></span><span class="line"><span class="cl">    &#39;django.contrib.auth&#39;,
</span></span><span class="line"><span class="cl">    &#39;django.contrib.contenttypes&#39;,
</span></span><span class="line"><span class="cl">    &#39;django.contrib.sessions&#39;,
</span></span><span class="line"><span class="cl">    &#39;django.contrib.messages&#39;,
</span></span><span class="line"><span class="cl">    &#39;django.contrib.staticfiles&#39;,
</span></span><span class="line"><span class="cl">    &#39;api.apps.ApiConfig&#39;,
</span></span><span class="line"><span class="cl">    &#39;web.apps.WebConfig&#39;,
</span></span><span class="line"><span class="cl">    &#39;rest_framework&#39;,
</span></span><span class="line"><span class="cl">    &#39;rest_framework_jwt&#39;,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">MIDDLEWARE = [
</span></span><span class="line"><span class="cl">    &#39;django.middleware.security.SecurityMiddleware&#39;,
</span></span><span class="line"><span class="cl">    &#39;django.contrib.sessions.middleware.SessionMiddleware&#39;,
</span></span><span class="line"><span class="cl">    &#39;django.middleware.common.CommonMiddleware&#39;,
</span></span><span class="line"><span class="cl">    # &#39;django.middleware.csrf.CsrfViewMiddleware&#39;,
</span></span><span class="line"><span class="cl">    &#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;,
</span></span><span class="line"><span class="cl">    &#39;django.contrib.messages.middleware.MessageMiddleware&#39;,
</span></span><span class="line"><span class="cl">    &#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;,
</span></span><span class="line"><span class="cl">]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ROOT_URLCONF = &#39;cmdb.urls&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TEMPLATES = [
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        &#39;BACKEND&#39;: &#39;django.template.backends.django.DjangoTemplates&#39;,
</span></span><span class="line"><span class="cl">        &#39;DIRS&#39;: [BASE_DIR / &#39;templates&#39;]
</span></span><span class="line"><span class="cl">        ,
</span></span><span class="line"><span class="cl">        &#39;APP_DIRS&#39;: True,
</span></span><span class="line"><span class="cl">        &#39;OPTIONS&#39;: {
</span></span><span class="line"><span class="cl">            &#39;context_processors&#39;: [
</span></span><span class="line"><span class="cl">                &#39;django.template.context_processors.debug&#39;,
</span></span><span class="line"><span class="cl">                &#39;django.template.context_processors.request&#39;,
</span></span><span class="line"><span class="cl">                &#39;django.contrib.auth.context_processors.auth&#39;,
</span></span><span class="line"><span class="cl">                &#39;django.contrib.messages.context_processors.messages&#39;,
</span></span><span class="line"><span class="cl">            ],
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">WSGI_APPLICATION = &#39;cmdb.wsgi.application&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Database
</span></span><span class="line"><span class="cl"># https://docs.djangoproject.com/en/4.0/ref/settings/#databases
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># DATABASES = {
</span></span><span class="line"><span class="cl">#     &#39;default&#39;: {
</span></span><span class="line"><span class="cl">#         &#39;ENGINE&#39;: &#39;django.db.backends.sqlite3&#39;,
</span></span><span class="line"><span class="cl">#         &#39;NAME&#39;: BASE_DIR / &#39;db.sqlite3&#39;,
</span></span><span class="line"><span class="cl">#     }
</span></span><span class="line"><span class="cl"># }
</span></span><span class="line"><span class="cl">DATABASES = {
</span></span><span class="line"><span class="cl">    &#39;default&#39;: {
</span></span><span class="line"><span class="cl">        &#39;ENGINE&#39;: &#39;django.db.backends.mysql&#39;,
</span></span><span class="line"><span class="cl">        &#39;NAME&#39;: &#39;cmdb&#39;,
</span></span><span class="line"><span class="cl">        &#39;USER&#39;: &#39;root&#39;,
</span></span><span class="line"><span class="cl">        &#39;PASSWORD&#39;: &#39;x.x.x.x&#39;,
</span></span><span class="line"><span class="cl">        &#39;HOST&#39;: &#39;127.0.0.1&#39;,
</span></span><span class="line"><span class="cl">        &#39;PORT&#39;: 3306,
</span></span><span class="line"><span class="cl">        &#39;CHARSET&#39;: &#39;utf8&#39;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Password validation
</span></span><span class="line"><span class="cl"># https://docs.djangoproject.com/en/4.0/ref/settings/#auth-password-validators
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AUTH_PASSWORD_VALIDATORS = [
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.UserAttributeSimilarityValidator&#39;,
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.MinimumLengthValidator&#39;,
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.CommonPasswordValidator&#39;,
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    {
</span></span><span class="line"><span class="cl">        &#39;NAME&#39;: &#39;django.contrib.auth.password_validation.NumericPasswordValidator&#39;,
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Internationalization
</span></span><span class="line"><span class="cl"># https://docs.djangoproject.com/en/4.0/topics/i18n/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">LANGUAGE_CODE = &#39;en-us&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TIME_ZONE = &#39;UTC&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USE_I18N = True
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USE_TZ = True
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Static files (CSS, JavaScript, Images)
</span></span><span class="line"><span class="cl"># https://docs.djangoproject.com/en/4.0/howto/static-files/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">STATIC_URL = &#39;static/&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Default primary key field type
</span></span><span class="line"><span class="cl"># https://docs.djangoproject.com/en/4.0/ref/settings/#default-auto-field
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DEFAULT_AUTO_FIELD = &#39;django.db.models.BigAutoField&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">LOGGING = {
</span></span><span class="line"><span class="cl">    &#39;version&#39;: 1,
</span></span><span class="line"><span class="cl">    &#39;disable_existing_loggers&#39;: False,
</span></span><span class="line"><span class="cl">    &#39;formatters&#39;: {
</span></span><span class="line"><span class="cl">        &#39;verbose&#39;: {
</span></span><span class="line"><span class="cl">            &#39;format&#39;: &#39;%(levelname)s %(asctime)s %(module)s %(lineno)d %(message)s&#39;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#39;simple&#39;: {
</span></span><span class="line"><span class="cl">            &#39;format&#39;: &#39;%(levelname)s %(module)s %(lineno)d %(message)s&#39;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    &#39;filters&#39;: {
</span></span><span class="line"><span class="cl">        &#39;require_debug_true&#39;: {
</span></span><span class="line"><span class="cl">            &#39;()&#39;: &#39;django.utils.log.RequireDebugTrue&#39;,
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    &#39;handlers&#39;: {
</span></span><span class="line"><span class="cl">        &#39;console&#39;: {
</span></span><span class="line"><span class="cl">            # 实际开发建议使用WARNING
</span></span><span class="line"><span class="cl">            &#39;level&#39;: &#39;DEBUG&#39;,
</span></span><span class="line"><span class="cl">            &#39;filters&#39;: [&#39;require_debug_true&#39;],
</span></span><span class="line"><span class="cl">            &#39;class&#39;: &#39;logging.StreamHandler&#39;,
</span></span><span class="line"><span class="cl">            &#39;formatter&#39;: &#39;simple&#39;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">        &#39;file&#39;: {
</span></span><span class="line"><span class="cl">            # 实际开发建议使用ERROR
</span></span><span class="line"><span class="cl">            &#39;level&#39;: &#39;INFO&#39;,
</span></span><span class="line"><span class="cl">            &#39;class&#39;: &#39;logging.handlers.RotatingFileHandler&#39;,
</span></span><span class="line"><span class="cl">            # 日志位置,日志文件名,日志保存目录必须手动创建，注：这里的文件路径要注意BASE_DIR代表的是小luffyapi
</span></span><span class="line"><span class="cl">            &#39;filename&#39;: os.path.join(os.path.join(BASE_DIR, &#34;logs&#34;, &#34;luffy.log&#34;)),
</span></span><span class="line"><span class="cl">            # 日志文件的最大值,这里我们设置300M
</span></span><span class="line"><span class="cl">            &#39;maxBytes&#39;: 300 * 1024 * 1024,
</span></span><span class="line"><span class="cl">            # 日志文件的数量,设置最大日志数量为10
</span></span><span class="line"><span class="cl">            &#39;backupCount&#39;: 10,
</span></span><span class="line"><span class="cl">            # 日志格式:详细格式
</span></span><span class="line"><span class="cl">            &#39;formatter&#39;: &#39;verbose&#39;,
</span></span><span class="line"><span class="cl">            # 文件内容编码
</span></span><span class="line"><span class="cl">            &#39;encoding&#39;: &#39;utf-8&#39;
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    # 日志对象
</span></span><span class="line"><span class="cl">    &#39;loggers&#39;: {
</span></span><span class="line"><span class="cl">        &#39;django&#39;: {
</span></span><span class="line"><span class="cl">            &#39;handlers&#39;: [&#39;console&#39;, &#39;file&#39;],
</span></span><span class="line"><span class="cl">            &#39;propagate&#39;: True, # 是否让日志信息继续冒泡给其他的日志处理系统
</span></span><span class="line"><span class="cl">        },
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AUTH_USER_MODEL = &#34;api.user&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import datetime
</span></span><span class="line"><span class="cl">JWT_AUTH = {
</span></span><span class="line"><span class="cl">    &#39;JWT_EXPIRATION_DELTA&#39;:datetime.timedelta(days=7)   # 配置过期时间手动配置
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">STATIC_URL = &#39;/static/&#39;
</span></span><span class="line"><span class="cl"># django默认配置了static路径，url文件里urlpatterns没有这个路径
</span></span><span class="line"><span class="cl"># 在浏览器输入路径static，下面配置文件路径之后，会根据路径找到配置的文件夹
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># statics配置的静态文件夹
</span></span><span class="line"><span class="cl">STATICFILES_DIRS=[
</span></span><span class="line"><span class="cl">    os.path.join(BASE_DIR, &#34;../web/static&#34;)
</span></span><span class="line"><span class="cl">]
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="urlspy-1">urls.py</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from django.contrib import admin
</span></span><span class="line"><span class="cl">from django.urls import path,include,re_path
</span></span><span class="line"><span class="cl">from web import views
</span></span><span class="line"><span class="cl">urlpatterns = [
</span></span><span class="line"><span class="cl">    path(&#39;admin/&#39;, admin.site.urls),
</span></span><span class="line"><span class="cl">    re_path(r&#39;^api/&#39;, include(&#39;api.urls&#39;)),
</span></span><span class="line"><span class="cl">    re_path(r&#39;^web/&#39;, include(&#39;web.urls&#39;)),
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">]
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="logs">logs</h4>
<h5 id="luffylog">luffy.log</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">日志信息
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="requirementstxt-1">requirements.txt</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">asgiref==3.5.0
</span></span><span class="line"><span class="cl">bcrypt==3.2.0
</span></span><span class="line"><span class="cl">certifi==2021.10.8
</span></span><span class="line"><span class="cl">cffi==1.15.0
</span></span><span class="line"><span class="cl">charset-normalizer==2.0.12
</span></span><span class="line"><span class="cl">cryptography==36.0.2
</span></span><span class="line"><span class="cl">demjson3==3.0.5
</span></span><span class="line"><span class="cl">Django==2.2.2
</span></span><span class="line"><span class="cl">djangorestframework==3.13.1
</span></span><span class="line"><span class="cl">djangorestframework-jwt==1.1.1
</span></span><span class="line"><span class="cl">idna==3.3
</span></span><span class="line"><span class="cl">paramiko==2.10.3
</span></span><span class="line"><span class="cl">pycparser==2.21
</span></span><span class="line"><span class="cl">PyJWT==0.3.2
</span></span><span class="line"><span class="cl">PyMySQL==1.0.2
</span></span><span class="line"><span class="cl">PyNaCl==1.5.0
</span></span><span class="line"><span class="cl">pytz==2022.1
</span></span><span class="line"><span class="cl">requests==2.27.1
</span></span><span class="line"><span class="cl">six==1.16.0
</span></span><span class="line"><span class="cl">sqlparse==0.4.2
</span></span><span class="line"><span class="cl">tzdata==2022.1
</span></span><span class="line"><span class="cl">urllib3==1.26.9
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="153-资产管理平台部分">15.3 资产管理平台部分</h3>
<h4 id="web">web</h4>
<h5 id="templates">templates</h5>
<h6 id="assetsrecordhtml">AssetsRecord.html</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html lang=&#34;en&#34;&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">    &lt;meta charset=&#34;UTF-8&#34;&gt;
</span></span><span class="line"><span class="cl">    &lt;link rel=&#34;stylesheet&#34; href=&#34;https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css&#34;
</span></span><span class="line"><span class="cl">          integrity=&#34;sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu&#34; crossorigin=&#34;anonymous&#34;&gt;
</span></span><span class="line"><span class="cl">    &lt;title&gt;CMDB资产管理系统&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;div class=&#34;container&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;div class=&#34;row&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;a href=&#34;/web/create/server/&#34; class=&#34;btn btn-primary&#34;&gt;新增服务器&lt;/a&gt;
</span></span><span class="line"><span class="cl">        &lt;a href=&#34;/web/index/&#34; class=&#34;btn btn-primary&#34;&gt;回到主页&lt;/a&gt;
</span></span><span class="line"><span class="cl">    &lt;/div&gt;
</span></span><span class="line"><span class="cl">    &lt;table class=&#34;table table-bordered&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;thead&gt;
</span></span><span class="line"><span class="cl">        &lt;tr&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;变更内容&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;变更时间&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;归属服务器&lt;/th&gt;
</span></span><span class="line"><span class="cl">        &lt;/tr&gt;
</span></span><span class="line"><span class="cl">        &lt;/thead&gt;
</span></span><span class="line"><span class="cl">        &lt;tbody&gt;
</span></span><span class="line"><span class="cl">        {% for row in assetsrecord_list %}
</span></span><span class="line"><span class="cl">            &lt;tr&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.content }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.create_date }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.server.hostname }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">            &lt;/tr&gt;
</span></span><span class="line"><span class="cl">        {% endfor %}
</span></span><span class="line"><span class="cl">        &lt;/tbody&gt;
</span></span><span class="line"><span class="cl">    &lt;/table&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="create_serverhtml">create_server.html</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html lang=&#34;en&#34;&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">    &lt;meta charset=&#34;UTF-8&#34;&gt;
</span></span><span class="line"><span class="cl">    &lt;link href=&#34;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.1/css/bootstrap.min.css&#34; rel=&#34;stylesheet&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;div style=&#34;width: 600px;margin:0 auto;&#34;&gt;
</span></span><span class="line"><span class="cl">    &lt;div class=&#34;row&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;a href=&#34;/web/index/&#34; class=&#34;btn btn-primary&#34;&gt;回到主页&lt;/a&gt;
</span></span><span class="line"><span class="cl">    &lt;/div&gt;
</span></span><span class="line"><span class="cl">    &lt;form method=&#34;post&#34; novalidate&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        {% csrf_token %}
</span></span><span class="line"><span class="cl">        {% for field in form %}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            &lt;div class=&#34;form-group&#34;&gt;
</span></span><span class="line"><span class="cl">                &lt;label&gt;{{ field.label }}&lt;/label&gt;
</span></span><span class="line"><span class="cl">                {{ field }}
</span></span><span class="line"><span class="cl">                &lt;span style=&#34;color: red&#34;&gt;{{ field.errors.0 }}&lt;/span&gt;
</span></span><span class="line"><span class="cl">            &lt;/div&gt;
</span></span><span class="line"><span class="cl">        {% endfor %}
</span></span><span class="line"><span class="cl">        &lt;input type=&#34;submit&#34; value=&#34;提交&#34; class=&#34;btn btn-primary&#34;&gt;
</span></span><span class="line"><span class="cl">    &lt;/form&gt;
</span></span><span class="line"><span class="cl">&lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="indexhtml">index.html</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html lang=&#34;en&#34;&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">    &lt;meta charset=&#34;UTF-8&#34;&gt;
</span></span><span class="line"><span class="cl">    {#    &lt;link href=&#34;https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.1/css/bootstrap.min.css&#34; rel=&#34;stylesheet&#34;&gt;#}
</span></span><span class="line"><span class="cl">    &lt;!-- 最新版本的 Bootstrap 核心 CSS 文件 --&gt;
</span></span><span class="line"><span class="cl">    &lt;link rel=&#34;stylesheet&#34; href=&#34;https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css&#34;
</span></span><span class="line"><span class="cl">          integrity=&#34;sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu&#34; crossorigin=&#34;anonymous&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;nav class=&#34;navbar navbar-default&#34;&gt;
</span></span><span class="line"><span class="cl">    &lt;div class=&#34;container-fluid&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;!-- Brand and toggle get grouped for better mobile display --&gt;
</span></span><span class="line"><span class="cl">        &lt;div class=&#34;navbar-header&#34;&gt;
</span></span><span class="line"><span class="cl">            &lt;button type=&#34;button&#34; class=&#34;navbar-toggle collapsed&#34; data-toggle=&#34;collapse&#34;
</span></span><span class="line"><span class="cl">                    data-target=&#34;#bs-example-navbar-collapse-1&#34; aria-expanded=&#34;false&#34;&gt;
</span></span><span class="line"><span class="cl">                &lt;span class=&#34;sr-only&#34;&gt;Toggle navigation&lt;/span&gt;
</span></span><span class="line"><span class="cl">                &lt;span class=&#34;icon-bar&#34;&gt;&lt;/span&gt;
</span></span><span class="line"><span class="cl">                &lt;span class=&#34;icon-bar&#34;&gt;&lt;/span&gt;
</span></span><span class="line"><span class="cl">                &lt;span class=&#34;icon-bar&#34;&gt;&lt;/span&gt;
</span></span><span class="line"><span class="cl">            &lt;/button&gt;
</span></span><span class="line"><span class="cl">            &lt;a class=&#34;navbar-brand&#34; href=&#34;#&#34;&gt;CMDB资产管理系统&lt;/a&gt;
</span></span><span class="line"><span class="cl">        &lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        &lt;!-- Collect the nav links, forms, and other content for toggling --&gt;
</span></span><span class="line"><span class="cl">        &lt;div class=&#34;collapse navbar-collapse&#34; id=&#34;bs-example-navbar-collapse-1&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        &lt;/div&gt;&lt;!-- /.navbar-collapse --&gt;
</span></span><span class="line"><span class="cl">    &lt;/div&gt;&lt;!-- /.container-fluid --&gt;
</span></span><span class="line"><span class="cl">&lt;/nav&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;div class=&#34;container&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;div class=&#34;row&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;a href=&#34;/web/create/server/&#34; class=&#34;btn btn-primary&#34;&gt;新增服务器&lt;/a&gt;
</span></span><span class="line"><span class="cl">        &lt;a href=&#34;/web/property/&#34; class=&#34;btn btn-primary&#34;&gt;资产变更记录&lt;/a&gt;
</span></span><span class="line"><span class="cl">        &lt;a href=&#34;/web/server_detail/&#34; class=&#34;btn btn-primary&#34;&gt;服务器详情&lt;/a&gt;
</span></span><span class="line"><span class="cl">    &lt;/div&gt;
</span></span><span class="line"><span class="cl">    &lt;table class=&#34;table table-bordered&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;thead&gt;
</span></span><span class="line"><span class="cl">        &lt;tr&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;主机名&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;业务线&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;IDC&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;状态&lt;/th&gt;
</span></span><span class="line"><span class="cl">        &lt;/tr&gt;
</span></span><span class="line"><span class="cl">        &lt;/thead&gt;
</span></span><span class="line"><span class="cl">        &lt;tbody&gt;
</span></span><span class="line"><span class="cl">        {% for row in server_lsit %}
</span></span><span class="line"><span class="cl">            &lt;tr&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.hostname }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.business_unit.name }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.idc.name }}({{ row.idc.floor }}层)&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.get_status_display }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">            &lt;/tr&gt;
</span></span><span class="line"><span class="cl">        {% endfor %}
</span></span><span class="line"><span class="cl">        &lt;/tbody&gt;
</span></span><span class="line"><span class="cl">    &lt;/table&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="loginhtml">login.html</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;html lang=&#34;en&#34;&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;meta charset=&#34;UTF-8&#34;&gt;
</span></span><span class="line"><span class="cl">    &lt;title&gt;CMDB资产管理系统&lt;/title&gt;
</span></span><span class="line"><span class="cl">{#    &lt;script src=&#34;https://cdn.bootcdn.net/ajax/libs/jquery/3.4.0/jquery.min.js&#34;&gt;&lt;/script&gt;#}
</span></span><span class="line"><span class="cl">&lt;link rel=&#34;stylesheet&#34; href=&#34;https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css&#34; integrity=&#34;sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu&#34; crossorigin=&#34;anonymous&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;h1 class=&#34;text-center&#34;&gt;管理员登录&lt;/h1&gt;
</span></span><span class="line"><span class="cl">&lt;div class=&#34;container&#34;&gt;
</span></span><span class="line"><span class="cl">    &lt;div class=&#34;row&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;div class=&#34;col-md-8 col-md-offset-2&#34;&gt;
</span></span><span class="line"><span class="cl">            &lt;form action=&#34;&#34; method=&#34;post&#34;&gt;
</span></span><span class="line"><span class="cl">                &lt;p&gt;username:&lt;input type=&#34;text&#34; name=&#34;username&#34; class=&#34;form-control&#34;&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">                &lt;p&gt;password:&lt;input type=&#34;text&#34; name=&#34;password&#34; class=&#34;form-control&#34;&gt;&lt;/p&gt;
</span></span><span class="line"><span class="cl">                &lt;input type=&#34;submit&#34; class=&#34;btn-block btn btn-danger&#34;&gt;
</span></span><span class="line"><span class="cl">            &lt;/form&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        &lt;/div&gt;
</span></span><span class="line"><span class="cl">    &lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="server_detailhtml">server_detail.html</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl">&lt;html lang=&#34;en&#34;&gt;
</span></span><span class="line"><span class="cl">&lt;head&gt;
</span></span><span class="line"><span class="cl">    &lt;meta charset=&#34;UTF-8&#34;&gt;
</span></span><span class="line"><span class="cl">    &lt;link rel=&#34;stylesheet&#34; href=&#34;https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css&#34;
</span></span><span class="line"><span class="cl">          integrity=&#34;sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu&#34; crossorigin=&#34;anonymous&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;title&gt;服务器详情页&lt;/title&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/head&gt;
</span></span><span class="line"><span class="cl">&lt;body&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;div class=&#34;container&#34;&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &lt;div class=&#34;row&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;a href=&#34;/web/create/server/&#34; class=&#34;btn btn-primary&#34;&gt;新增服务器&lt;/a&gt;
</span></span><span class="line"><span class="cl">        &lt;a href=&#34;/web/property/&#34; class=&#34;btn btn-primary&#34;&gt;资产变更记录&lt;/a&gt;
</span></span><span class="line"><span class="cl">        &lt;a href=&#34;/web/index/&#34; class=&#34;btn btn-primary&#34;&gt;回到主页&lt;/a&gt;
</span></span><span class="line"><span class="cl">    &lt;/div&gt;
</span></span><span class="line"><span class="cl">    &lt;table class=&#34;table table-bordered&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;thead&gt;
</span></span><span class="line"><span class="cl">        &lt;tr&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;主机名&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;网卡名称&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;网卡mac地址&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;网卡地址&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;网卡状态&lt;/th&gt;
</span></span><span class="line"><span class="cl">        &lt;/tr&gt;
</span></span><span class="line"><span class="cl">        &lt;/thead&gt;
</span></span><span class="line"><span class="cl">        &lt;tbody&gt;
</span></span><span class="line"><span class="cl">        {% for row in network_list %}
</span></span><span class="line"><span class="cl">            &lt;tr&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.server.hostname }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.name }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.hwaddr }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.inet }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.up }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">            &lt;/tr&gt;
</span></span><span class="line"><span class="cl">        {% endfor %}
</span></span><span class="line"><span class="cl">        &lt;/tbody&gt;
</span></span><span class="line"><span class="cl">    &lt;/table&gt;
</span></span><span class="line"><span class="cl">    &lt;table class=&#34;table table-bordered&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;thead&gt;
</span></span><span class="line"><span class="cl">        &lt;tr&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;主机名&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;插槽位&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;制造商&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;型号&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;容量&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;内存SN号&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;速度&lt;/th&gt;
</span></span><span class="line"><span class="cl">        &lt;/tr&gt;
</span></span><span class="line"><span class="cl">        &lt;/thead&gt;
</span></span><span class="line"><span class="cl">        &lt;tbody&gt;
</span></span><span class="line"><span class="cl">        {% for row in memory_list %}
</span></span><span class="line"><span class="cl">            &lt;tr&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.server_obj.hostname }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.slot }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.manufacturer }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.model }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.capacity }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.sn }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.speed }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">            &lt;/tr&gt;
</span></span><span class="line"><span class="cl">        {% endfor %}
</span></span><span class="line"><span class="cl">        &lt;/tbody&gt;
</span></span><span class="line"><span class="cl">    &lt;/table&gt;
</span></span><span class="line"><span class="cl">    &lt;table class=&#34;table table-bordered&#34;&gt;
</span></span><span class="line"><span class="cl">        &lt;thead&gt;
</span></span><span class="line"><span class="cl">        &lt;tr&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;主机名&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;槽位&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;类型&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;容量&lt;/th&gt;
</span></span><span class="line"><span class="cl">            &lt;th&gt;型号&lt;/th&gt;
</span></span><span class="line"><span class="cl">        &lt;/tr&gt;
</span></span><span class="line"><span class="cl">        &lt;/thead&gt;
</span></span><span class="line"><span class="cl">        &lt;tbody&gt;
</span></span><span class="line"><span class="cl">        {% for row in disk_list %}
</span></span><span class="line"><span class="cl">            &lt;tr&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.server.hostname }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.slot }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.pd_type }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.capacity }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">                &lt;td&gt;{{ row.model }}&lt;/td&gt;
</span></span><span class="line"><span class="cl">            &lt;/tr&gt;
</span></span><span class="line"><span class="cl">        {% endfor %}
</span></span><span class="line"><span class="cl">        &lt;/tbody&gt;
</span></span><span class="line"><span class="cl">    &lt;/table&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/div&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/body&gt;
</span></span><span class="line"><span class="cl">&lt;/html&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="utils">utils</h5>
<h6 id="exceptionspy">exceptions.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from rest_framework.views import exception_handler
</span></span><span class="line"><span class="cl">from .response import APIResponse
</span></span><span class="line"><span class="cl">from web.utils.logger import log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def common_exception_handler(exc, context):
</span></span><span class="line"><span class="cl">    log.error(&#39;view是：%s ，错误是%s&#39; % (context[&#39;view&#39;].__class__.__name__, str(exc)))
</span></span><span class="line"><span class="cl">    # context[&#39;view&#39;]  是TextView的对象，想拿出这个对象对应的类名
</span></span><span class="line"><span class="cl">    print(context[&#39;view&#39;].__class__.__name__)
</span></span><span class="line"><span class="cl">    ret = exception_handler(exc, context)  # 是Response对象，它内部有个data
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if not ret:  # drf内置处理不了，丢给django 的，我们自己来处理
</span></span><span class="line"><span class="cl">        # 好多逻辑，更具体的捕获异常
</span></span><span class="line"><span class="cl">        if isinstance(exc, KeyError):
</span></span><span class="line"><span class="cl">            return APIResponse(code=0, msg=&#39;key error&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return APIResponse(code=0, msg=&#39;error&#39;, result=str(exc))
</span></span><span class="line"><span class="cl">    else:
</span></span><span class="line"><span class="cl">        return APIResponse(code=0, msg=&#39;error&#39;, result=ret.data)
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="loggerpy">logger.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import logging
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">log = logging.getLogger(&#39;django&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="responsepy-1">response.py</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#封装Response对象
</span></span><span class="line"><span class="cl">#luffyapi\utils\response.py
</span></span><span class="line"><span class="cl">from rest_framework.response import Response
</span></span><span class="line"><span class="cl">class APIResponse(Response):
</span></span><span class="line"><span class="cl">    def __init__(self, code=100, msg=&#39;成功&#39;, data=None, status=None, headers=None, **kwargs):
</span></span><span class="line"><span class="cl">        dic = {&#39;code&#39;: code, &#39;msg&#39;: msg}
</span></span><span class="line"><span class="cl">        if data:
</span></span><span class="line"><span class="cl">            dic = dic[&#39;data&#39;] = data
</span></span><span class="line"><span class="cl">        dic.update(kwargs)
</span></span><span class="line"><span class="cl">        super().__init__(data=dic, status=status, headers=headers)
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="serializerpy">serializer.py</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from api import models
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import re
</span></span><span class="line"><span class="cl">from rest_framework import serializers
</span></span><span class="line"><span class="cl">from rest_framework.exceptions import ValidationError
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class ServerSerializer(serializers.ModelSerializer):
</span></span><span class="line"><span class="cl">    class Meta:
</span></span><span class="line"><span class="cl">        model = models.Server
</span></span><span class="line"><span class="cl">        fields = &#39;__all__&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 多方式登录序列化类
</span></span><span class="line"><span class="cl">class UserModelSerializer(serializers.ModelSerializer):
</span></span><span class="line"><span class="cl">    username = serializers.CharField()  # username为unique字段，需要重定义
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    class Meta:
</span></span><span class="line"><span class="cl">        model = models.User
</span></span><span class="line"><span class="cl">        fields = (&#39;username&#39;, &#39;password&#39;, &#39;id&#39;)
</span></span><span class="line"><span class="cl">        extra_kwargs = {
</span></span><span class="line"><span class="cl">            &#39;id&#39;: {&#39;read_only&#39;: True},
</span></span><span class="line"><span class="cl">            &#39;password&#39;: {&#39;write_only&#39;: True}
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 全局钩子，判断多方式登录
</span></span><span class="line"><span class="cl">    def validate(self, attrs):
</span></span><span class="line"><span class="cl">        # _get_user去获取用户对象
</span></span><span class="line"><span class="cl">        user = self._get_user(attrs)
</span></span><span class="line"><span class="cl">        # 去获取签发的token
</span></span><span class="line"><span class="cl">        token = self._get_token(user)
</span></span><span class="line"><span class="cl">        self.context[&#39;token&#39;] = token
</span></span><span class="line"><span class="cl">        self.context[&#39;user&#39;] = user
</span></span><span class="line"><span class="cl">        return attrs
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 获取用户名
</span></span><span class="line"><span class="cl">    def _get_user(self, attrs):
</span></span><span class="line"><span class="cl">        username = attrs.get(&#39;username&#39;)
</span></span><span class="line"><span class="cl">        password = attrs.get(&#39;password&#39;)
</span></span><span class="line"><span class="cl">        import re
</span></span><span class="line"><span class="cl">        # 判断用户名类型
</span></span><span class="line"><span class="cl">        if re.match(&#39;^1[3-9][0-9]{9}$&#39;, username):  # 匹配usernmae是不是手机号类型
</span></span><span class="line"><span class="cl">            user = models.User.objects.filter(telephone=username).first()
</span></span><span class="line"><span class="cl">        elif re.match(&#39;^.*@.*$&#39;, username):
</span></span><span class="line"><span class="cl">            user = models.User.objects.filter(email=username).first()
</span></span><span class="line"><span class="cl">        else:
</span></span><span class="line"><span class="cl">            user = models.User.objects.filter(username=username).first()
</span></span><span class="line"><span class="cl">        if user:
</span></span><span class="line"><span class="cl">            ret = user.check_password(password)
</span></span><span class="line"><span class="cl">            if ret:
</span></span><span class="line"><span class="cl">                return user
</span></span><span class="line"><span class="cl">            else:
</span></span><span class="line"><span class="cl">                raise ValidationError(&#39;密码错误&#39;)
</span></span><span class="line"><span class="cl">        else:
</span></span><span class="line"><span class="cl">            raise ValidationError(&#39;用户不存在&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 获取token
</span></span><span class="line"><span class="cl">    def _get_token(self, user):
</span></span><span class="line"><span class="cl">        from rest_framework_jwt.serializers import jwt_payload_handler, jwt_encode_handler
</span></span><span class="line"><span class="cl">        payload = jwt_payload_handler(user)  # 加入user得到payload
</span></span><span class="line"><span class="cl">        token = jwt_encode_handler(payload)  # 加入patload得到token
</span></span><span class="line"><span class="cl">        return token
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="urlspy-2">urls.py</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from django.contrib import admin
</span></span><span class="line"><span class="cl">from django.urls import path,re_path
</span></span><span class="line"><span class="cl">from web import views
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from rest_framework_jwt.views import obtain_jwt_token
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">urlpatterns = [
</span></span><span class="line"><span class="cl">    path(&#39;admin/&#39;, admin.site.urls),
</span></span><span class="line"><span class="cl">    re_path(r&#39;^index/$&#39;, views.index),
</span></span><span class="line"><span class="cl">    re_path(r&#39;^property/$&#39;, views.AssetsRecord),
</span></span><span class="line"><span class="cl">    re_path(r&#39;^create/server/&#39;, views.create_server),
</span></span><span class="line"><span class="cl">    re_path(r&#39;^server_detail/&#39;, views.server_detail),
</span></span><span class="line"><span class="cl">    # re_path(r&#39;^server_detail/&#39;, views.server_detail.as_view()),
</span></span><span class="line"><span class="cl">    path(&#39;login/&#39;, views.LoginViewSet.as_view({&#39;post&#39;:&#39;login&#39;,&#39;get&#39;:&#39;login_index&#39;})),
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">]
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="viewspy-1">views.py</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import uuid
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from django import forms
</span></span><span class="line"><span class="cl">from django.utils.decorators import method_decorator
</span></span><span class="line"><span class="cl">from django.shortcuts import render, redirect, HttpResponse
</span></span><span class="line"><span class="cl">from rest_framework.views import APIView
</span></span><span class="line"><span class="cl">from rest_framework.generics import GenericAPIView
</span></span><span class="line"><span class="cl">from rest_framework.response import Response
</span></span><span class="line"><span class="cl">from rest_framework.viewsets import ModelViewSet
</span></span><span class="line"><span class="cl">from rest_framework.decorators import action
</span></span><span class="line"><span class="cl">from rest_framework.viewsets import ViewSetMixin, ViewSet
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from api import models
</span></span><span class="line"><span class="cl">from api.models import Server
</span></span><span class="line"><span class="cl">from web import serializer
</span></span><span class="line"><span class="cl">from web.utils.response import APIResponse
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 检验用户是否登录的装饰器
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">用户如果在没有登录的情况下想访问一个需要登录的页面
</span></span><span class="line"><span class="cl">那么先跳转到登录页面 当用户输入正确的用户名和密码之后
</span></span><span class="line"><span class="cl">应该跳转到用户之前想要访问的页面
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def login_auth(func):
</span></span><span class="line"><span class="cl">    def inner(request, *args, **kwargs):
</span></span><span class="line"><span class="cl">        print(request.path_info)
</span></span><span class="line"><span class="cl">        print(request.get_full_path())  # 获取到用户上一次像访问的url
</span></span><span class="line"><span class="cl">        target_url = request.get_full_path()
</span></span><span class="line"><span class="cl">        if request.COOKIES.get(&#39;token&#39;):
</span></span><span class="line"><span class="cl">            if request.COOKIES.get(&#39;token&#39;) == request.session.get(&#39;token&#39;):
</span></span><span class="line"><span class="cl">                return func(request, *args, **kwargs)
</span></span><span class="line"><span class="cl">        else:
</span></span><span class="line"><span class="cl">            return redirect(&#39;/web/login/?next=%s&#39;%target_url)
</span></span><span class="line"><span class="cl">    return inner
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@login_auth
</span></span><span class="line"><span class="cl">def index(request):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    后台管理首页
</span></span><span class="line"><span class="cl">    :param request:
</span></span><span class="line"><span class="cl">    :return:
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    server_lsit = models.Server.objects.all()
</span></span><span class="line"><span class="cl">    # django中优先去最外层的templates中找，如果找不着会更具每个app的注册顺序去app中找
</span></span><span class="line"><span class="cl">    return render(request, &#39;index.html&#39;, {&#39;server_lsit&#39;: server_lsit})
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@login_auth
</span></span><span class="line"><span class="cl">def AssetsRecord(request):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    资产变更展示
</span></span><span class="line"><span class="cl">    :param request:
</span></span><span class="line"><span class="cl">    :return:
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    assetsrecord_list = models.AssetsRecord.objects.all()
</span></span><span class="line"><span class="cl">    # django中优先去最外层的templates中找，如果找不着会更具每个app的注册顺序去app中找
</span></span><span class="line"><span class="cl">    return render(request, &#39;AssetsRecord.html&#39;, {&#39;assetsrecord_list&#39;: assetsrecord_list})
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@login_auth
</span></span><span class="line"><span class="cl">def server_detail(request):
</span></span><span class="line"><span class="cl">    network_list = models.Nic.objects.all()
</span></span><span class="line"><span class="cl">    memory_list = models.Memory.objects.all()
</span></span><span class="line"><span class="cl">    disk_list = models.Disk.objects.all()
</span></span><span class="line"><span class="cl">    return render(request, &#39;server_detail.html&#39;, {&#39;network_list&#39;:network_list,&#39;memory_list&#39;:memory_list,&#39;disk_list&#39;:disk_list })
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class ServerModelForm(forms.ModelForm):
</span></span><span class="line"><span class="cl">    class Meta:
</span></span><span class="line"><span class="cl">        model = models.Server
</span></span><span class="line"><span class="cl">        fields = [&#39;hostname&#39;, &#39;business_unit&#39;, &#39;idc&#39;, &#39;cabinet_num&#39;, &#39;cabinet_order&#39;, &#39;status&#39;]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __init__(self, *args, **kwargs):
</span></span><span class="line"><span class="cl">        super().__init__(*args, **kwargs)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        for field in self.fields:
</span></span><span class="line"><span class="cl">            self.fields[field].widget.attrs[&#39;class&#39;] = &#39;form-control&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@login_auth
</span></span><span class="line"><span class="cl">def create_server(reqeust):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    增加服务器
</span></span><span class="line"><span class="cl">    :param reqeust:
</span></span><span class="line"><span class="cl">    :return:
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if reqeust.method == &#34;GET&#34;:
</span></span><span class="line"><span class="cl">        form = ServerModelForm()
</span></span><span class="line"><span class="cl">        return render(reqeust, &#39;create_server.html&#39;, {&#39;form&#39;: form})
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    form = ServerModelForm(data=reqeust.POST)
</span></span><span class="line"><span class="cl">    if form.is_valid():
</span></span><span class="line"><span class="cl">        form.save()
</span></span><span class="line"><span class="cl">        return redirect(&#39;/web/index/&#39;)
</span></span><span class="line"><span class="cl">    return render(reqeust, &#39;create_server.html&#39;, {&#39;form&#39;: form})
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># @method_decorator(login_auth,name=&#39;get&#39;)
</span></span><span class="line"><span class="cl"># class server_detail(GenericAPIView):
</span></span><span class="line"><span class="cl">#     &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">#     服务器详情接口
</span></span><span class="line"><span class="cl">#     :param reqeust:
</span></span><span class="line"><span class="cl">#     :return:
</span></span><span class="line"><span class="cl">#     &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">#     queryset = models.Server.objects
</span></span><span class="line"><span class="cl">#     serializer_class = serializer.ServerSerializer
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl">#     # 查询所有
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl">#     def get(self, request):
</span></span><span class="line"><span class="cl">#         response_msg = {&#39;status&#39;: 100, &#39;msg&#39;: &#39;成功&#39;}
</span></span><span class="line"><span class="cl">#         servers = models.Server.objects.all()
</span></span><span class="line"><span class="cl">#         servers_ser = serializer.ServerSerializer(servers, many=True)  # 序列化多条要加many=True,序列化一条则不用
</span></span><span class="line"><span class="cl">#         response_msg[&#39;data&#39;] = servers_ser.data
</span></span><span class="line"><span class="cl">#         return Response(response_msg)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class LoginViewSet(ViewSet):
</span></span><span class="line"><span class="cl">    @action(methods=[&#39;GET&#39;], detail=False)
</span></span><span class="line"><span class="cl">    def login_index(self, reqeust):
</span></span><span class="line"><span class="cl">        return render(reqeust, &#39;login.html&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    @action(methods=[&#39;POST&#39;], detail=False)
</span></span><span class="line"><span class="cl">    def login(self, request, *args, **kwargs):
</span></span><span class="line"><span class="cl">        user_ser = serializer.UserModelSerializer(data=request.data)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if user_ser.is_valid():  # 自定义了全局异常，不需要使用raise_exception=True
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            # 保存用户状态
</span></span><span class="line"><span class="cl">            # 获取用户上一次想要访问的url
</span></span><span class="line"><span class="cl">            target_url = request.GET.get(&#39;next&#39;)
</span></span><span class="line"><span class="cl">            if target_url:
</span></span><span class="line"><span class="cl">                obj = redirect(target_url)
</span></span><span class="line"><span class="cl">            else:
</span></span><span class="line"><span class="cl">                obj = redirect(&#39;http://127.0.0.1:8000/web/index/&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            # 从序列化对象user_ser.context中获取token和用户名
</span></span><span class="line"><span class="cl">            token = user_ser.context[&#39;token&#39;]
</span></span><span class="line"><span class="cl">            username = user_ser.context[&#39;user&#39;].username
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            # 让浏览器记录cookie数据
</span></span><span class="line"><span class="cl">            request.session[&#39;token&#39;] = token
</span></span><span class="line"><span class="cl">            obj.set_cookie(&#39;token&#39;, token)
</span></span><span class="line"><span class="cl">            # return APIResponse(token=token, username=username)
</span></span><span class="line"><span class="cl">            return obj
</span></span><span class="line"><span class="cl">        else:
</span></span><span class="line"><span class="cl">            return APIResponse(code=0, msg=user_ser.errors)  # 序列化校检失败，返回错误信息
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="requirementstxt-2">requirements.txt</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">asgiref==3.5.0
</span></span><span class="line"><span class="cl">bcrypt==3.2.0
</span></span><span class="line"><span class="cl">certifi==2021.10.8
</span></span><span class="line"><span class="cl">cffi==1.15.0
</span></span><span class="line"><span class="cl">charset-normalizer==2.0.12
</span></span><span class="line"><span class="cl">cryptography==36.0.2
</span></span><span class="line"><span class="cl">demjson3==3.0.5
</span></span><span class="line"><span class="cl">Django==2.2.2
</span></span><span class="line"><span class="cl">djangorestframework==3.13.1
</span></span><span class="line"><span class="cl">djangorestframework-jwt==1.1.1
</span></span><span class="line"><span class="cl">idna==3.3
</span></span><span class="line"><span class="cl">paramiko==2.10.3
</span></span><span class="line"><span class="cl">pycparser==2.21
</span></span><span class="line"><span class="cl">PyJWT==0.3.2
</span></span><span class="line"><span class="cl">PyMySQL==1.0.2
</span></span><span class="line"><span class="cl">PyNaCl==1.5.0
</span></span><span class="line"><span class="cl">pytz==2022.1
</span></span><span class="line"><span class="cl">requests==2.27.1
</span></span><span class="line"><span class="cl">six==1.16.0
</span></span><span class="line"><span class="cl">sqlparse==0.4.2
</span></span><span class="line"><span class="cl">tzdata==2022.1
</span></span><span class="line"><span class="cl">urllib3==1.26.9
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">khw</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2022-04-13
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/python/">python</a>
          <a href="/tags/cmdb/">cmdb</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/pythonday14%E5%9F%BA%E7%A1%80%E5%A4%8D%E4%B9%A0/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">python,day14,复习</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/pythonday12%E8%B7%AF%E9%A3%9E%E9%A1%B9%E7%9B%AE/">
            <span class="next-text nav-default">python,day12,路飞项目</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://gitee.com/khwcloud" class="iconfont icon-github" title="github"></a>
  <a href="http://localhost:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2022
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">khw</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.9e3db4166f5901c11faec00349b7b03ae36c12a6e820a208cf498f1aee812258.js"></script>








</body>
</html>
